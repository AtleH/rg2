// Version 0.4.1 2014-01-26T16:05:57;
function Animation(){"use strict";this.runners=[],this.timer=null,this.animationSecs=0,this.deltaSecs=5,this.timerInterval=100,this.colours=new Colours,this.realTime=!1,this.earliestStartSecs=0,this.latestFinishSecs=0,this.tailLength=0,this.useFullTails=!1,this.massStartControl=0,this.massStartByControl=!1,this.displayNames=!0}function Controls(){this.controls=[],this.displayControls=!1}function Control(a,b,c){this.code=a,this.x=b,this.y=c}function Courses(){this.courses=[],this.totaltracks=0,this.numberofcourses=0,this.highestControlNumber=0}function Course(a,b){this.name=a.name,this.trackcount=0,this.display=!1,this.courseid=a.courseid,this.codes=a.codes,this.x=a.xpos,this.y=a.ypos,this.isScoreCourse=b}function Draw(){this.trackColor="#ff0000",this.HANDLE_DOT_RADIUS=10,this.CLOSE_ENOUGH=10,this.gpstrack=new GPSTrack,this.hasResults=!1,this.initialiseDrawing()}function RouteData(){this.courseid=null,this.coursename=null,this.resultid=null,this.eventid=null,this.name=null,this.comments=null,this.x=[],this.y=[],this.controlx=[],this.controly=[],this.time=[],this.startsecs=0,this.totaltime=0}function Events(){this.events=[],this.activeEventID=null}function Event(a){switch(this.kartatid=parseInt(a.id,10),this.mapid=a.mapid,this.format=parseInt(a.format,10),this.name=a.name,this.date=a.date,this.club=a.club,this.worldFile=[],"undefined"==typeof a.A?this.georeferenced=!1:(this.georeferenced=!0,this.worldFile.A=a.A,this.worldFile.B=a.B,this.worldFile.C=a.C,this.worldFile.D=a.D,this.worldFile.E=a.E,this.worldFile.F=a.F),a.type){case"I":this.type="International";break;case"N":this.type="National";break;case"R":this.type="Regional";break;case"L":this.type="Local";break;case"T":this.type="Training";break;default:this.type="Unknown"}this.comment=a.comment,this.courses=0}function GPSTrack(){this.lat=[],this.lon=[],this.time=[],this.baseX=[],this.baseY=[],this.fileLoaded=!1,this.routeData=new RouteData}function User(){this.name=null,this.pwd=null}function Manager(){this.loggedIn=!1,this.user=new User,this.eventName=null,this.mapName=null,this.eventDate=null,this.eventLevel=null,this.club=null,this.comments=null,this.newcontrols=new Controls,this.xmlcourses=[],this.mapLoaded=!1,this.results=[],this.resultCourses=[],this.allocationsDisplayed=!1,this.mapWidth=0,this.mapHeight=0,this.backgroundLocked=!1,this.handleX=null,this.handleY=null,this.HANDLE_DOT_RADIUS=10,this.handleColor="#ff0000";var a=this;$("#rg2-manager-login").submit(function(){if(a.user.name=$("#rg2-user-name").val(),a.user.pwd=$("#rg2-password").val(),a.user.name&&a.user.pwd)a.logIn();else{var b="<div>Please enter user name and password.</div>";$(b).dialog({title:"Login failed"})}return!1}),$("#rg2-new-event-details-form").submit(function(){console.log("Form submitted")})}function Colours(){this.colours=["#ff0000","#00ff00","#0000ff","#ffff00","#ff00ff","#00ffff"],this.colourIndex=0}function getLatLonDistance(a,b,c,d){var e=c-a,f=e.toRad(),g=d-b,h=g.toRad(),i=Math.sin(f/2)*Math.sin(f/2)+Math.cos(a.toRad())*Math.cos(c.toRad())*Math.sin(h/2)*Math.sin(h/2),j=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i));return 6371009*j}function getAngle(a,b,c,d){var e=Math.atan2(d-b,c-a);return 0>e&&(e+=2*Math.PI),e}function formatSecsAsMMSS(a){var b,c=Math.floor(a/60);b=c;var d=a-60*c;return b+=10>d?":0"+d:":"+d}function getSecsFromMMSS(a){var b=0,c=a.split(":");return b=60*parseInt(c[0],10)+parseInt(c[1],10),isNaN(b)?0:b}function trackTransforms(a){var b=document.createElementNS("http://www.w3.org/2000/svg","svg"),c=b.createSVGMatrix();a.getTransform=function(){return c};var d=[],e=a.save;a.save=function(){return d.push(c.translate(0,0)),e.call(a)};var f=a.restore;a.restore=function(){return c=d.pop(),f.call(a)};var g=a.scale;a.scale=function(b,d){return c=c.scaleNonUniform(b,d),g.call(a,b,d)};var h=a.rotate;a.rotate=function(b){return c=c.rotate(180*b/Math.PI),h.call(a,b)};var i=a.translate;a.translate=function(b,d){return c=c.translate(b,d),i.call(a,b,d)};var j=a.transform;a.transform=function(d,e,f,g,h,i){var k=b.createSVGMatrix();return k.a=d,k.b=e,k.c=f,k.d=g,k.e=h,k.f=i,c=c.multiply(k),j.call(a,d,e,f,g,h,i)};var k=a.setTransform;a.setTransform=function(b,d,e,f,g,h){return c.a=b,c.b=d,c.c=e,c.d=f,c.e=g,c.f=h,k.call(a,b,d,e,f,g,h)};var l=b.createSVGPoint();a.transformedPoint=function(a,b){return l.x=a,l.y=b,l.matrixTransform(c.inverse())}}function Results(){this.results=[],this.colours=new Colours}function Result(a,b,c){this.resultid=parseInt(a.resultid,10),this.isScoreEvent=b,this.isGPSTrack=this.resultid>=rg2.config.GPS_RESULT_OFFSET?!0:!1,this.name=a.name,this.starttime=Math.round(a.starttime),this.time=a.time,this.comments=null!==a.comments?a.comments.replace("'","&apos;"):"",this.coursename=a.coursename,""===this.coursename&&(this.coursename=a.courseid),this.courseid=parseInt(a.courseid,10),this.splits=a.splits.split(";");for(var d=0;d<this.splits.length;d+=1)this.splits[d]=Math.round(this.splits[d]);this.splits.splice(0,0,0),""!==a.scoreref&&(this.scorex=a.scorex,this.scorey=a.scorey),this.cumulativeDistance=[],this.hasValidTrack=!1,this.displayTrack=!1,this.trackColour=c,this.trackx=[],this.tracky=[],this.xysecs=[],this.isGPSTrack&&(this.time=rg2.getTimeForID(this.resultid-rg2.config.GPS_RESULT_OFFSET),this.time===rg2.config.TIME_NOT_FOUND&&(this.time=a.time),this.splits=rg2.getSplitsForID(this.resultid-rg2.config.GPS_RESULT_OFFSET)),a.gpscoords.length>0&&this.addTrack(a.gpscoords)&&rg2.incrementTracksCount(this.courseid)}function Runner(a,b){var c=rg2.getFullResult(a);this.name=c.name,this.runnerid=a,this.starttime=c.starttime,this.splits=c.splits,this.colour=b;var d=rg2.getCourseDetails(c.courseid);this.coursename=d.name,this.nextStopTime=rg2.config.VERY_HIGH_TIME_IN_SECS,this.x=[],this.y=[],this.legTrackDistance=[],this.cumulativeTrackDistance=[];var e=[];this.x[0]=d.x[0],this.y[0]=d.y[0];var f,g,h,i,j,k,l,m,n,o,p,q=0,r=0,s=0,t=0,u=d.x[0],v=d.y[0];if(c.hasValidTrack)for(this.x[0]=c.trackx[0],this.y[0]=c.tracky[0],e[0]=0,u=c.trackx[0],v=c.tracky[0],h=0,p=0,o=1;o<c.xysecs.length;o+=1){for(f=c.trackx[o],g=c.tracky[o],i=f-u,j=g-v,p+=Math.sqrt((f-u)*(f-u)+(g-v)*(g-v)),l=p-h,s=c.xysecs[o],k=s-t,n=t+1;s>n;n+=1)this.x[n]=Math.round(u+(n-t)*i/k),this.y[n]=Math.round(v+(n-t)*j/k),e[n]=Math.round(h+(n-t)*l/k);this.x[s]=f,this.y[s]=g,e[s]=p,u=f,v=g,h=p,t=s}else for(this.x[0]=d.x[0],this.y[0]=d.y[0],e[0]=0,u=d.x[0],v=d.y[0],h=0,p=0,m=1;m<d.codes.length;m+=1){for(f=d.x[m],g=d.y[m],i=f-u,j=g-v,p+=Math.sqrt((f-u)*(f-u)+(g-v)*(g-v)),l=p-h,r=c.splits[m],k=r-q,n=q+1;r>n;n+=1)this.x[n]=Math.round(u+(n-q)*i/k),this.y[n]=Math.round(v+(n-q)*j/k),e[n]=Math.round(h+(n-t)*l/k);this.x[r]=f,this.y[r]=g,e[r]=p,u=f,v=g,h=p,q=r}if(this.legTrackDistance[0]=0,this.cumulativeTrackDistance[0]=0,void 0!==d.codes)for(m=1;m<d.codes.length;m+=1)this.cumulativeTrackDistance[m]=Math.round(e[c.splits[m]]),this.legTrackDistance[m]=this.cumulativeTrackDistance[m]-this.cumulativeTrackDistance[m-1];c=0,d=0}var rg2=function(){"use strict";function a(){ib=$("#rg2-info-panel"),jb=$("#rg2-event-title"),hb=0!==$("#rg2-manage").length?!0:!1,fb=window.location.hash,fb&&!hb&&(gb=parseInt(fb.replace("#",""),10)),$("#btn-save-route").button().button("disable"),$("#btn-save-gps-route").button().button("disable"),$("#btn-reset-drawing").button().button("disable"),$("#btn-undo").button().button("disable"),$("#rg2-load-gps-file").button().button("disable"),$("#btn-three-seconds").button().button("disable"),ib.tabs({disabled:[mb.TAB_COURSES,mb.TAB_RESULTS,mb.TAB_DRAW],active:mb.TAB_EVENTS,heightStyle:"content",activate:function(){d()}}),$("#rg2-result-list").accordion({collapsible:!0,heightStyle:"content",select:function(a,b){console.log("Result index selected: "+b.item[0].id)}}),$("#rg2-clock").text("00:00:00"),$("#rg2-clock-slider").slider({slide:function(a,b){V.clockSliderMoved(b.value)}}),$("#btn-mass-start").addClass("active"),$("#btn-real-time").removeClass("active"),P=new Image,Q="Select an event",R=new Events,S=new Courses,T=new Results,U=new Controls,V=new Animation,X=new Draw,db=null,eb=!0,Y=!0,Z=$("#rg2-resize-info-icon").attr("src"),_=Z.replace("hide-info","show-info"),$("#rg2-header-container").css("color",header_text_colour),$("#rg2-header-container").css("background",header_colour),$("#rg2-about-dialog").hide(),$("#rg2-splits-display").hide(),$("#rg2-track-names").hide(),$("#rg2-add-new-event").hide(),$("#btn-about").click(function(){f()}),$("#rg2-resize-info").click(function(){g()}),$("#btn-mass-start").click(function(){V.setReplayType(mb.MASS_START_REPLAY)}),$("#btn-real-time").click(function(){V.setReplayType(mb.REAL_TIME_REPLAY)}),$("#rg2-control-select").prop("disabled",!0).click(function(){V.setStartControl($("#rg2-control-select").val())}),$("#rg2-name-select").prop("disabled",!0).click(function(){X.setName(parseInt($("#rg2-name-select").val(),10))}),$("#rg2-course-select").click(function(){X.setCourse(parseInt($("#rg2-course-select").val(),10))}),$("#rg2-enter-name").click(function(){X.setNameAndTime()}).keyup(function(){X.setNameAndTime()}),$("#rg2-new-comments").focus(function(){var a=$("#rg2-new-comments").val();a===mb.DEFAULT_NEW_COMMENT&&$("#rg2-new-comments").val("")}),$("#btn-save-route").button().click(function(){X.saveRoute()}),$("#btn-save-gps-route").button().click(function(){X.saveGPSRoute()}),$("#btn-move-all").click(function(a){X.toggleMoveAll(a.target.checked)}),$("#btn-move-all").prop("checked",!1),$("#btn-undo").click(function(){X.undoLastPoint()}),$("#btn-reset-drawing").click(function(){X.resetDrawing()}),$("#btn-three-seconds").click(function(){X.waitThreeSeconds()}),$("#rg2-load-gps-file").change(function(a){X.uploadGPS(a)}),$("#btn-zoom-in").click(function(){nb(1)}),$("#btn-reset").click(function(){b()}),$("#btn-zoom-out").click(function(){nb(-1)}),$("#btn-start-stop").click(function(){V.toggleAnimation()}),$("#btn-faster").click(function(){V.goFaster()}),$("#btn-slower").click(function(){V.goSlower()}),$("#btn-toggle-names").click(function(){V.toggleNameDisplay(),e(!1)}).hide(),$("#btn-show-splits").click(function(){$("#rg2-splits-table").empty().append(V.getSplitsTable()).dialog({width:"auto",buttons:{Ok:function(){$(this).dialog("close")}}})}),$("#btn-show-splits").hide(),$("#btn-toggle-controls").click(function(){U.toggleControlDisplay(),e(!1)}).hide(),$("#spn-tail-length").spinner({max:600,min:0,spin:function(a,b){V.setTailLength(b.value)}}).val(0),$("#btn-full-tails").prop("checked",!1).click(function(a){a.target.checked?(V.setFullTails(!0),$("#spn-tail-length").spinner("disable")):(V.setFullTails(!1),$("#spn-tail-length").spinner("enable"))}),hb&&(W=new Manager,$("#rg2-animation-controls").hide(),$("#rg2-manager-options").hide(),ib.tabs("disable",mb.TAB_EVENTS),$("#rg2-draw-tab").hide(),$("#rg2-results-tab").hide(),$("#rg2-courses-tab").hide(),$("#rg2-events-tab").hide(),ib.tabs("option","active",mb.TAB_MANAGE)),trackTransforms(lb),c(),window.addEventListener("resize",c,!1),kb.addEventListener("DOMMouseScroll",ob,!1),kb.addEventListener("mousewheel",ob,!1),kb.addEventListener("mousedown",pb,!1),kb.addEventListener("mousemove",qb,!1),kb.addEventListener("mouseup",rb,!1),P.addEventListener("load",function(){b()},!1),$.getJSON(json_url,{type:"events",cache:!1}).done(function(a){console.log("Events: "+a.data.length),$.each(a.data,function(){R.addEvent(new Event(this))}),h()}).fail(function(a,b,c){var d=b+", "+c;console.log("Events request failed: "+d)})}function b(){var a,b=kb.height/P.height;bb=kb.width/2,cb=kb.height/2,db=null,eb=!0,a=1>b?b:1,Y||window.innerWidth>=mb.BIG_SCREEN_BREAK_POINT?lb.setTransform(a,0,0,a,ib.outerWidth(),0):lb.setTransform(a,0,0,a,0,0),lb.save(),e(!1)}function c(){ab=mb.DEFAULT_SCALE_FACTOR;var a=window.innerWidth,c=window.innerHeight;$("#rg2-container").css("height",c-36),kb.width=a,kb.height=c-36,window.innerWidth>=mb.BIG_SCREEN_BREAK_POINT?jb.text(R.getActiveEventName()+" "+R.getActiveEventDate()).show():window.innerWidth>mb.SMALL_SCREEN_BREAK_POINT?jb.text(R.getActiveEventName()).show():jb.hide(),b()}function d(){var a=ib.tabs("option","active");switch(a){case mb.TAB_DRAW:S.removeAllFromDisplay(),X.showCourseInProgress()}e(!1)}function e(a){if(lb.save(),lb.setTransform(1,0,0,1,0,0),lb.clearRect(0,0,lb.canvas.width,lb.canvas.height),lb.restore(),lb.globalAlpha=1,P.height>0){lb.drawImage(P,0,0);var b=ib.tabs("option","active");b===mb.TAB_DRAW?(S.drawCourses(mb.DIM),U.drawControls(),X.drawNewTrack()):b===mb.TAB_MANAGE?W.drawControls():(S.drawCourses(mb.FULL_INTENSITY),T.drawTracks(),U.drawControls(),a?V.runAnimation(!0):V.runAnimation(!1))}else lb.font="30pt Arial",lb.textAlign="center",lb.fillStyle="black",lb.fillText(Q,kb.width/2,kb.height/2)}function f(){$("#rg2-version-info").empty().append("Version information: "+mb.RG2VERSION),$("#rg2-about-dialog").dialog({minWidth:400,buttons:{Ok:function(){$(this).dialog("close")}}})}function g(){Y?(Y=!1,$("#rg2-resize-info-icon").attr("src",_),$("#rg2-resize-info").prop("title","Show info panel"),ib.hide()):(Y=!0,$("#rg2-resize-info-icon").attr("src",Z),$("#rg2-resize-info").prop("title","Hide info panel"),ib.show()),b()}function h(){var a=R.formatEventsAsMenu();$("#rg2-event-list").append(a).menu({select:function(a,b){i(b.item[0].id)}}),gb&&R.isValidEventID(gb)&&i(gb)}function i(a){$("body").css("cursor","wait"),S.deleteAllCourses(),U.deleteAllControls(),V.resetAnimation(),T.deleteAllResults(),R.setActiveEventID(a),X.initialiseDrawing(R.hasResults(a)),j(maps_url+"/"+R.getActiveMapID()+".jpg"),e(!1),window.innerWidth>=mb.BIG_SCREEN_BREAK_POINT?jb.text(R.getActiveEventName()+" "+R.getActiveEventDate()).show():window.innerWidth>mb.SMALL_SCREEN_BREAK_POINT?jb.text(R.getActiveEventName()).show():jb.hide(),$.getJSON(json_url,{id:R.getKartatEventID(),type:"courses",cache:!1}).done(function(a){console.log("Courses: "+a.data.length),$.each(a.data,function(){S.addCourse(new Course(this,R.isScoreEvent()))}),S.updateCourseDropdown(),S.generateControlList(U),$("#btn-toggle-controls").show(),$("#btn-toggle-names").show(),k()}).fail(function(a,b,c){$("body").css("cursor","auto");var d=b+", "+c;console.log("Courses request failed: "+d)})}function j(a){Q="Map loading...",P.src=a}function k(){$.getJSON(json_url,{id:R.getKartatEventID(),type:"results",cache:!1}).done(function(a){console.log("Results: "+a.data.length);var b=R.isScoreEvent();T.addResults(a.data,b),$("#rg2-result-list").accordion("refresh"),l()}).fail(function(a,b,c){$("body").css("cursor","auto");var d=b+", "+c;console.log("Results request failed: "+d)})}function l(){$.getJSON(json_url,{id:R.getKartatEventID(),type:"tracks",cache:!1}).done(function(a){console.log("Tracks: "+a.data.length),T.addTracks(a.data),m(),n(),V.updateAnimationDetails(),$("body").css("cursor","auto"),ib.tabs("enable",mb.TAB_COURSES),ib.tabs("enable",mb.TAB_RESULTS),ib.tabs("enable",mb.TAB_DRAW);var b=ib.tabs("option","active");b!==mb.TAB_DRAW&&ib.tabs("option","active",mb.TAB_COURSES),ib.tabs("refresh"),$("#btn-show-splits").show(),e(!1)}).fail(function(a,b,c){$("body").css("cursor","auto");var d=b+", "+c;console.log("Tracks request failed: "+d)})}function m(){$("#rg2-course-table").empty().append(S.formatCoursesAsTable()),$(".courselist").click(function(a){a.target.checked?S.putOnDisplay(parseInt(a.currentTarget.id,10)):(S.removeFromDisplay(parseInt(a.currentTarget.id,10)),$(".allcourses").prop("checked",!1)),e(!1)}),$(".allcourses").click(function(a){a.target.checked?(S.putAllOnDisplay(),$(".courselist").prop("checked",!0)):(S.removeAllFromDisplay(),$(".courselist").prop("checked",!1)),e(!1)}),$(".tracklist").click(function(a){var b=a.target.id;a.target.checked?T.putTracksOnDisplay(b):(T.removeTracksFromDisplay(b),$(".alltracks").prop("checked",!1)),e(!1)}),$(".alltracks").click(function(a){a.target.checked?(T.putAllTracksOnDisplay(),$(".tracklist").prop("checked",!0)):(T.removeAllTracksFromDisplay(),$(".tracklist").prop("checked",!1)),e(!1)})}function n(){var a=T.formatResultListAsAccordion();$(".courselist").unbind("click").click(function(a){a.target.checked?S.putOnDisplay(parseInt(a.currentTarget.id,10)):(S.removeFromDisplay(parseInt(a.currentTarget.id,10)),$(".allcourses").prop("checked",!1)),e()}),$("#rg2-result-list").empty().append(a),$("#rg2-result-list").accordion("refresh"),ib.tabs("refresh"),$(".showcourse").click(function(a){a.stopPropagation(),a.target.checked?S.putOnDisplay(a.target.id):S.removeFromDisplay(a.target.id),e(!1)}),$(".showtrack").click(function(a){a.target.checked?T.putOneTrackOnDisplay(a.target.id):T.removeOneTrackFromDisplay(a.target.id),e(!1)}),$(".replay").click(function(a){a.target.checked?V.addRunner(new Runner(a.target.id,V.colours.getNextColour())):V.removeRunner(a.target.id),e(!1)}),0===S.getHighestControlNumber()?$("#rg2-control-select").prop("disabled",!0):$("#rg2-control-select").prop("disabled",!1)}function o(a){return S.getFullCourse(a)}function p(a){return S.getCourseName(a)}function q(a){return T.getResultsByCourseID(a)}function r(){return T.getTotalResults()}function s(a,b,c,d){return U.drawStart(a,b,c,d)}function t(a,b,c){return U.drawSingleControl(a,b,c)}function u(a,b,c){return U.drawFinish(a,b,c)}function v(a){return T.getFullResult(a)}function w(){return S.getHighestControlNumber()}function x(a){return R.getKartatEventID(a)}function y(){return R.hasResults()}function z(a){return S.incrementTracksCount(a)}function A(a){S.putOnDisplay(a)}function B(a){S.removeFromDisplay(a)}function C(a){T.createNameDropdown(a)}function D(a){return T.getRunnerName(a)}function E(a){return T.resultIDExists(a)}function F(a){return T.getKartatResultID(a)}function G(a){return T.getTimeForID(a)}function H(a){return T.getSplitsForID(a)}function I(){return R.mapIsGeoreferenced()}function J(){var a={};return a.height=P.height,a.width=P.width,a}function K(){return R.getWorldFile()}function L(){return X.getControlX()}function M(){return X.getControlY()}function N(){return R.getActiveEventID()}function O(){R.createEventEditDropdown()}var P,Q,R,S,T,U,V,W,X,Y,Z,_,ab,bb,cb,db,eb,fb,gb,hb,ib,jb,kb=$("#rg2-map-canvas")[0],lb=kb.getContext("2d"),mb={DEFAULT_SCALE_FACTOR:1.1,TAB_EVENTS:0,TAB_COURSES:1,TAB_RESULTS:2,TAB_DRAW:3,TAB_MANAGE:4,DEFAULT_NEW_COMMENT:"Type your comment",DEFAULT_EVENT_COMMENT:"Comments (optional)",GPS_RESULT_OFFSET:5e4,MASS_START_REPLAY:1,REAL_TIME_REPLAY:2,MASS_START_BY_CONTROL:99999,VERY_HIGH_TIME_IN_SECS:99999,BIG_SCREEN_BREAK_POINT:800,SMALL_SCREEN_BREAK_POINT:500,PURPLE:"#b300ff",CONTROL_CIRCLE_RADIUS:20,FINISH_INNER_RADIUS:16.4,FINISH_OUTER_RADIUS:23.4,RUNNER_DOT_RADIUS:6,START_TRIANGLE_LENGTH:30,OVERPRINT_LINE_THICKNESS:2,REPLAY_LINE_THICKNESS:3,START_TRIANGLE_HEIGHT:40,DIM:.5,FULL_INTENSITY:1,NORMAL_EVENT:1,EVENT_WITHOUT_RESULTS:2,SCORE_EVENT:3,RG2VERSION:"0.4.1",TIME_NOT_FOUND:9999,SPLITS_NOT_FOUND:9999},nb=function(a){var b=Math.pow(ab,a),c=lb.transformedPoint(bb,cb);lb.translate(c.x,c.y),lb.scale(b,b),lb.translate(-c.x,-c.y),lb.save(),e(!1)},ob=function(a){var b=a.wheelDelta?a.wheelDelta/40:a.detail?-a.detail:0;return b&&nb(b),a.preventDefault()&&!1},pb=function(a){bb=a.offsetX||a.layerX-kb.offsetLeft,cb=a.offsetY||a.layerY-kb.offsetTop,db=lb.transformedPoint(bb,cb),eb=!1},qb=function(a){if(bb=a.offsetX||a.layerX-kb.offsetLeft,cb=a.offsetY||a.layerY-kb.offsetTop,db){var b=lb.transformedPoint(bb,cb);(b.x!==db.x||b.y!==db.y)&&(X.gpsFileLoaded()?X.adjustTrack(parseInt(db.x,10),parseInt(db.y,10),parseInt(b.x,10),parseInt(b.y,10),a.shiftKey,a.ctrlKey):ib.tabs("option","active")===mb.TAB_MANAGE?W.adjustControls(parseInt(db.x,10),parseInt(db.y,10),parseInt(b.x,10),parseInt(b.y,10),a.shiftKey,a.ctrlKey):lb.translate(b.x-db.x,b.y-db.y),eb=!0,e(!1))}},rb=function(){var a=ib.tabs("option","active");eb?a===mb.TAB_MANAGE?W.dragEnded():X.dragEnded():a===mb.TAB_MANAGE?W.mouseUp(parseInt(db.x,10),parseInt(db.y,10)):X.mouseUp(parseInt(db.x,10),parseInt(db.y,10)),db=null,e(!1)};return{init:a,config:mb,redraw:e,ctx:lb,getMapSize:J,loadNewMap:j,loadEvent:i,eventHasResults:y,mapIsGeoreferenced:I,getWorldFile:K,getFullResult:v,drawStart:s,drawSingleControl:t,drawFinish:u,getTimeForID:G,getSplitsForID:H,resultIDExists:E,getRunnerName:D,putOnDisplay:A,removeFromDisplay:B,createNameDropdown:C,incrementTracksCount:z,getKartatEventID:x,getKartatResultID:F,getActiveEventID:N,getHighestControlNumber:w,getCourseDetails:o,getCourseName:p,getResultsByCourseID:q,getTotalResults:r,getControlX:L,getControlY:M,createEventEditDropdown:O}}();$(document).ready(rg2.init),Animation.prototype={Constructor:Animation,resetAnimation:function(){this.runners.length=0,clearInterval(this.timer),this.timer=null,this.updateAnimationDetails(),$("#btn-start-stop").removeClass("fa-pause").addClass("fa-play"),$("#btn-start-stop").prop("title","Run")},addRunner:function(a){this.runners.push(a),this.updateAnimationDetails()},updateAnimationDetails:function(){var a=this.getAnimationNames();""!==a?($("#rg2-track-names").empty(),$("#rg2-track-names").append(a),$("#rg2-track-names").show()):$("#rg2-track-names").hide(),this.calculateAnimationRange(),$("#rg2-clock").text(this.formatSecsAsHHMMSS(this.animationSecs))},clockSliderMoved:function(a){this.resetAnimationTime(a),rg2.redraw(!1)},getAnimationNames:function(){var a="";if(this.runners.length<1)return a;for(var b=0;b<this.runners.length;b+=1)a+="<p style='color:"+this.runners[b].colour+";'>"+this.runners[b].coursename+" "+this.runners[b].name+"</p>";return a},getSplitsTable:function(){var a,b,c,d;if(this.runners.length<1)return"<p>Select runners on Results tab.</p>";var e=0,f=[],g=0;for(b=0;b<this.runners.length;b+=1)this.runners[b].splits.length>e&&(e=this.runners[b].splits.length);for(e-=2,a="<table class='splitstable'><tr><th>Course</th><th>Name</th>",b=1;e>=b;b+=1)a+="<th>"+b+"</th>";for(a+="<th>F</th></tr>",b=0;b<this.runners.length;b+=1){for(d=this.runners[b],g=0,a+="<tr class='splitsname-row'><td>"+d.coursename+"</td><td>"+d.name+"</td>",c=1;c<d.splits.length;c+=1)a+="<td>"+formatSecsAsMMSS(d.splits[c])+"</td>",f[c]=d.splits[c]-g,g=d.splits[c];for(a+="</tr><tr class='splitstime-row'><td></td><td></td>",c=1;c<d.splits.length;c+=1)a+="<td>"+formatSecsAsMMSS(f[c])+"</td>";for(a+="</tr><tr class='splitsdistance-row'><td></td><td>pixels</td>",c=1;c<d.splits.length;c+=1)a+="<td>"+d.legTrackDistance[c]+"</td>"}return a+="</tr></table>"},removeRunner:function(a){for(var b=0;b<this.runners.length;b+=1)this.runners[b].runnerid==a&&this.runners.splice(b,1);this.updateAnimationDetails()},toggleAnimation:function(){null===this.timer?(this.startAnimation(),$("#btn-start-stop").removeClass("fa-play").addClass("fa-pause"),$("#btn-start-stop").prop("title","Pause")):(this.stopAnimation(),$("#btn-start-stop").removeClass("fa-pause").addClass("fa-play"),$("#btn-start-stop").prop("title","Run"))},startAnimation:function(){null===this.timer&&(this.timer=setInterval(this.timerExpired.bind(this),this.timerInterval))},calculateAnimationRange:function(){this.earliestStartSecs=86400,this.latestFinishSecs=0,this.slowestTimeSecs=0;for(var a=0;a<this.runners.length;a+=1)this.runners[a].starttime<this.earliestStartSecs&&(this.earliestStartSecs=this.runners[a].starttime),this.runners[a].starttime+this.runners[a].x.length>this.latestFinishSecs&&(this.latestFinishSecs=this.runners[a].starttime+this.runners[a].x.length),this.runners[a].x.length>this.slowestTimeSecs&&(this.slowestTimeSecs=this.runners[a].x.length);this.resetAnimationTime(0)},stopAnimation:function(){clearInterval(this.timer),this.timer=null},timerExpired:function(){rg2.redraw(!0)},setFullTails:function(a){this.useFullTails=a?!0:!1,rg2.redraw(!1)},setTailLength:function(a){this.tailLength=60*a,rg2.redraw(!1)},setStartControl:function(a){var b;if(this.massStartControl=parseInt(a,10),this.massStartControl===rg2.config.MASS_START_BY_CONTROL)for(this.massStartControl=0,this.massStartByControl=!0,b=0;b<this.runners.length;b+=1)this.runners[b].nextStopTime=this.runners[b].splits[1];else for(this.massStartByControl=!1,b=0;b<this.runners.length;b+=1)this.runners[b].nextStopTime=rg2.config.VERY_HIGH_TIME_IN_SECS;this.resetAnimationTime(0)},setReplayType:function(a){a===rg2.config.MASS_START_REPLAY?(this.realTime=!1,$("#btn-mass-start").addClass("active"),$("#btn-real-time").removeClass("active"),rg2.getHighestControlNumber()>0&&$("#rg2-control-select").prop("disabled",!1)):(this.realTime=!0,$("#btn-mass-start").removeClass("active"),$("#btn-real-time").addClass("active"),$("#rg2-control-select").prop("disabled",!0)),this.resetAnimationTime(0)},resetAnimationTime:function(a){this.realTime?(this.animationSecs=a>0?a:this.earliestStartSecs,this.startSecs=this.earliestStartSecs,$("#rg2-clock-slider").slider("option","max",this.latestFinishSecs),$("#rg2-clock-slider").slider("option","min",this.earliestStartSecs)):(this.animationSecs=a>0?a:0,this.startSecs=0,$("#rg2-clock-slider").slider("option","max",this.slowestTimeSecs),$("#rg2-clock-slider").slider("option","min",0)),$("#rg2-clock-slider").slider("value",this.animationSecs),$("#rg2-clock").text(this.formatSecsAsHHMMSS(this.animationSecs))},toggleNameDisplay:function(){this.displayNames?$("#btn-toggle-names").prop("title","Show names"):$("#btn-toggle-names").prop("title","Hide names"),this.displayNames=!this.displayNames},runAnimation:function(a){this.realTime?this.animationSecs<this.latestFinishSecs&&a&&(this.animationSecs+=this.deltaSecs):this.animationSecs<this.slowestTimeSecs&&a&&(this.animationSecs+=this.deltaSecs),$("#rg2-clock-slider").slider("value",this.animationSecs),$("#rg2-clock").text(this.formatSecsAsHHMMSS(this.animationSecs)),rg2.ctx.lineWidth=rg2.config.REPLAY_LINE_THICKNESS,rg2.ctx.globalAlpha=1;var b,c,d,e,f;for(f=this.useFullTails?this.startSecs+1:Math.max(this.animationSecs-this.tailLength,this.startSecs+1),d=0;d<this.runners.length;d+=1){for(b=this.runners[d],c=this.realTime?b.starttime:0===this.massStartControl||b.splits.length<this.massStartControl?0:-1*b.splits[this.massStartControl],rg2.ctx.strokeStyle=b.colour,rg2.ctx.beginPath(),rg2.ctx.moveTo(b.x[f-c],b.y[f-c]),e=f;e<=this.animationSecs;e+=1)e>c&&e-c<b.nextStopTime&&rg2.ctx.lineTo(b.x[e-c],b.y[e-c]);rg2.ctx.stroke(),rg2.ctx.fillStyle=b.colour,rg2.ctx.beginPath(),e-c<b.nextStopTime?e-=c:e=b.nextStopTime,rg2.ctx.arc(b.x[e]+rg2.config.RUNNER_DOT_RADIUS/2,b.y[e],rg2.config.RUNNER_DOT_RADIUS,0,2*Math.PI,!1),rg2.ctx.fill(),this.displayNames&&(rg2.ctx.fillStyle="black",rg2.ctx.font="20pt Arial",rg2.ctx.textAlign="left",rg2.ctx.fillText(b.name,b.x[e]+15,b.y[e]+7))}this.massStartByControl&&this.checkForStopControl(this.animationSecs)},checkForStopControl:function(a){var b,c,d=!0;for(b=0;b<this.runners.length;b+=1)if(c=this.runners[b].splits[this.massStartControl+1]-this.runners[b].splits[this.massStartControl],c>a){d=!1;break}if(d){for(this.massStartControl+=1,b=0;b<this.runners.length;b+=1)this.runners[b].nextStopTime=this.massStartControl<this.runners[b].splits.length?this.runners[b].splits[this.massStartControl+1]:rg2.config.VERY_HIGH_TIME_IN_SECS;this.resetAnimationTime(0)}},goSlower:function(){this.deltaSecs>0&&(this.deltaSecs-=1)},goFaster:function(){this.deltaSecs+=1},formatSecsAsHHMMSS:function(a){var b,c=Math.floor(a/3600);b=10>c?"0"+c+":":c+":",a-=3600*c;var d=Math.floor(a/60);b+=10>d?"0"+d:d;var e=a-60*d;return b+=10>e?":0"+e:":"+e},formatSecsAsMinutes:function(a){var b=Math.floor(a/60),c=a-60*b;return 10>c?b+":0"+c:b+":"+c}},Controls.prototype={Constructor:Controls,addControl:function(a,b,c){for(var d=!0,e=0;e<this.controls.length;e+=1)if(this.controls[e].code===a){d=!1;break}d&&this.controls.push(new Control(a,b,c))},deleteAllControls:function(){this.controls.length=0},drawControls:function(){if(this.displayControls){rg2.ctx.lineWidth=rg2.config.OVERPRINT_LINE_THICKNESS,rg2.ctx.strokeStyle=rg2.config.PURPLE,rg2.ctx.font="20pt Arial",rg2.ctx.fillStyle=rg2.config.PURPLE,rg2.ctx.globalAlpha=1;for(var a=0;a<this.controls.length;a+=1)0===this.controls[a].code.indexOf("F")?this.drawFinish(this.controls[a].x,this.controls[a].y,this.controls[a].code):0===this.controls[a].code.indexOf("S")?this.drawStart(this.controls[a].x,this.controls[a].y,this.controls[a].code,6*Math.PI/4):this.drawSingleControl(this.controls[a].x,this.controls[a].y,this.controls[a].code)}},drawSingleControl:function(a,b,c){rg2.ctx.beginPath(),rg2.ctx.strokeStyle="white",rg2.ctx.lineWidth=rg2.config.OVERPRINT_LINE_THICKNESS+2,rg2.ctx.arc(a,b,20,0,2*Math.PI,!1),rg2.ctx.stroke(),rg2.ctx.beginPath(),rg2.ctx.textAlign="left",rg2.ctx.font="20pt Arial",rg2.ctx.strokeStyle="white",rg2.ctx.miterLimit=2,rg2.ctx.lineJoin="circle",rg2.ctx.lineWidth=1.5,rg2.ctx.strokeText(c,a+25,b+20),rg2.ctx.beginPath(),rg2.ctx.font="20pt Arial",rg2.ctx.fillStyle=rg2.config.PURPLE,rg2.ctx.strokeStyle=rg2.config.PURPLE,rg2.ctx.lineWidth=rg2.config.OVERPRINT_LINE_THICKNESS,rg2.ctx.arc(a,b,20,0,2*Math.PI,!1),rg2.ctx.fillText(c,a+25,b+20),rg2.ctx.stroke()},drawFinish:function(a,b,c){rg2.ctx.strokeStyle="white",rg2.ctx.lineWidth=rg2.config.OVERPRINT_LINE_THICKNESS+2,rg2.ctx.beginPath(),rg2.ctx.arc(a,b,rg2.config.FINISH_INNER_RADIUS,0,2*Math.PI,!1),rg2.ctx.stroke(),rg2.ctx.beginPath(),rg2.ctx.arc(a,b,rg2.config.FINISH_OUTER_RADIUS,0,2*Math.PI,!1),rg2.ctx.stroke(),rg2.ctx.beginPath(),rg2.ctx.font="20pt Arial",rg2.ctx.textAlign="left",rg2.ctx.strokeStyle="white",rg2.ctx.miterLimit=2,rg2.ctx.lineJoin="circle",rg2.ctx.lineWidth=1.5,rg2.ctx.strokeText(c,a+30,b+20),rg2.ctx.stroke(),rg2.ctx.beginPath(),rg2.ctx.fillStyle=rg2.config.PURPLE,rg2.ctx.strokeStyle=rg2.config.PURPLE,rg2.ctx.lineWidth=rg2.config.OVERPRINT_LINE_THICKNESS,rg2.ctx.arc(a,b,rg2.config.FINISH_INNER_RADIUS,0,2*Math.PI,!1),rg2.ctx.stroke(),rg2.ctx.beginPath(),rg2.ctx.arc(a,b,rg2.config.FINISH_OUTER_RADIUS,0,2*Math.PI,!1),rg2.ctx.fillText(c,a+30,b+20),rg2.ctx.stroke()},drawStart:function(a,b,c,d){var e=[],f=[],g=2*Math.PI/3;d+=Math.PI/2,rg2.ctx.lineCap="round",rg2.ctx.strokeStyle="white",rg2.ctx.lineWidth=rg2.config.OVERPRINT_LINE_THICKNESS+2,rg2.ctx.beginPath(),e[0]=a+rg2.config.START_TRIANGLE_LENGTH*Math.sin(d),f[0]=b-rg2.config.START_TRIANGLE_LENGTH*Math.cos(d),rg2.ctx.moveTo(e[0],f[0]),e[1]=a+rg2.config.START_TRIANGLE_LENGTH*Math.sin(d+g),f[1]=b-rg2.config.START_TRIANGLE_LENGTH*Math.cos(d+g),rg2.ctx.lineTo(e[1],f[1]),rg2.ctx.stroke(),rg2.ctx.beginPath(),rg2.ctx.moveTo(e[1],f[1]),e[2]=a+rg2.config.START_TRIANGLE_LENGTH*Math.sin(d-g),f[2]=b-rg2.config.START_TRIANGLE_LENGTH*Math.cos(d-g),rg2.ctx.lineTo(e[2],f[2]),rg2.ctx.stroke(),rg2.ctx.beginPath(),rg2.ctx.moveTo(e[2],f[2]),rg2.ctx.lineTo(e[0],f[0]),rg2.ctx.stroke(),rg2.ctx.beginPath(),rg2.ctx.font="20pt Arial",rg2.ctx.textAlign="left",rg2.ctx.strokeStyle="white",rg2.ctx.miterLimit=2,rg2.ctx.lineJoin="circle",rg2.ctx.lineWidth=1.5,rg2.ctx.strokeText(c,e[0]+25,f[0]+25),rg2.ctx.stroke(),rg2.ctx.strokeStyle=rg2.config.PURPLE,rg2.ctx.lineWidth=rg2.config.OVERPRINT_LINE_THICKNESS,rg2.ctx.font="20pt Arial",rg2.ctx.fillStyle=rg2.config.PURPLE,rg2.ctx.beginPath(),rg2.ctx.moveTo(e[0],f[0]),rg2.ctx.lineTo(e[1],f[1]),rg2.ctx.stroke(),rg2.ctx.beginPath(),rg2.ctx.moveTo(e[1],f[1]),rg2.ctx.lineTo(e[2],f[2]),rg2.ctx.stroke(),rg2.ctx.beginPath(),rg2.ctx.moveTo(e[2],f[2]),rg2.ctx.lineTo(e[0],f[0]),rg2.ctx.fillText(c,e[0]+25,f[0]+25),rg2.ctx.stroke()},toggleControlDisplay:function(){this.displayControls?($("#btn-toggle-controls").removeClass("fa-ban").addClass("fa-circle-o"),$("#btn-toggle-controls").prop("title","Show all controls map")):($("#btn-toggle-controls").removeClass("fa-circle-o").addClass("fa-ban"),$("#btn-toggle-controls").prop("title","Hide all controls map")),this.displayControls=!this.displayControls},displayAllControls:function(){this.displayControls=!0}},Control.prototype={Constructor:Control},Courses.prototype={Constructor:Courses,getCourseName:function(a){return this.courses[a].name},getHighestControlNumber:function(){return this.highestControlNumber},getFullCourse:function(a){return this.courses[a]},incrementTracksCount:function(a){this.courses[a].incrementTracksCount(),this.totaltracks+=1},gettrackcountCount:function(a){return this.courses[a].trackcount},getTotalTracksCount:function(){return this.totaltracks},addCourse:function(a){this.courses[a.courseid]=a,this.numberofcourses+=1,void 0!==this.courses[a.courseid].codes&&this.courses[a.courseid].codes.length>this.highestControlNumber&&(this.highestControlNumber=this.courses[a.courseid].codes.length-1,this.updateControlDropdown())
},updateCourseDropdown:function(){$("#rg2-course-select").empty();var a,b=document.getElementById("rg2-course-select"),c=document.createElement("option");for(c.value=null,c.text="Select course",b.options.add(c),a=0;a<this.courses.length;a+=1)void 0!==this.courses[a]&&(c=document.createElement("option"),c.value=a,c.text=this.courses[a].name,b.options.add(c))},updateControlDropdown:function(){$("#rg2-control-select").empty();var a,b,c=document.getElementById("rg2-control-select");for(b=0;b<this.highestControlNumber;b+=1)a=document.createElement("option"),a.value=b,a.text=0===b?"S":b,c.options.add(a);a=document.createElement("option"),a.value=rg2.config.MASS_START_BY_CONTROL,a.text="By control",c.options.add(a)},deleteAllCourses:function(){this.courses.length=0,this.numberofcourses=0,this.totaltracks=0,this.highestControlNumber=0},drawCourses:function(a){for(var b=0;b<this.courses.length;b+=1)void 0!==this.courses[b]&&this.courses[b].drawCourse(a)},putOnDisplay:function(a){void 0!==this.courses[a]&&(this.courses[a].display=!0)},putAllOnDisplay:function(){for(var a=0;a<this.courses.length;a+=1)void 0!==this.courses[a]&&(this.courses[a].display=!0)},removeAllFromDisplay:function(){for(var a=0;a<this.courses.length;a+=1)void 0!==this.courses[a]&&(this.courses[a].display=!1)},removeFromDisplay:function(a){this.courses[a].display=!1},isOnDisplay:function(a){return this.courses[a].display},toggleDisplay:function(a){this.courses[a].toggleDisplay()},getNumberOfCourses:function(){return this.numberofcourses},generateControlList:function(a){for(var b,c,d,e=0;e<this.courses.length;e+=1)if(void 0!==this.courses[e]&&(b=this.courses[e].codes,c=this.courses[e].x,d=this.courses[e].y,void 0!==b))for(var f=0;f<b.length;f+=1)a.addControl(b[f],c[f],d[f])},formatCoursesAsTable:function(){for(var a="<table class='coursemenutable'><tr><th>Course</th><th>Show</th><th>Runners</th><th>Tracks</th><th>Show</th></tr>",b=0;b<this.courses.length;b+=1)void 0!==this.courses[b]&&(a+="<tr><td>"+this.courses[b].name+"</td>",a+="<td><input class='courselist' id="+b+" type=checkbox name=course></input></td>",a+="<td>"+rg2.getResultsByCourseID(b)+"</td>",a+="<td>"+this.courses[b].trackcount+"</td>",a+=this.courses[b].trackcount>0?"<td><input id="+b+" class='tracklist' type=checkbox name=track></input></td>":"<td></td>",a+="</tr>");return a+="<tr><td>All</td>",a+="<td><input class='allcourses' id="+b+" type=checkbox name=course></input></td>",a+="<td>"+rg2.getTotalResults()+"</td>",a+=this.totaltracks>0?"<td>"+this.totaltracks+"</td><td><input id="+b+" class='alltracks' type=checkbox name=track></input></td>":"<td>"+this.totaltracks+"</td><td></td>",a+="</tr></table>"}},Course.prototype={Constructor:Course,incrementTracksCount:function(){this.trackcount+=1},getCourseID:function(){return this.courseid},toggleDisplay:function(){this.display=!this.display},drawCourse:function(a){if(this.display){var b,c,d,e,f;for(rg2.ctx.globalAlpha=a,b=this.isScoreCourse?3*Math.PI/2:getAngle(this.x[0],this.y[0],this.x[1],this.y[1]),rg2.drawStart(this.x[0],this.y[0],"",b),g=0;g<this.x.length-1;g+=1)b=getAngle(this.x[g],this.y[g],this.x[g+1],this.y[g+1]),0===g?(c=this.x[g]+rg2.config.START_TRIANGLE_LENGTH*Math.cos(b),d=this.y[g]+rg2.config.START_TRIANGLE_LENGTH*Math.sin(b)):(c=this.x[g]+rg2.config.CONTROL_CIRCLE_RADIUS*Math.cos(b),d=this.y[g]+rg2.config.CONTROL_CIRCLE_RADIUS*Math.sin(b)),g===this.x.length-2?(e=this.x[g+1]-rg2.config.FINISH_OUTER_RADIUS*Math.cos(b),f=this.y[g+1]-rg2.config.FINISH_OUTER_RADIUS*Math.sin(b)):(e=this.x[g+1]-rg2.config.CONTROL_CIRCLE_RADIUS*Math.cos(b),f=this.y[g+1]-rg2.config.CONTROL_CIRCLE_RADIUS*Math.sin(b)),this.isScoreCourse||(rg2.ctx.lineWidth=rg2.config.OVERPRINT_LINE_THICKNESS,rg2.ctx.strokeStyle=rg2.config.PURPLE,rg2.ctx.beginPath(),rg2.ctx.moveTo(c,d),rg2.ctx.lineTo(e,f),rg2.ctx.stroke());for(var g=1;g<this.x.length-1;g+=1)rg2.drawSingleControl(this.x[g],this.y[g],g);rg2.drawFinish(this.x[this.x.length-1],this.y[this.y.length-1],"")}}},Draw.prototype={Constructor:Draw,gpsFileLoaded:function(){return this.gpstrack.fileLoaded},uploadGPS:function(a){this.gpstrack.uploadGPS(a)},getControlX:function(){return this.controlx},getControlY:function(){return this.controly},mouseUp:function(a,b){var c=$("#rg2-info-panel").tabs("option","active");if(c==rg2.config.TAB_DRAW)if(this.gpstrack.fileLoaded)null===this.handleX?(this.handleX=a,this.handleY=b):(this.handleX=null,this.handleY=null);else if(null!==this.gpstrack.routeData.resultid&&null!==this.gpstrack.routeData.courseid)this.addNewPoint(a,b);else{var d="<div id='drawing-reset-dialog'>Please select course and name before you start drawing a route or upload a file.</div>";$(d).dialog({title:"Select course and name"})}},dragEnded:function(){this.gpstrack.fileLoaded&&(this.gpstrack.baseX=this.gpstrack.routeData.x.slice(0),this.gpstrack.baseY=this.gpstrack.routeData.y.slice(0),rg2.redraw(!1))},toggleMoveAll:function(a){this.backgroundLocked=a},initialiseDrawing:function(){this.gpstrack.routeData=new RouteData,this.handleX=null,this.handleY=null,this.backgroundLocked=!1,this.pendingCourseID=null,this.controlx=[],this.controly=[],this.nextControl=0,this.gpstrack.initialiseGPS(),this.hasResults=rg2.eventHasResults(),this.hasResults?($("#rg2-select-name").show(),$("#rg2-enter-name").hide()):($("#rg2-select-name").hide(),$("#rg2-enter-name").show()),$("#rg2-name-select").prop("disabled",!0),$("#rg2-undo").prop("disabled",!0),$("#btn-save-route").button("disable"),$("#btn-save-gps-route").button("disable"),$("#btn-undo").button("disable"),$("#btn-three-seconds").button("disable"),$("#btn-reset-drawing").button("enable"),$("#rg2-name-select").empty(),$("#rg2-new-comments").empty().val(rg2.config.DEFAULT_NEW_COMMENT),$("#rg2-event-comments").empty().val(rg2.config.DEFAULT_EVENT_COMMENT),$("rg2-move-all").prop("checked",!1),$("#rg2-load-gps-file").button("disable"),$("#rg2-name-entry").empty().val(""),$("#rg2-time-entry").empty().val(""),$("#rg2-name").removeClass("valid"),$("#rg2-time").removeClass("valid"),rg2.redraw(!1)},setCourse:function(a){isNaN(a)||(null!==this.gpstrack.routeData.courseid?this.gpstrack.routeData.x.length>1?(this.pendingCourseid=a,this.confirmCourseChange()):(rg2.removeFromDisplay(this.gpstrack.routeData.courseid),this.initialiseCourse(a)):this.initialiseCourse(a))},initialiseCourse:function(a){this.gpstrack.routeData.eventid=rg2.getKartatEventID(),this.gpstrack.routeData.courseid=a,rg2.putOnDisplay(a);var b=rg2.getCourseDetails(a);this.gpstrack.routeData.coursename=b.name,this.controlx=b.x,this.controly=b.y,this.gpstrack.routeData.x.length=0,this.gpstrack.routeData.y.length=0,this.gpstrack.routeData.x[0]=this.controlx[0],this.gpstrack.routeData.y[0]=this.controly[0],this.nextControl=1,rg2.createNameDropdown(a),$("#rg2-name-select").prop("disabled",!1),rg2.redraw(!1)},confirmCourseChange:function(){var a="<div id='course-change-dialog'>The route you have started to draw will be discarded. Are you sure you want to change the course?</div>",b=this;$(a).dialog({title:"Confirm course change",modal:!0,dialogClass:"no-close",closeOnEscape:!1,buttons:[{text:"Change course",click:function(){b.doChangeCourse()}},{text:"Cancel",click:function(){b.doCancelChangeCourse()}}]})},resetDrawing:function(){var a="<div id='drawing-reset-dialog'>All information you have entered will be removed. Are you sure you want to reset?</div>",b=this;$(a).dialog({title:"Confirm reset",modal:!0,dialogClass:"no-close",closeOnEscape:!1,buttons:[{text:"Reset",click:function(){b.doDrawingReset()}},{text:"Cancel",click:function(){b.doCancelDrawingReset()}}]})},doChangeCourse:function(){$("#course-change-dialog").dialog("destroy"),rg2.removeFromDisplay(this.gpstrack.routeData.courseid),this.initialiseCourse(this.pendingCourseid)},doCancelChangeCourse:function(){$("#rg2-course-select").val(this.gpstrack.routeData.courseid),this.pendingCourseid=null,$("#course-change-dialog").dialog("destroy")},doDrawingReset:function(){$("#drawing-reset-dialog").dialog("destroy"),this.pendingCourseid=null,this.initialiseDrawing()},doCancelDrawingReset:function(){$("#drawing-reset-dialog").dialog("destroy")},showCourseInProgress:function(){null!==this.gpstrack.routeData.courseid&&rg2.putOnDisplay(this.gpstrack.routeData.courseid)},setName:function(a){isNaN(a)||(this.gpstrack.routeData.resultid=rg2.getKartatResultID(a),this.gpstrack.routeData.name=rg2.getRunnerName(a),this.startDrawing())},setNameAndTime:function(){var a,b=$("#rg2-name-entry").val();b?$("#rg2-name").addClass("valid"):$("#rg2-name").removeClass("valid"),a=$("#rg2-time-entry").val(),a.match(/\d+[:.][0-5]\d$/)?$("#rg2-time").addClass("valid"):($("#rg2-time").removeClass("valid"),a=null),b&&a&&(a=a.replace(".",":"),this.gpstrack.routeData.name=b,this.gpstrack.routeData.resultid=0,this.gpstrack.routeData.totaltime=a,this.gpstrack.routeData.startsecs=0,this.gpstrack.routeData.time[0]=getSecsFromMMSS(a),this.startDrawing())},startDrawing:function(){$("#btn-three-seconds").button("enable"),$("#rg2-load-gps-file").button("enable")},addNewPoint:function(a,b){this.closeEnough(a,b)?(this.gpstrack.routeData.x.push(this.controlx[this.nextControl]),this.gpstrack.routeData.y.push(this.controly[this.nextControl]),this.nextControl+=1,this.nextControl===this.controlx.length&&$("#btn-save-route").button("enable")):(this.gpstrack.routeData.x.push(Math.round(a)),this.gpstrack.routeData.y.push(Math.round(b))),this.gpstrack.routeData.x.length>1?$("#btn-undo").button("enable"):$("#btn-undo").button("disable"),rg2.redraw(!1)},undoLastPoint:function(){var a=this.gpstrack.routeData.x.length;a>1&&(this.controlx[this.nextControl-1]===this.gpstrack.routeData.x[a-1]&&this.controly[this.nextControl-1]===this.gpstrack.routeData.y[a-1]&&(this.nextControl===this.controlx.length&&$("#btn-save-route").button("disable"),this.nextControl>1&&(this.nextControl-=1)),this.gpstrack.routeData.x.pop(),this.gpstrack.routeData.y.pop()),this.gpstrack.routeData.x.length>1?$("#btn-undo").button("enable"):$("#btn-undo").button("enable"),rg2.redraw(!1)},saveGPSRoute:function(){var a,b=this.gpstrack.routeData.time[this.gpstrack.routeData.time.length-1]-this.gpstrack.routeData.time[0];for(this.gpstrack.routeData.totaltime=formatSecsAsMMSS(b),this.gpstrack.routeData.startsecs=this.gpstrack.routeData.time[0],a=0;a<this.gpstrack.routeData.x.length;a+=1)this.gpstrack.routeData.x[a]=parseInt(this.gpstrack.routeData.x[a],10),this.gpstrack.routeData.y[a]=parseInt(this.gpstrack.routeData.y[a],10),this.gpstrack.routeData.time[a]-=this.gpstrack.routeData.startsecs;for(this.gpstrack.routeData.resultid+=rg2.config.GPS_RESULT_OFFSET;rg2.resultIDExists(this.gpstrack.routeData.resultid);)this.gpstrack.routeData.resultid+=rg2.config.GPS_RESULT_OFFSET,this.gpstrack.routeData.name+="*";this.gpstrack.routeData.comments=$("#rg2-new-comments").val(),this.postRoute()},saveRoute:function(){this.gpstrack.routeData.comments=$("#rg2-new-comments").val(),this.gpstrack.routeData.controlx=this.controlx,this.gpstrack.routeData.controly=this.controly,this.gpstrack.routeData.controlx.splice(0,1),this.gpstrack.routeData.controly.splice(0,1),this.postRoute()},postRoute:function(){var a=json_url+"?type=addroute&id="+this.gpstrack.routeData.eventid,b=JSON.stringify(this.gpstrack.routeData),c=this;$.ajax({data:b,type:"POST",url:a,dataType:"json",success:function(a){a.ok?c.routeSaved(a.status_msg):c.saveError(a.status_msg)},error:function(a,b,d){c.saveError(d)}})},saveError:function(a){var b="<div>Your route was not saved. Please try again. "+a+"</div>";$(b).dialog({title:this.gpstrack.routeData.name})},routeSaved:function(){var a="<div>Your route has been saved.</div>";$(a).dialog({title:this.gpstrack.routeData.name}),rg2.loadEvent(rg2.getActiveEventID())},waitThreeSeconds:function(){this.gpstrack.routeData.x.push(this.gpstrack.routeData.x[this.gpstrack.routeData.x.length-1]),this.gpstrack.routeData.y.push(this.gpstrack.routeData.y[this.gpstrack.routeData.y.length-1]),rg2.redraw(!1)},closeEnough:function(a,b){return Math.abs(a-this.controlx[this.nextControl])<this.CLOSE_ENOUGH&&Math.abs(b-this.controly[this.nextControl])<this.CLOSE_ENOUGH?!0:!1},trackLocked:function(){return null!==this.handleX},adjustTrack:function(a,b,c,d,e){var f;if(this.backgroundLocked)rg2.ctx.translate(c-a,d-b);else if(null!==this.handleX){var g=(c-this.handleX)/(a-this.handleX),h=(d-this.handleY)/(b-this.handleY),i=getAngle(a,b,this.handleX,this.handleY),j=getAngle(c,d,this.handleX,this.handleY),k=j-i;for(e||(h=g),f=0;f<this.gpstrack.routeData.x.length;f+=1){var l=this.gpstrack.baseX[f]-this.handleX,m=this.gpstrack.baseY[f]-this.handleY;this.gpstrack.routeData.x[f]=(Math.cos(k)*l-Math.sin(k)*m)*g+this.handleX,this.gpstrack.routeData.y[f]=(Math.sin(k)*l+Math.cos(k)*m)*h+this.handleY}}else{var n=c-a,o=d-b;for(f=0;f<this.gpstrack.routeData.x.length;f+=1)this.gpstrack.routeData.x[f]=this.gpstrack.baseX[f]+n,this.gpstrack.routeData.y[f]=this.gpstrack.baseY[f]+o}},drawNewTrack:function(){if(rg2.ctx.lineWidth=2,rg2.ctx.strokeStyle=this.trackColor,rg2.ctx.fillStyle=this.trackColour,rg2.ctx.font="10pt Arial",rg2.ctx.textAlign="left",rg2.ctx.globalAlpha=1,this.nextControl>0&&!this.gpstrack.fileLoaded&&(rg2.ctx.beginPath(),this.nextControl<this.controlx.length-1?rg2.ctx.arc(this.controlx[this.nextControl],this.controly[this.nextControl],rg2.config.CONTROL_CIRCLE_RADIUS,0,2*Math.PI,!1):(rg2.ctx.arc(this.controlx[this.nextControl],this.controly[this.nextControl],rg2.config.FINISH_INNER_RADIUS,0,2*Math.PI,!1),rg2.ctx.stroke(),rg2.ctx.beginPath(),rg2.ctx.arc(this.controlx[this.nextControl],this.controly[this.nextControl],rg2.config.FINISH_OUTER_RADIUS,0,2*Math.PI,!1)),rg2.ctx.fillRect(this.controlx[this.nextControl]-1,this.controly[this.nextControl]-1,3,3),rg2.ctx.stroke(),rg2.ctx.beginPath(),rg2.ctx.arc(this.gpstrack.routeData.x[0]+rg2.config.RUNNER_DOT_RADIUS/2,this.gpstrack.routeData.y[0],rg2.config.RUNNER_DOT_RADIUS,0,2*Math.PI,!1),rg2.ctx.fill()),null!==this.handleX&&(rg2.ctx.beginPath(),rg2.ctx.arc(this.handleX,this.handleY,this.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),rg2.ctx.fill(),rg2.ctx.beginPath(),rg2.ctx.arc(this.handleX,this.handleY,2*this.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),rg2.ctx.stroke()),this.gpstrack.routeData.x.length>1){rg2.ctx.beginPath(),rg2.ctx.moveTo(this.gpstrack.routeData.x[0],this.gpstrack.routeData.y[0]);for(var a=this.gpstrack.routeData.x[0],b=this.gpstrack.routeData.y[0],c=0,d=1;d<this.gpstrack.routeData.x.length;d+=1)rg2.ctx.lineTo(this.gpstrack.routeData.x[d],this.gpstrack.routeData.y[d]),this.gpstrack.routeData.x[d]==a&&this.gpstrack.routeData.y[d]==b?(c+=1,d===this.gpstrack.routeData.x.length-1&&rg2.ctx.fillText(3*c+" secs",this.gpstrack.routeData.x[d]+5,this.gpstrack.routeData.y[d]+5)):c>0&&(rg2.ctx.fillText(3*c+" secs",a+5,b+5),c=0),a=this.gpstrack.routeData.x[d],b=this.gpstrack.routeData.y[d];rg2.ctx.stroke()}}},Events.prototype={Constructor:Events,addEvent:function(a){this.events.push(a)},getKartatEventID:function(){return this.events[this.activeEventID].kartatid},getActiveMapID:function(){return this.events[this.activeEventID].mapid},setActiveEventID:function(a){this.activeEventID=a},getActiveEventID:function(){return this.activeEventID},getActiveEventDate:function(){return null!==this.activeEventID?this.events[this.activeEventID].date:""},getActiveEventName:function(){return null!==this.activeEventID?this.events[this.activeEventID].name:"Routegadget 2.0"},createEventEditDropdown:function(){$("#rg2-manager-event-select").empty();var a,b=document.getElementById("rg2-manager-event-select");for(a=0;a<this.events.length;a+=1){var c=document.createElement("option");c.value=this.events[a].kartatid,c.text=this.events[a].date+": "+this.events[a].name,b.options.add(c)}},isScoreEvent:function(){return this.events[this.activeEventID].format===rg2.config.SCORE_EVENT},hasResults:function(){return null!==this.activeEventID?this.events[this.activeEventID].format!==rg2.config.EVENT_WITHOUT_RESULTS:!0},isValidEventID:function(a){return this.events.length>=a&&a>0?!0:!1},mapIsGeoreferenced:function(){return this.events[this.activeEventID].georeferenced},getWorldFile:function(){return this.events[this.activeEventID].worldFile},formatEventsAsMenu:function(){var a,b,c="";for(b=this.events.length-1;b>=0;b-=1)a=""!==this.events[b].comment?this.events[b].type+" event on "+this.events[b].date+": "+this.events[b].comment:this.events[b].type+" event on "+this.events[b].date,c+="<li title='"+a+"' id="+b+"><a href='#"+b+"'>",""!==this.events[b].comment&&(c+="<i class='fa fa-info-circle event-info-icon' id='info-"+b+"'></i>"),c+=this.events[b].name+"</a></li>";return c}},Event.prototype={Constructor:Event},GPSTrack.prototype={Constructor:GPSTrack,initialiseGPS:function(){this.lat.length=0,this.lon.length=0,this.time.length=0,this.baseX.length=0,this.baseY.length=0,this.fileLoaded=!1},uploadGPS:function(a){var b=new FileReader;b.onerror=function(a){switch(a.target.error.code){case a.target.error.NOT_FOUND_ERR:alert("File not found");break;case a.target.error.NOT_READABLE_ERR:alert("File not readable");break;default:alert("An error occurred reading the file.")}};var c=this;b.onload=function(a){var b,d,e,f,g,h;for(e=$.parseXML(a.target.result),b=e.getElementsByTagName("trkseg"),f=0;f<b.length;f+=1)for(d=b[f].getElementsByTagName("trkpt"),g=0;g<d.length;g+=1)c.lat.push(d[g].getAttribute("lat")),c.lon.push(d[g].getAttribute("lon")),h=d[g].childNodes[3].textContent,c.time.push(c.getSecsFromTrackpoint(h));c.processGPSTrack(),$("#rg2-load-gps-file").button("disable"),console.log("File loaded")},b.readAsText(a.target.files[0])},getSecsFromTrackpoint:function(a){var b=parseInt(a.substr(11,2),10),c=parseInt(a.substr(14,2),10),d=parseInt(a.substr(17,2),10);return 3600*b+60*c+d},processGPSTrack:function(){if(rg2.mapIsGeoreferenced()){var a,b=rg2.getWorldFile(),c=b.A*b.E-b.D*b.B,d=b.B*b.F-b.E*b.C,e=b.D*b.C-b.A*b.F;for(a=0;a<this.lat.length;a+=1)this.routeData.x[a]=Math.round((b.E*this.lon[a]-b.B*this.lat[a]+d)/c),this.routeData.y[a]=Math.round((-1*b.D*this.lon[a]+b.A*this.lat[a]+e)/c);var f=this.routeData.x[0],g=this.routeData.x[0],h=this.routeData.y[0],i=this.routeData.y[0];for(a=1;a<this.routeData.x.length;a+=1)g=Math.max(g,this.routeData.x[a]),i=Math.max(i,this.routeData.y[a]),f=Math.min(f,this.routeData.x[a]),h=Math.min(h,this.routeData.y[a]);var j=rg2.getMapSize();if(0>g||f>j.width||h>j.height||0>i){var k="<div id='GPS-problem-dialog'>Your GPS file does not match the map co-ordinates. Please check you have selected the correct file.</div>";$(k).dialog({title:"GPS file problem"}),this.fitTrackInsideCourse()}}else this.fitTrackInsideCourse();this.baseX=this.routeData.x.slice(0),this.baseY=this.routeData.y.slice(0),this.routeData.time=this.time,this.fileLoaded=!0,$("#btn-save-gps-route").button("enable"),rg2.redraw(!1)},fitTrackInsideCourse:function(){for(var a,b,c,d,e,f,g,h=this.lat[0],i=this.lon[0],j=this.lat[0],k=this.lon[0],l=1;l<this.lat.length;l+=1)h=Math.max(h,this.lat[l]),i=Math.max(i,this.lon[l]),j=Math.min(j,this.lat[l]),k=Math.min(k,this.lon[l]),f=this.lon[l]-this.lon[0],g=this.lat[l]-this.lat[0];var m=rg2.getControlX(),n=rg2.getControlY();for(a=m[0],b=m[0],c=n[0],d=n[0],l=1;l<m.length;l+=1)b=Math.max(b,m[l]),d=Math.max(d,n[l]),a=Math.min(a,m[l]),c=Math.min(c,n[l]);(100>d-c||100>b-a)&&(a=0,c=0,e=rg2.getMapSize(),b=e.width,d=e.height);var o=(b-a)/(i-k),p=(d-c)/(h-j),q=getLatLonDistance(j,i,j,k)/(i-k),r=getLatLonDistance(j,k,h,k)/(h-j);o>p?p=o*r/q:o=p*q/r,this.routeData.x[0]=(this.lon[0]-k)*o+a,this.routeData.y[0]=-1*(this.lat[0]-h)*p+c;var s=a-(this.routeData.x[0]-m[0]),t=c-(this.routeData.y[0]-n[0]);for(l=0;l<this.lat.length;l+=1)this.routeData.x[l]=(this.lon[l]-k)*o+s,this.routeData.y[l]=-1*(this.lat[l]-h)*p+t}},Manager.prototype={Constructor:Manager,logIn:function(){var a=json_url+"?type=login",b=JSON.stringify(this.user),c=this;return $.ajax({type:"POST",dataType:"json",data:b,url:a,cache:!1,success:function(){c.enableEventEdit()},error:function(a,b,c){console.log(c);var d="<div>User name or password incorrect. Please try again.</div>";$(d).dialog({title:"Login failed"})}}),!1},enableEventEdit:function(){this.loggedIn=!0;var a=this;this.createEventLevelDropdown(),rg2.createEventEditDropdown(),$("#rg2-event-comments").focus(function(){var a=$("#rg2-event-comments").val();a===rg2.config.DEFAULT_EVENT_COMMENT&&$("#rg2-event-comments").val("")}),$("#rg2-event-date").datepicker({dateFormat:"dd/mm/yy",onSelect:function(b){a.setDate(b)}}),$("#rg2-event-name").on("change",function(b){a.setEventName(b)}),$("#rg2-club-name").on("change",function(b){a.setClub(b)}),$("#rg2-map-name").on("change",function(b){a.setMapName(b)}),$("#rg2-load-map-file").button().change(function(b){a.readMapJPG(b)}),$("#rg2-load-results-file").button().change(function(b){a.readResultsCSV(b)}),$("#rg2-load-course-file").button().change(function(b){a.readCourseXML(b)}),$("#btn-move-map-and-controls").click(function(b){a.toggleMoveAll(b.target.checked)}),$("#btn-add-event").button().click(function(){$("#rg2-add-new-event").dialog({title:"Add new event",width:"auto",buttons:{Continue:function(){a.doContinue()},Cancel:function(){$(this).dialog("close")}}})}),$("#btn-edit-event").button().click(function(){$("#rg2-manager-event-select").val()}).button("disable"),$("#btn-delete-event").button().click(function(){$("#rg2-manager-event-select").val()}).button("disable"),$("#rg2-manager-options").show(),$("#rg2-manager-login").hide()},doContinue:function(){this.xmlcourses||alert("Data entry not complete")},getCoursesFromResults:function(){var a;for(this.resultCourses=[],a=0;a<this.results.length;a+=1)-1===this.resultCourses.indexOf(this.results[a].course)&&this.resultCourses.push(this.results[a].course)},displayCourseAllocations:function(){if(this.xmlcourses.length&&this.resultCourses&&!this.allocationsDisplayed){var a,b="<table><thead></thead><tbody>";for(a=0;a<this.xmlcourses.length;a+=1)b+="<tr><td>"+this.xmlcourses[a].name+"</td><td>"+this.createCourseDropdown(this.xmlcourses[a].name)+"</td></tr>";b+="</tbody></table>",$("#rg2-course-allocations").append(b),this.allocationsDisplayed=!0}},readResultsCSV:function(a){var b=new FileReader,c=this;b.onerror=function(a){switch(a.target.error.code){case a.target.error.NOT_FOUND_ERR:alert("File not found");break;case a.target.error.NOT_READABLE_ERR:alert("File not readable");break;default:alert("An error occurred reading the file.")}},b.onload=function(a){var b=(a.target.result,a.target.result.split(/[\r\n|\n]+/));c.processSICSVResults(b),$("#rg2-select-results-file").addClass("valid")},b.readAsText(a.target.files[0])},readCourseXML:function(a){var b=new FileReader;b.onerror=function(a){switch(a.target.error.code){case a.target.error.NOT_FOUND_ERR:alert("File not found");break;case a.target.error.NOT_READABLE_ERR:alert("File not readable");break;default:alert("An error occurred reading the file.")}};var c=this;b.onload=function(a){c.processIOFXML(a)},b.readAsText(a.target.files[0])},processIOFXML:function(a){var b,c,d;return b=$.parseXML(a.target.result),c=b.getElementsByTagName("IOFVersion")[0].getAttribute("version"),"2.0.3"!==c?(alert("Invalid IOF file format. Version "+c+" not supported."),void 0):(d=b.getElementsByTagName("StartPoint"),this.extractControls(d),d=b.getElementsByTagName("Control"),this.extractControls(d),d=b.getElementsByTagName("FinishPoint"),this.extractControls(d),d=b.getElementsByTagName("Course"),this.extractCourses(d),this.displayCourseAllocations(),this.fitControlsToMap(),rg2.redraw(!1),void 0)},processSICSVResults:function(a){var b,c,d,e,f=1,g=2,h=3,i=9,j=11,k=15,l=15,m=39,n=42,o=47,p=4,q=2,r={};for(b=0;b<a.length;b+=1)r[b]=a[b].split(";");for(b=1;b<a.length;b+=1)if(r[b].length>=o){for(d={},d.chipid=r[b][f],d.name=r[b][p]+" "+r[b][h],d.dbid=r[b][g]+"_"+d.name,d.starttime=this.convertHHMMSSToSecs(r[b][i]),d.time=r[b][j],d.club=r[b][k],d.club||(d.club=r[b][l]),d.course=r[b][m],d.controls=parseInt(r[b][n],10),e=o,d.splits="",c=0;c<d.controls;c+=1)c>0&&(d.splits+=";"),d.splits+=this.convertMMSSToSecs(r[b][e]),e+=q;d.splits+=";",d.splits+=this.convertMMSSToSecs(d.time),this.results.push(d)}this.getCoursesFromResults(),this.displayCourseAllocations()},convertMMSSToSecs:function(a){if(a){var b=a.split(":"),c=60*parseInt(b[0],0),d=parseInt(b[1],0);return c+d}return 0},convertHHMMSSToSecs:function(a){if(a){var b=3600*parseInt(a.substr(0,2),0),c=60*parseInt(a.substr(3,2),0),d=parseInt(a.substr(6,2),0);return b+c+d}return 0},extractControls:function(a){var b,c,d,e;for(b=0;b<a.length;b+=1)e=a[b].children[0].textContent,c=a[b].children[1].getAttribute("x"),d=a[b].children[1].getAttribute("y"),this.newcontrols.addControl(e.trim(),c,d)},extractCourses:function(a){var b,c,d,e,f,g,h,i;for(b=0;b<a.length;b+=1){for(d={},e=[],f=[],g=[],d.name=a[b].getElementsByTagName("CourseName")[0].textContent,i=a[b].getElementsByTagName("StartPointCode")[0].textContent,e.push(i.trim()),h=a[b].getElementsByTagName("CourseControl"),c=0;c<h.length;c+=1)i=h[c].children[1].textContent,e.push(i.trim());i=a[b].getElementsByTagName("FinishPointCode")[0].textContent,e.push(i.trim()),d.codes=e,d.x=f,d.y=g,this.xmlcourses.push(d)}$("#rg2-select-course-file").addClass("valid")},readMapJPG:function(a){var b=new FileReader,c=this;b.onload=function(a){c.processMap(a)},b.readAsDataURL(a.target.files[0])},processMap:function(a){rg2.loadNewMap(a.target.result),$("#rg2-select-map-file").addClass("valid"),this.mapLoaded=!0;var b=rg2.getMapSize();this.mapWidth=b.width,this.mapHeight=b.height,this.fitControlsToMap(),rg2.redraw(!1)},fitControlsToMap:function(){var a;if(this.mapLoaded&&this.newcontrols.controls.length>0){var b=this.newcontrols.controls[0].x,c=this.newcontrols.controls[0].x,d=this.newcontrols.controls[0].y,e=this.newcontrols.controls[0].y;for(a=1;a<this.newcontrols.controls.length;a+=1)c=Math.max(c,this.newcontrols.controls[a].x),e=Math.max(e,this.newcontrols.controls[a].y),b=Math.min(b,this.newcontrols.controls[a].x),d=Math.min(d,this.newcontrols.controls[a].y);var f=c-b,g=e-d;for(a=0;a<this.newcontrols.controls.length;a+=1)this.newcontrols.controls[a].x=(this.newcontrols.controls[a].x-b)*(this.mapWidth/f),this.newcontrols.controls[a].y=this.mapHeight-(this.newcontrols.controls[a].y-d)*(this.mapHeight/g),this.newcontrols.controls[a].oldX=this.newcontrols.controls[a].x,this.newcontrols.controls[a].oldY=this.newcontrols.controls[a].y;this.newcontrols.displayAllControls()}},setClub:function(){this.club=$("#rg2-club-name").val(),this.club?$("#rg2-select-club-name").addClass("valid"):$("#rg2-select-club-name").removeClass("valid")},setEventName:function(){this.eventName=$("#rg2-event-name").val(),this.eventName?$("#rg2-select-event-name").addClass("valid"):$("#rg2-select-event-name").removeClass("valid")},setMapName:function(){this.mapName=$("#rg2-map-name").val(),this.mapName?$("#rg2-select-map-name").addClass("valid"):$("#rg2-select-map-name").removeClass("valid")},setDate:function(a){this.eventDate=a,this.eventDate?$("#rg2-select-event-date").addClass("valid"):$("#rg2-select-event-date").removeClass("valid")},createEventLevelDropdown:function(){$("#rg2-event-level").empty();var a,b,c=document.getElementById("rg2-event-level"),d=["Local","Regional","National","Training","International"],e=["L","R","N","T","I"];for(b=0;b<d.length;b+=1)a=document.createElement("option"),a.value=e[b],a.text=d[b],c.options.add(a);var f=this;$("#rg2-event-level").click(function(){f.eventLevel=$("#rg2-event-level").val(),$("#rg2-select-event-level").addClass("valid")})},createCourseDropdown:function(a){var b,c=this.resultCourses.indexOf(a),d="<select name='a'><option value=999";for(-1===c&&(d+=" selected"),d+=">Skip this class</option>",b=0;b<this.resultCourses.length;b+=1)d+="<option value="+b,c===b&&(d+=" selected"),d+=">"+this.resultCourses[b]+"</option>";return d+="</select>"},drawControls:function(){this.mapLoaded&&this.newcontrols.controls.length>0&&(this.newcontrols.drawControls(),null!==this.handleX&&(rg2.ctx.lineWidth=2,rg2.ctx.strokeStyle=this.handleColor,rg2.ctx.fillStyle=this.handleColour,rg2.ctx.globalAlpha=1,rg2.ctx.beginPath(),rg2.ctx.arc(this.handleX,this.handleY,this.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),rg2.ctx.fill(),rg2.ctx.beginPath(),rg2.ctx.arc(this.handleX,this.handleY,2*this.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),rg2.ctx.stroke()))},adjustControls:function(a,b,c,d){var e,f,g,h,i;if(this.backgroundLocked)rg2.ctx.translate(c-a,d-b);else if(null!==this.handleX){var j=(c-this.handleX)/(a-this.handleX),k=(d-this.handleY)/(b-this.handleY);for(e=0;e<this.newcontrols.controls.length;e+=1)f=this.newcontrols.controls[e].oldX-this.handleX,g=this.newcontrols.controls[e].oldY-this.handleY,this.newcontrols.controls[e].x=f*j+this.handleX,this.newcontrols.controls[e].y=g*k+this.handleY}else for(h=c-a,i=d-b,e=0;e<this.newcontrols.controls.length;e+=1)this.newcontrols.controls[e].x=this.newcontrols.controls[e].oldX+h,this.newcontrols.controls[e].y=this.newcontrols.controls[e].oldY+i},dragEnded:function(){var a;if(this.mapLoaded&&this.newcontrols.controls.length>0){for(a=0;a<this.newcontrols.controls.length;a+=1)this.newcontrols.controls[a].oldX=this.newcontrols.controls[a].x,this.newcontrols.controls[a].oldY=this.newcontrols.controls[a].y;rg2.redraw(!1)}},mouseUp:function(a,b){this.mapLoaded&&this.newcontrols.controls.length>0&&(null===this.handleX?(this.handleX=a,this.handleY=b):(this.handleX=null,this.handleY=null))},toggleMoveAll:function(a){this.backgroundLocked=a}},function(){for(var a,b=function(){},c=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"],d=c.length,e=window.console=window.console||{};d;)d-=1,a=c[d],e[a]||(e[a]=b)}(),Colours.prototype={Constructor:Colours,getNextColour:function(){return this.colourIndex+=1,this.colourIndex===this.colours.length&&(this.colourIndex=0),this.colours[this.colourIndex]}},Number.prototype.toRad=function(){return this*Math.PI/180},Results.prototype={Constructor:Results,addResults:function(a,b){for(var c=0;c<a.length;c+=1){var d=new Result(a[c],b,this.colours.getNextColour());this.results.push(d)}},getResultsByCourseID:function(a){for(var b=0,c=0;c<this.results.length;c+=1)this.results[c].courseid===a&&(b+=1);return b},getTotalResults:function(){return this.results.length},getCourseID:function(a){return this.results[a].courseid},getFullResult:function(a){return this.results[a]},getKartatResultID:function(a){return this.results[a].resultid},drawTracks:function(){for(var a=0;a<this.results.length;a+=1)this.results[a].drawTrack()},updateTrackNames:function(){$("#rg2-track-names").empty();var a=this.getDisplayedTrackNames();""!==a?($("#rg2-track-names").append(a),$("#rg2-track-names").show()):$("#rg2-track-names").hide()},putOneTrackOnDisplay:function(a){this.results[a].putTrackOnDisplay(),this.updateTrackNames()},removeOneTrackFromDisplay:function(a){this.results[a].removeTrackFromDisplay(),this.updateTrackNames()},putTracksOnDisplay:function(a){for(var b=0;b<this.results.length;b+=1)this.results[b].courseid==a&&this.results[b].putTrackOnDisplay();this.updateTrackNames()},putAllTracksOnDisplay:function(){for(var a=0;a<this.results.length;a+=1)this.results[a].putTrackOnDisplay();this.updateTrackNames()},getDisplayedTrackNames:function(){for(var a="",b=0;b<this.results.length;b+=1)this.results[b].displayTrack&&(a+="<p style='color:"+this.results[b].trackColour+";'>"+rg2.getCourseName(this.results[b].courseid),a+=": "+this.results[b].name+"</p>");return a},resultIDExists:function(a){for(var b=0;b<this.results.length;b+=1)if(a===this.results[b].resultid)return!0;return!1},getSplitsForID:function(a){for(var b=0;b<this.results.length;b+=1)if(a===this.results[b].resultid)return this.results[b].splits;return rg2.config.SPLITS_NOT_FOUND},getTimeForID:function(a){for(var b=0;b<this.results.length;b+=1)if(a===this.results[b].resultid)return this.results[b].time;return rg2.config.TIME_NOT_FOUND},removeAllTracksFromDisplay:function(){for(var a=0;a<this.results.length;a+=1)this.results[a].removeTrackFromDisplay();
this.updateTrackNames()},removeTracksFromDisplay:function(a){for(var b=0;b<this.results.length;b+=1)this.results[b].courseid==a&&this.results[b].removeTrackFromDisplay();this.updateTrackNames()},addTracks:function(a){for(var b,c,d=0;d<a.length;d+=1)if(b=a[d].resultid,c=0,b<rg2.config.GPS_RESULT_OFFSET)for(;c<this.results.length;){if(b==this.results[c].resultid){this.results[c].addTrack(a[d].coords)&&rg2.incrementTracksCount(this.results[c].courseid);break}c+=1}},deleteAllResults:function(){this.results.length=0},getRunnerName:function(a){return this.results[a].name},sortByCourseIDThenResultID:function(a,b){return a.courseid>b.courseid?1:b.courseid>a.courseid?-1:a.resultid-b.resultid},formatResultListAsAccordion:function(){this.results.sort(this.sortByCourseIDThenResultID);for(var a,b="",c=!0,d=0,e=0;e<this.results.length;e+=1)a=this.results[e],a.courseid!=d&&(c?c=!1:b+="</table></div>",b+="<h3>"+a.coursename,b+="<input class='showcourse' id="+a.courseid+" type=checkbox name=course title='Show course'></input></h3><div>",b+="<table class='resulttable'><tr><th>Name</th><th>Time</th><th>Track</th><th>Replay</th></tr>",d=a.courseid),b+=""!==a.comments?"<tr><td><a href='#' title='"+a.comments+"'>"+a.name+"</a></td><td>"+a.time+"</td>":"<tr><td>"+a.name+"</td><td>"+a.time+"</td>",b+=a.hasValidTrack?"<td><input class='showtrack' id="+e+" type=checkbox name=result></input></td>":"<td></td>",b+="<td><input class='replay' id="+e+" type=checkbox name=replay></input></td></tr>";return""===b?b="<p>No results available.</p>":b+="</table></div></div>",b},createNameDropdown:function(a){$("#rg2-name-select").empty();var b=document.getElementById("rg2-name-select"),c=document.createElement("option");c.value=null,c.text="Select name",b.options.add(c);for(var d=0;d<this.results.length;d+=1)this.results[d].courseid!==a||this.results[d].hasValidTrack||(c=document.createElement("option"),c.value=d,c.text=this.results[d].name,b.options.add(c));b.options.add(c)}},Result.prototype={Constructor:Result,putTrackOnDisplay:function(){this.hasValidTrack&&(this.displayTrack=!0)},removeTrackFromDisplay:function(){this.hasValidTrack&&(this.displayTrack=!1)},drawTrack:function(){if(this.displayTrack){rg2.ctx.lineWidth=2,rg2.ctx.strokeStyle=this.trackColour,rg2.ctx.globalAlpha=1,rg2.ctx.beginPath(),rg2.ctx.moveTo(this.trackx[0],this.tracky[0]);for(var a=1;a<this.trackx.length;a+=1)rg2.ctx.lineTo(this.trackx[a],this.tracky[a]);rg2.ctx.stroke()}},addTrack:function(a){for(var b=a.split("N"),c=0,d=1;d<b.length;d+=1)c=b[d].split(";"),this.trackx.push(parseInt(c[0],10)),this.tracky.push(-1*parseInt(c[1],10));var e;return e=this.isGPSTrack?this.expandGPSTrack():this.expandNormalTrack()},expandNormalTrack:function(){this.xysecs[0]=0,this.cumulativeDistance[0]=0;var a={};this.isScoreEvent?(a.x=this.scorex,a.y=this.scorey):(a.x=rg2.getCourseDetails(this.courseid).x,a.y=rg2.getCourseDetails(this.courseid).y);var b,c=1,d=a.x[c],e=a.y[c],f=0,g=this.trackx[0],h=this.tracky[0],i=0,j=0,k=0,l=0,m=0,n=0,o=0;for(b=1;b<this.trackx.length;b+=1)if(i=this.trackx[b],j=this.tracky[b],f+=Math.sqrt((i-g)*(i-g)+(j-h)*(j-h)),this.cumulativeDistance[b]=Math.round(f),g=i,h=j,d==i&&e==j){this.xysecs[b]=parseInt(this.splits[c],10),n=this.xysecs[o],k=this.xysecs[b]-n,m=this.cumulativeDistance[o],l=this.cumulativeDistance[b]-m;for(var p=o;b>=p;p+=1)this.xysecs[p]=n+Math.round((this.cumulativeDistance[p]-m)*k/l);if(o=b,c+=1,c===a.x.length){this.hasValidTrack=!0;break}d=a.x[c],e=a.y[c]}return this.isScoreEvent&&(this.hasValidTrack=!0),this.hasValidTrack},expandGPSTrack:function(){var a,b=0,c=this.trackx[0],d=this.tracky[0],e=0,f=0;for(a=0;a<this.trackx.length;a+=1)this.xysecs[a]=3*a,e=this.trackx[a],f=this.tracky[a],b+=Math.sqrt((e-c)*(e-c)+(f-d)*(f-d)),this.cumulativeDistance[a]=Math.round(b),c=e,d=f;return this.hasValidTrack=!0,this.hasValidTrack},getCourseName:function(){return""!==this.coursename?this.coursename:"GPS tracks"},getRunnerName:function(){return this.name},getTime:function(){return this.time}};