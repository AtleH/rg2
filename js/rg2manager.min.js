// Version 1.0.4 2015-02-19T19:20:37;
!function(){function a(a){this.x="",this.y=a,this.name=null,this.pwd=null}function b(a){this.DO_NOT_SAVE_COURSE=9999,this.INVALID_MAP_ID=9999,this.FORMAT_NORMAL=1,this.FORMAT_NO_RESULTS=2,this.FORMAT_SCORE_EVENT=3,this.loggedIn=!1,this.user=new rg2.User(a),this.newMap=new rg2.Map,this.eventName=null,this.eventDate=null,this.eventLevel=null,this.mapIndex=this.INVALID_MAP_ID,this.club=null,this.comments=null,this.format=this.FORMAT_NORMAL,this.newcontrols=new rg2.Controls,this.courses=[],this.mapLoaded=!1,this.coursesGeoreferenced=!1,this.drawingCourses=!1,this.drawnCourse={},this.results=[],this.variants=[],this.resultCourses=[],this.mapWidth=0,this.mapHeight=0,this.mapFile=void 0,this.resultsFileFormat="",this.backgroundLocked=!1,this.handleX=null,this.handleY=null,this.maps=[],this.localworldfile=new rg2.Worldfile(0,0,0,0,0,0),this.worldfile=new rg2.Worldfile(0,0,0,0,0,0),this.HANDLE_DOT_RADIUS=10,this.handleColor="#ff0000",$("#btn-login").button(),this.georefsystems=[],this.DO_NOT_GEOREF="none",this.georefsystems.push(new rg2.Georef("Not georeferenced",this.DO_NOT_GEOREF,"")),this.georefsystems.push(new rg2.Georef("GB National Grid","EPSG:27700","+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs")),this.georefsystems.push(new rg2.Georef("Google EPSG:900913","EPSG:900913","+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs")),void 0!==rg2Config.epsg_code?(this.georefsystems.push(new rg2.Georef(rg2Config.epsg_code,rg2Config.epsg_code.replace(" ",""),rg2Config.epsg_params)),this.defaultGeorefVal=rg2Config.epsg_code.replace(" ","")):this.defaultGeorefVal="EPSG:27700",$("rg2-manager-courses").hide(),$("rg2-manager-results").hide();var b=this;$("#rg2-manager-login-form").submit(function(){return b.user.name=$("#rg2-user-name").val(),b.user.pwd=$("#rg2-password").val(),b.user.name.length>4&&b.user.pwd.length>4?b.logIn():rg2.utils.showWarningDialog("Login failed","Please enter user name and password of at least five characters"),!1}),$("#rg2-new-event-details-form").submit(function(){console.log("Form submitted")})}b.prototype={Constructor:b,encodeUser:function(){var a={};return a.x=this.alterString(this.user.name+this.user.pwd,this.user.y),a.y=this.user.y,a},alterString:function(a,b){var c,d;for(d="",c=0;c<a.length;c+=1)d+=a.charAt(c)+b.charAt(c);return d},logIn:function(){var a,b,c,d;return a=rg2Config.json_url+"?type=login",b=this.encodeUser(),c=JSON.stringify(b),d=this,$.ajax({type:"POST",dataType:"json",data:c,url:a,cache:!1,success:function(a){d.user.y=a.keksi,a.ok?d.enableEventEdit():rg2.utils.showWarningDialog("Login failed","Login failed. Please try again.")},error:function(a,b,c){console.log(c),rg2.utils.showWarningDialog("Login failed","User name or password incorrect. Please try again.")}}),!1},enableEventEdit:function(){var a=this;this.loggedIn=!0,this.getMaps(),this.setButtons(),this.createEventLevelDropdown("rg2-event-level"),$("#rg2-event-level").change(function(){a.eventLevel=$("#rg2-event-level").val(),"X"!==a.eventLevel?$("#rg2-select-event-level").addClass("valid"):$("#rg2-select-event-level").removeClass("valid")}),$("#rg2-map-selected").change(function(){a.mapIndex=parseInt($("#rg2-map-selected").val(),10),a.mapIndex!==a.INVALID_MAP_ID?($("#rg2-manager-map-select").addClass("valid"),rg2.loadNewMap(rg2Config.maps_url+"/"+a.maps[a.mapIndex].mapfilename)):($("#rg2-manager-map-select").removeClass("valid"),a.mapLoaded=!1,a.mapWidth=0,a.mapHeight=0)}),rg2.events.createEventEditDropdown(),$("#rg2-event-comments").focus(function(){var a=$("#rg2-event-comments").val();a===rg2.config.DEFAULT_EVENT_COMMENT&&$("#rg2-event-comments").val("")}),$("#rg2-event-date").datepicker({dateFormat:"yy-mm-dd",onSelect:function(b){a.setDate(b)}}),this.createEventLevelDropdown("rg2-event-level-edit"),this.createGeorefDropdown(),$("#rg2-event-date-edit").datepicker({dateFormat:"yy-mm-dd"}),$("#rg2-event-name").on("change",function(){a.setEventName()}),$("#rg2-map-name").on("change",function(){a.setMapName()}),$("#rg2-club-name").on("change",function(){a.setClub()}),$("#rg2-new-course-name").on("change",function(){a.setCourseName()}),$("#rg2-manager-event-select").change(function(){a.setEvent(parseInt($("#rg2-event-selected").val(),10))}),$("#rg2-georef-type").change(function(){a.setGeoref($("#rg2-georef-selected").val())}),$("#rg2-load-map-file").button().change(function(b){a.readMapFile(b)}),$("#rg2-load-georef-file").button().change(function(b){a.readGeorefFile(b)}),$("#rg2-load-results-file").button().change(function(b){a.readResults(b)}),$("#rg2-load-course-file").button().change(function(b){a.readCourses(b)}),this.setUIVisibility(),$("#rg2-info-panel").tabs("option","active",rg2.config.TAB_CREATE)},setUIVisibility:function(){$("#rg2-draw-courses").hide(),$("#rg2-manage-create").show(),$("#rg2-create-tab").show(),$("#rg2-edit-tab").show(),$("#rg2-map-tab").show(),$("#rg2-manage-login").hide(),$("#rg2-login-tab").hide(),$("#rg2-temp-hide-course-delete").hide(),$("#rg2-results-grouping").hide()},setButtons:function(){var a=this;$("#btn-create-event").button().click(function(){a.confirmCreateEvent()}).button("enable"),$("#btn-update-event").button().click(function(){a.confirmUpdateEvent()}).button("disable"),$("#btn-delete-route").button().click(function(){a.confirmDeleteRoute()}).button("disable"),$("#btn-delete-event").button().click(function(){a.confirmDeleteEvent()}).button("disable"),$("#btn-add-map").button().click(function(){a.confirmAddMap()}).button("disable"),$("#btn-draw-courses").button().click(function(){a.mapLoaded?(a.drawingCourses=!0,a.courses.length=0,a.newcontrols.deleteAllControls(),a.drawnCourse.name="Course",a.drawnCourse.x=[],a.drawnCourse.y=[],a.drawnCourse.codes=[],$("#rg2-new-course-name").val("Course"),$("#rg2-draw-courses").show()):rg2.utils.showWarningDialog("No map selected","Please load a map before drawing courses")}),$("#btn-move-map-and-controls").click(function(b){a.toggleMoveAll(b.target.checked)}),$("#btn-no-results").click(function(b){a.toggleResultsRequired(b.target.checked)})},getMaps:function(){var a,b;b=this,$.getJSON(rg2Config.json_url,{type:"maps",cache:!1}).done(function(c){for(b.maps.length=0,console.log("Maps: "+c.data.maps.length),a=0;a<c.data.maps.length;a+=1)b.maps.push(new rg2.Map(c.data.maps[a]));b.createMapDropdown(),$("#btn-toggle-controls").show()}).fail(function(a,b,c){var d;$("body").css("cursor","auto"),d=b+", "+c,console.log("Map request failed: "+d)})},setGeoref:function(a){null!==a&&this.convertWorldFile(a)},setEvent:function(a){var b;a?(b=rg2.events.getEventInfo(a),rg2.loadEvent(b.id)):($("#btn-delete-event").button("disable"),$("#btn-update-event").button("disable"),$("#btn-delete-route").button("disable"),$("#rg2-event-name-edit").val(""),$("#rg2-club-name-edit").val(""),$("#rg2-event-date-edit").val(""),$("#rg2-event-level-edit").val(""),$("#rg2-edit-event-comments").val(""),$("#rg2-route-selected").empty())},eventListLoaded:function(){rg2.events.createEventEditDropdown()},eventFinishedLoading:function(){var a,b;a=parseInt($("#rg2-event-selected").val(),10),b=rg2.events.getEventInfo(a),$("#rg2-event-name-edit").empty().val(b.name),$("#rg2-club-name-edit").empty().val(b.club),$("#rg2-event-date-edit").empty().val(b.date),$("#rg2-event-level-edit").val(b.rawtype),$("#rg2-edit-event-comments").empty().val(b.comment),$("#btn-delete-event").button("enable"),$("#btn-update-event").button("enable"),$("#btn-delete-route").button("enable"),this.createCourseDeleteDropdown(b.id),this.createRouteDeleteDropdown(b.id)},createMapDropdown:function(){var a,b,c,d;for($("#rg2-map-selected").empty(),a=document.getElementById("rg2-map-selected"),c=document.createElement("option"),c.value=this.INVALID_MAP_ID,c.text="Select map",a.options.add(c),d=this.maps.length-1,b=d;b>-1;b-=1)c=document.createElement("option"),c.value=b,c.text=this.maps[b].mapid+": "+this.maps[b].name,a.options.add(c)},createGeorefDropdown:function(){var a,b,c;for($("#rg2-georef-selected").empty(),a=document.getElementById("rg2-georef-selected"),b=0;b<this.georefsystems.length;b+=1)c=document.createElement("option"),c.value=this.georefsystems[b].name,c.text=this.georefsystems[b].description,a.options.add(c)},createCourseDeleteDropdown:function(a){var b,c,d,e;for($("#rg2-course-selected").empty(),b=document.getElementById("rg2-course-selected"),e=rg2.courses.getCoursesForEvent(a),c=0;c<e.length;c+=1)d=document.createElement("option"),d.value=e[c].id,d.text=e[c].name,b.options.add(d)},createRouteDeleteDropdown:function(a){var b,c,d,e;for($("#rg2-route-selected").empty(),b=document.getElementById("rg2-route-selected"),c=rg2.results.getRoutesForEvent(a),d=0;d<c.length;d+=1)e=document.createElement("option"),e.value=c[d].resultid,e.text=c[d].resultid+": "+c[d].name+" on "+c[d].coursename,b.options.add(e)},getCoursesFromResults:function(){var a,b,c,d;for(this.resultCourses=[],a=0;a<this.results.length;a+=1){for(d=-1,b=0;b<this.resultCourses.length;b+=1)if(this.resultCourses[b].course===this.results[a].course){d=b;break}-1===d&&(c={},c.course=this.results[a].course,c.courseid=this.DO_NOT_SAVE_COURSE,this.resultCourses.push(c))}},displayCourseAllocations:function(){var a,b;if(this.courses.length&&this.resultCourses.length){for(b="<div id='rg2-course-allocations'><table><thead><tr><th>Course file</th><th>Results</th></tr></thead><tbody>",a=0;a<this.courses.length;a+=1)b+="<tr><td>"+this.courses[a].name+"</td><td>"+this.createCourseDropdown(this.courses[a].name,a)+"</td></tr>";b+="</tbody></table></div>",$("#rg2-course-allocations").empty().append(b)}},validateData:function(){return this.eventName?this.mapIndex===this.INVALID_MAP_ID?"No map selected.":this.club?this.eventDate?this.eventLevel?this.format?0!==this.courses.length||this.drawingCourses?0===this.results.length&&this.format!==this.FORMAT_NO_RESULTS?"No results information. Check your results file.":"OK":"No course information. Check your course XML file.":"Event format is not valid.":"Event level is not valid.":"Event date is not valid.":"Club name is not valid.":"Event name is not valid."},confirmCreateEvent:function(){var a,b,c;return a=this.validateData(),"OK"!==a?void rg2.utils.showWarningDialog("Data missing",a+" Please enter all necessary information before creating the event."):(b="<div id='event-create-dialog'>Are you sure you want to create this event?</div>",c=this,void $(b).dialog({title:"Confirm event creation",modal:!0,dialogClass:"no-close rg2-confirm-create-event-dialog",closeOnEscape:!1,buttons:[{text:"Cancel",click:function(){c.doCancelCreateEvent()}},{text:"Create event",click:function(){c.doCreateEvent()}}]}))},doCancelCreateEvent:function(){$("#event-create-dialog").dialog("destroy")},doCreateEvent:function(){var a,b,c,d,e,f;$("#event-create-dialog").dialog("destroy"),a=rg2Config.json_url+"?type=createevent",b={},b.name=this.eventName,b.mapid=this.maps[this.mapIndex].mapid,b.eventdate=this.eventDate,f=$("#rg2-event-comments").val(),b.comments=f===rg2.config.DEFAULT_EVENT_COMMENT?"":f,b.club=this.club,b.format=this.format,$("#btn-score-event").prop("checked")&&(b.format=this.FORMAT_SCORE_EVENT),b.level=this.eventLevel,this.drawingCourses&&this.courses.push(this.drawnCourse),this.setControlLocations(),this.mapResultsToCourses(),this.renumberResults(),b.format===this.FORMAT_SCORE_EVENT&&(this.extractVariants(),b.variants=this.variants.slice(0)),b.courses=this.courses.slice(0),b.results=this.results.slice(0),c=this.encodeUser(),b.x=c.x,b.y=c.y,d=JSON.stringify(b),e=this,$.ajax({data:d,type:"POST",url:a,dataType:"json",success:function(a){e.user.y=a.keksi,a.ok?rg2.utils.showWarningDialog("Event created",e.eventName+" has been added with id "+a.newid+"."):rg2.utils.showWarningDialog("Save failed",a.status_msg+" Failed to create event. Please try again.")},error:function(){rg2.utils.showWarningDialog("Save failed"," Failed to create event.")}})},renumberResults:function(){var a,b,c;for(c=[],a=0;a<this.results.length;a+=1)b=this.getCourseIDForResult(this.results[a].course),b!==this.DO_NOT_SAVE_COURSE&&(this.results[a].courseid=b,this.results[a].variantid="",c.push(this.results[a]));this.results=c},mapResultsToCourses:function(){var a,b,c,d,e;for(d=[],e=1,a=0;a<this.courses.length;a+=1)b="#rg2-alloc-"+a,c=parseInt($(b).val(),10),c!==this.DO_NOT_SAVE_COURSE&&(this.courses[a].courseid=e,this.resultCourses.length>0&&(this.resultCourses[c].courseid=e,this.courses[a].course=this.resultCourses[c].course,this.courses[a].name=this.resultCourses[c].course),d.push(this.courses[a]),e+=1);this.courses=d},extractVariants:function(){var a,b,c,d;for(this.variants.length=0,a=0;a<this.results.length;a+=1){for(c=this.results[a].codes,b=0;b<this.courses.length;b+=1)if(this.courses[b].courseid===this.results[a].courseid){d=this.courses[b];break}c.unshift(d.codes[0]),c.push(d.codes[d.codes.length-1]),this.results[a].variantid=this.getVariantID(this.results[a].codes,this.results[a].courseid)}},getVariantID:function(a,b){var c,d,e,f,g,h,i,j;for(f=[],g=[],h={},j=0,c=0;c<this.variants.length;c+=1)if(this.variants[c].codes.length===a.length){for(i=!0,d=0;d<a.length;d+=1)if(this.variants[c].codes[d]!==a[d]){i=!1;break}if(i){j=c+1;break}}if(0===j){for(j=this.variants.length+1,h.codes=a,c=0;c<a.length;c+=1)e=this.getControlXY(a[c]),f.push(e.x),g.push(e.y);h.x=f,h.y=g,h.id=j,h.courseid=b,h.name="Variant "+j,this.variants.push(h)}return j},getCourseIDForResult:function(a){var b;for(b=0;b<this.resultCourses.length;b+=1)if(this.resultCourses[b].course===a)return this.resultCourses[b].courseid;return 0},setControlLocations:function(){var a,b,c;for(a=0;a<this.courses.length;a+=1)for(b=0;b<this.courses[a].codes.length;b+=1)c=this.getControlXY(this.courses[a].codes[b]),this.courses[a].x[b]=c.x,this.courses[a].y[b]=c.y},getControlXY:function(a){var b,c;for(c={},c.x=0,c.y=0,b=0;b<this.newcontrols.controls.length;b+=1)if(this.newcontrols.controls[b].code===a)return c.x=Math.round(this.newcontrols.controls[b].x),c.y=Math.round(this.newcontrols.controls[b].y),c;return c},confirmUpdateEvent:function(){var a=this;$("<div id='event-update-dialog'>Are you sure you want to update this event?</div>").dialog({title:"Confirm event update",modal:!0,dialogClass:"no-close rg2-confirm-update-dialog",closeOnEscape:!1,buttons:[{text:"Cancel",click:function(){a.doCancelUpdateEvent()}},{text:"Update event",click:function(){a.doUpdateEvent()}}]})},doCancelUpdateEvent:function(){$("#event-update-dialog").dialog("destroy")},doUpdateEvent:function(){var a,b,c,d,e,f;$("#event-update-dialog").dialog("destroy"),a=$("#rg2-event-selected").val(),b=rg2Config.json_url+"?type=editevent&id="+a,c={},c.comments=$("#rg2-edit-event-comments").val(),c.name=$("#rg2-event-name-edit").val(),c.type=$("#rg2-event-level-edit").val(),c.eventdate=$("#rg2-event-date-edit").val(),c.club=$("#rg2-club-name-edit").val(),f=this.encodeUser(),c.x=f.x,c.y=f.y,d=JSON.stringify(c),e=this,$.ajax({data:d,type:"POST",url:b,dataType:"json",success:function(b){e.user.y=b.keksi,b.ok?rg2.utils.showWarningDialog("Event updated","Event "+a+" has been updated."):rg2.utils.showWarningDialog("Update failed",b.status_msg+". Event update failed. Please try again.")},error:function(a,b){rg2.utils.showWarningDialog("Update failed",b+". Event update failed.")}})},confirmDeleteRoute:function(){var a=this;$("<div id='route-delete-dialog'>This route will be permanently deleted. Are you sure?</div>").dialog({title:"Confirm route delete",modal:!0,dialogClass:"no-close rg2-confirm-route-delete-dialog",closeOnEscape:!1,buttons:[{text:"Cancel",click:function(){a.doCancelDeleteRoute()}},{text:"Delete route",click:function(){a.doDeleteRoute()}}]})},doCancelDeleteRoute:function(){$("#route-delete-dialog").dialog("destroy")},doDeleteRoute:function(){var a,b,c,d,e,f;$("#route-delete-dialog").dialog("destroy"),a=$("#rg2-event-selected").val(),c=$("#rg2-route-selected").val(),b=rg2Config.json_url+"?type=deleteroute&id="+a+"&routeid="+c,f=this.encodeUser(),d=JSON.stringify(f),e=this,$.ajax({data:d,type:"POST",url:b,dataType:"json",success:function(a){e.user.y=a.keksi,a.ok?rg2.utils.showWarningDialog("Route deleted","Route "+c+" has been deleted."):rg2.utils.showWarningDialog("Delete failed",a.status_msg+". Delete failed. Please try again.")},error:function(a,b){rg2.utils.showWarningDialog("Delete failed",b+". Delete failed.")}})},confirmDeleteEvent:function(){var a=this;$("<div id='event-delete-dialog'>This event will be deleted. Are you sure?</div>").dialog({title:"Confirm event delete",modal:!0,dialogClass:"no-close rg2-confirm-delete-event-dialog",closeOnEscape:!1,buttons:[{text:"Cancel",click:function(){a.doCancelDeleteEvent()}},{text:"Delete event",click:function(){a.doDeleteEvent()}}]})},doCancelDeleteEvent:function(){$("#event-delete-dialog").dialog("destroy")},doDeleteEvent:function(){var a,b,c,d,e;$("#event-delete-dialog").dialog("destroy"),a=$("#rg2-event-selected").val(),b=rg2Config.json_url+"?type=deleteevent&id="+a,c=this.encodeUser(),d=JSON.stringify(c),e=this,$.ajax({data:d,type:"POST",url:b,dataType:"json",success:function(b){e.user.y=b.keksi,b.ok?(rg2.utils.showWarningDialog("Event deleted","Event "+a+" has been deleted."),rg2.loadEventList(),e.setEvent(),$("#rg2-event-selected").empty()):rg2.utils.showWarningDialog("Delete failed",b.status_msg+". Event delete failed. Please try again.")},error:function(a,b){rg2.utils.showWarningDialog("Delete failed",b+". Delete failed.")}})},readResults:function(a){var b,c,d;c=new FileReader,d=this,c.onerror=function(){rg2.utils.showWarningDialog("Results file error","The selected results file could not be read.")},c.onload=function(a){switch(d.results.length=0,d.resultsFileFormat){case"CSV":d.processResultsCSV(a),$("#rg2-select-results-file").addClass("valid");break;case"XML":d.processResultsXML(a),$("#rg2-select-results-file").addClass("valid");break;default:return void rg2.utils.showWarningDialog("File type error","Results file type is not recognised. Please select a valid file.")}d.getCoursesFromResults(),d.displayResultInfo(),d.displayCourseAllocations()},b=a.target.files[0].name.substr(-3,3),b=b.toUpperCase(),"XML"===b||"CSV"===b?(this.resultsFileFormat=b,c.readAsText(a.target.files[0])):rg2.utils.showWarningDialog("File type error","Results file type is not recognised. Please select a valid file.")},processResultsCSV:function(a){var b,c,d,e;b=a.target.result.split(/[\r\n|\n]+/),c=b[0].split(",").length-1,d=b[0].split(";").length-1,e=c>d?",":";",2===b[0].split(e).length?this.processSpklasseCSVResults(b,e):this.processSICSVResults(b,e)},processResultsXML:function(a){var b,c,d;c="";try{if(b=$.parseXML(a.target.result),d=b.getElementsByTagName("ResultList"),0===d.length)return void rg2.utils.showWarningDialog("XML file error","File is not a valid XML results file. ResultList element missing.");d=b.getElementsByTagName("IOFVersion"),d.length>0&&(c=d[0].getAttribute("version")),""===c&&(d=b.getElementsByTagName("ResultList"),d.length>0&&(c=d[0].getAttribute("iofVersion")))}catch(e){return void rg2.utils.showWarningDialog("XML file error","File is not a valid XML results file.")}switch(c){case"2.0.3":this.processIOFV2XMLResults(b);break;case"3.0":this.processIOFV3XMLResults(b);break;default:rg2.utils.showWarningDialog("XML file error","Invalid IOF file format. Version "+c+" not supported.")}},processIOFV2XMLResults:function(a){var b,c,d,e,f,g,h,i;try{for(b=a.getElementsByTagName("ClassResult"),e=0;e<b.length;e+=1)for(h=b[e].getElementsByTagName("ClassShortName")[0].textContent,c=b[e].getElementsByTagName("PersonResult"),f=0;f<c.length&&(g={},g.course=h,i=c[f].getElementsByTagName("Given")[0].textContent+" "+c[f].getElementsByTagName("Family")[0].textContent,g.name=i.replace(/[\n\r]/g,"").trim(),i=c[f].getElementsByTagName("PersonId")[0].textContent,i=i.replace(/[\n\r]/g,"").trim(),g.dbid=i?i:g.name,i=c[f].getElementsByTagName("ShortName"),g.club=i.length>0?i[0].textContent.trim():"",d=c[f].getElementsByTagName("Result"),this.extractIOFV2XMLResults(d,g),"DidNotStart"!==g.status);f+=1)this.results.push(g)}catch(j){return void rg2.utils.showWarningDialog("XML parse error","Error processing XML file. Error is : "+j.message)}},extractIOFV2XMLResults:function(a,b){var c,d,e,f;for(c=0;c<a.length;c+=1)d=a[c].getElementsByTagName("CompetitorStatus"),b.status=d.length>0?d[0].getAttribute("value"):"",d=a[c].getElementsByTagName("ResultPosition"),b.position=d.length>0?parseInt(d[0].textContent,10):"",d=a[c].getElementsByTagName("CCardId"),b.chipid=d.length>0?d[0].textContent:0,d=a[c].getElementsByTagName("Time"),b.time=d.length>0?d[0].textContent.replace(/[\n\r]/g,""):0,d=a[c].getElementsByTagName("StartTime"),d.length>0?(e=d[0].getElementsByTagName("Clock")[0].textContent,b.starttime=rg2.utils.getSecsFromHHMMSS(e)):b.starttime=0,b.splits="",b.codes=[],f=a[c].getElementsByTagName("SplitTime"),b.controls=f.length,this.extractIOFV2XMLSplits(f,b),d=a[c].getElementsByTagName("FinishTime"),d.length>0?(e=d[0].getElementsByTagName("Clock")[0].textContent,b.splits+=rg2.utils.getSecsFromHHMMSS(e)-b.starttime):b.splits+=0},extractIOFV2XMLSplits:function(a,b){var c,d;for(c=0;c<a.length;c+=1)c>0&&(b.splits+=";"),d=a[c].getElementsByTagName("Time"),d.length>0?(b.splits+=rg2.utils.getSecsFromHHMMSS(d[0].textContent),d=a[c].getElementsByTagName("ControlCode"),b.codes[c]=d.length>0?d[0].textContent:""):(b.splits+=0,b.codes[c]="");b.splits+=";"},processIOFV3XMLResults:function(a){var b,c,d,e,f,g,h,i,j;try{for(b=a.getElementsByTagName("ClassResult"),e=0;e<b.length;e+=1)for(i=b[e].getElementsByTagName("Class"),h=i[0].getElementsByTagName("Name")[0].textContent,c=b[e].getElementsByTagName("PersonResult"),f=0;f<c.length;f+=1)g={},g.course=h,i=c[f].getElementsByTagName("Given")[0].textContent+" "+c[f].getElementsByTagName("Family")[0].textContent,g.name=i.replace(/[\n\r]/g,"").trim(),i=c[f].getElementsByTagName("Id"),i.length>0?(j=i[0].textContent,j.replace(/[\n\r]/g,""),g.dbid=j.trim()+"__"+g.name):g.dbid=this.results.length+"__"+g.name,i=c[f].getElementsByTagName("Organisation"),g.club=i.length>0?i[0].getElementsByTagName("Name")[0].textContent:"",d=c[f].getElementsByTagName("Result"),this.extractIOFV3XMLResults(d,g),this.results.push(g)}catch(k){return void rg2.utils.showWarningDialog("XML parse error","Error processing XML file. Error is : "+k.message)}},extractIOFV3XMLResults:function(a,b){var c,d,e,f,g;for(c=0;c<a.length;c+=1)d=a[c].getElementsByTagName("ControlCard"),b.chipid=d.length>0?d[0].textContent:0,d=a[c].getElementsByTagName("Position"),b.position=d.length>0?d[0].textContent:"",d=a[c].getElementsByTagName("Status"),b.status=d.length>0?d[0].textContent:"",d=a[c].getElementsByTagName("Time"),b.time=d.length>0?rg2.utils.formatSecsAsMMSS(parseInt(d[0].textContent,10)):0,d=a[c].getElementsByTagName("StartTime"),d.length>0?(e=d[0].textContent,b.starttime=e.length>=19?rg2.utils.getSecsFromHHMMSS(e.substr(11,8)):0):b.starttime=0,b.splits="",b.codes=[],g=a[c].getElementsByTagName("SplitTime"),b.controls=g.length,this.extractIOFV3XMLSplits(g,b),d=a[c].getElementsByTagName("FinishTime"),d.length>0?(e=d[0].textContent,f=e.length>=19?rg2.utils.getSecsFromHHMMSS(e.substr(11,8)):0):f=0,b.splits+=f-b.starttime},extractIOFV3XMLSplits:function(a,b){var c,d;for(c=0;c<a.length;c+=1)c>0&&(b.splits+=";"),d=a[c].getElementsByTagName("Time"),b.splits+=d.length>0?d[0].textContent:0,d=a[c].getElementsByTagName("ControlCode"),d.length>0?b.codes[c]=d[0].textContent:b.codes[c]+="X"+c;b.splits+=";"},readCourses:function(a){var b,c;b=new FileReader,b.onerror=function(){rg2.utils.showWarningDialog("Course file error","The selected course file could not be read.")},c=this,b.onload=function(a){c.courses.length=0,c.coursesGeoreferenced=!1,c.backgroundLocked=!1,$("#btn-move-map-and-controls").prop("checked",!1),c.handleX=null,c.handleY=null,c.newcontrols.deleteAllControls(),c.processCoursesXML(a),c.displayCourseInfo(),c.displayCourseAllocations(),c.fitControlsToMap(),rg2.redraw(!1)},b.readAsText(a.target.files[0])},displayCourseInfo:function(){var a=this.getCourseInfoAsHTML();a&&($("#rg2-manage-courses").empty().html(a),$("#rg2-manage-courses").dialog({title:"Course details",dialogClass:"rg2-course-info-dialog",resizable:!0,width:"auto",maxHeight:.9*window.innerHeight,buttons:{Ok:function(){$(this).dialog("close")}}}))},displayResultInfo:function(){var a=this.getResultInfoAsHTML();$("#rg2-manage-results").empty().html(a),a&&$("#rg2-manage-results").dialog({title:"Result details",dialogClass:"rg2-result-info-dialog",resizable:!0,width:"auto",maxHeight:.9*window.innerHeight,buttons:{Ok:function(){$(this).dialog("close")}}})},getCourseInfoAsHTML:function(){var a,b;if(this.courses.length){for(a="<table><thead><tr><th>Course</th><th>Name</th><th>Controls</th></tr></thead><tbody>",b=0;b<this.courses.length;b+=1)a+="<tr><td>"+(b+1)+"</td><td>"+this.courses[b].name+"</td><td>"+(this.courses[b].codes.length-2)+"</td></tr>";a+="</tbody></table>"}else a="";return a},getResultInfoAsHTML:function(){var a,b,c,d;if(this.results.length){for(a="<table><thead><tr><th>Course</th><th>Winner</th><th>Time</th><th>Runners</th></tr></thead><tbody>",c=0,d=null,b=0;b<this.results.length;b+=1)this.results[b].course!==d&&(null!==d&&(a+="<td>"+c+"</td></tr>",c=0),a+="<tr><td>"+this.results[b].course+"</td><td>"+this.results[b].name+"</td><td>"+this.results[b].time+"</td>",d=this.results[b].course),c+=1;a+="<td>"+c+"</td></tr></tbody></table>"}else a="";return a},processCoursesXML:function(a){var b,c,d,e;c="",e="";try{if(b=$.parseXML(a.target.result),d=b.getElementsByTagName("CourseData"),0===d.length)return void rg2.utils.showWarningDialog("XML file error","File is not a valid XML course file. CourseData element missing.");d=b.getElementsByTagName("IOFVersion"),d.length>0&&(c=d[0].getAttribute("version")),""===c&&(d=b.getElementsByTagName("CourseData"),d.length>0&&(c=d[0].getAttribute("iofVersion"),e=d[0].getAttribute("creator")))}catch(f){return void rg2.utils.showWarningDialog("XML file error","File is not a valid XML course file.")}switch(c){case"2.0.3":this.processIOFV2XML(b);break;case"3.0":this.processIOFV3XML(b,e);break;default:rg2.utils.showWarningDialog("XML file error","Invalid IOF file format. Version "+c+" not supported.")}},extractV2Courses:function(a){var b,c,d,e,f,g,h,i;for(b=0;b<a.length;b+=1){for(d={},e=[],f=[],g=[],d.name=a[b].getElementsByTagName("CourseName")[0].textContent.trim(),e.push(a[b].getElementsByTagName("StartPointCode")[0].textContent.trim()),h=a[b].getElementsByTagName("CourseControl"),c=0;c<h.length;c+=1)i=h[c].getElementsByTagName("ControlCode")[0].textContent.trim(),this.validControlCode(i)&&e.push(i);e.push(a[b].getElementsByTagName("FinishPointCode")[0].textContent.trim()),d.codes=e,d.courseid=0,d.x=f,d.y=g,this.courses.push(d)}$("#rg2-select-course-file").addClass("valid")},validControlCode:function(a){var b,c;for(c=this.newcontrols.controls,b=0;b<c.length;b+=1)if(c[b].code===a)return!0;return!1},extractV3Courses:function(a){var b,c,d,e,f,g,h,i;for(b=0;b<a.length;b+=1){for(d={},e=[],f=[],g=[],d.name=a[b].getElementsByTagName("Name")[0].textContent,h=a[b].getElementsByTagName("CourseControl"),c=0;c<h.length;c+=1)i=h[c].getElementsByTagName("Control")[0].textContent,this.validControlCode(i)&&e.push(i.trim());d.codes=e,d.courseid=0,d.x=f,d.y=g,this.courses.push(d)}$("#rg2-select-course-file").addClass("valid")},processIOFV3XML:function(a,b){var c,d,e,f,g,h,i,j,k,l;for(i=!1,b&&b.indexOf("Condes")>-1&&(i=!0),c=a.getElementsByTagName("Control"),d=0;d<c.length;d+=1)"RaceCourseData"===c[d].parentNode.nodeName&&(e=c[d].getElementsByTagName("Id")[0].textContent,j=c[d].getElementsByTagName("Position"),this.localworldfile.valid&&j.length>0?(k=j[0].getAttribute("lat"),l=j[0].getAttribute("lng"),i?(g=this.localworldfile.getX(l,k),h=this.localworldfile.getY(l,k)):(g=this.worldfile.getX(l,k),h=this.worldfile.getY(l,k)),this.coursesGeoreferenced=!0):(f=c[d].getElementsByTagName("MapPosition"),g=f[0].getAttribute("x"),h=f[0].getAttribute("y")),"CrossingPoint"!==c[d].getAttribute("type")&&this.newcontrols.addControl(e.trim(),g,h));c=a.getElementsByTagName("Course"),this.extractV3Courses(c)},processIOFV2XML:function(a){var b,c,d,e,f;if(b=a.getElementsByTagName("StartPoint"),this.extractV2Controls(b,"StartPointCode"),b=a.getElementsByTagName("Control"),this.extractV2Controls(b,"ControlCode"),b=a.getElementsByTagName("FinishPoint"),c=this.extractV2Controls(b,"FinishPointCode"),c&&this.localworldfile.valid){for(d=0;d<this.newcontrols.controls.length;d+=1)e=this.newcontrols.controls[d].x,f=this.newcontrols.controls[d].y,this.newcontrols.controls[d].x=this.localworldfile.getX(e,f),this.newcontrols.controls[d].y=this.localworldfile.getY(e,f);this.coursesGeoreferenced=!0}b=a.getElementsByTagName("Course"),this.extractV2Courses(b)},extractV2Controls:function(a,b){var c,d,e,f,g,h,i;for(i=!1,c=0;c<a.length;c+=1)f=a[c].getElementsByTagName(b)[0].textContent,h=a[c].getElementsByTagName("ControlPosition"),h.length>0&&this.localworldfile.valid?(d=parseFloat(h[0].getAttribute("x")),e=parseFloat(h[0].getAttribute("y")),i=!0):(g=a[c].getElementsByTagName("MapPosition"),d=g[0].getAttribute("x"),e=g[0].getAttribute("y")),this.newcontrols.addControl(f.trim(),d,e);return i},processSpklasseCSVResults:function(a,b){var c,d,e,f,g,h,i,j,k=0,l=1,m=0,n=1,o=2,p=3,q=4;g=[];try{for(c="",d=0,e=0;e<a.length;e+=1)if(g=a[e].split(b),g.length>0)if(2===g.length)c=g[k],d=parseInt(g[l],10);else{for(h={},h.chipid=0,h.name=(g[m]+" "+g[n]+" "+g[o]).trim(),h.dbid=h.chipid+"__"+h.name,h.starttime=rg2.utils.getSecsFromHHMM(g[p]),h.club=g[o],h.course=c,h.controls=d,h.splits="",h.codes=[],i=g.length-q,j=0,f=0;i>f;f+=1)f>0&&(h.splits+=";"),h.codes[f]="X",j+=rg2.utils.getSecsFromHHMMSS(g[f+q]),h.splits+=j;h.time=rg2.utils.formatSecsAsMMSS(j),this.results.push(h)}}catch(r){rg2.utils.showWarningDialog("Spklasse csv file contains invalid information")}},processSICSVResults:function(a,b){var c,d,e,f,g,h,i;for(h=this.getCSVFormat(a[0],b),c=1;c<a.length;c+=1)if(e=a[c].split(b),e.length>=h.FIRST_SPLIT_IDX){for(i={},i.chipid=e[h.CHIP_IDX],i.name=(e[h.FIRST_NAME_IDX]+" "+e[h.SURNAME_IDX]).trim().replace(/\"/g,""),i.dbid=(e[h.DB_IDX]+"__"+i.name).replace(/\"/g,""),i.starttime=rg2.utils.getSecsFromHHMMSS(e[h.START_TIME_IDX]),i.time=e[h.TOTAL_TIME_IDX],i.position=parseInt(e[h.POSITION_IDX],10),isNaN(i.position)&&(i.position=""),i.status=this.getSICSVStatus(e[h.NC_IDX],e[h.CLASSIFIER_IDX]),i.club=e[h.CLUB_IDX].trim().replace(/\"/g,""),i.course=e[h.COURSE_IDX],i.controls=parseInt(e[h.NUM_CONTROLS_IDX],10),f=h.FIRST_SPLIT_IDX,g=h.FIRST_CODE_IDX,i.splits="",i.codes=[],d=0;d<i.controls;d+=1)e[g]&&(d>0&&(i.splits+=";"),i.codes[d]=e[g],i.splits+=rg2.utils.getSecsFromHHMMSS(e[f])),f+=h.STEP,g+=h.STEP;i.splits+=";",i.splits+=rg2.utils.getSecsFromHHMMSS(i.time),this.results.push(i)}},getCSVFormat:function(a,b){var c,d,e,f,g,h,i;for(c={},d=["SI card","Database Id","Surname","First name","nc","Start","Time","Classifier","City","Short","Course","Course controls","Pl","Start punch","Control1","Punch1","Control2"],e=[],f=a.split(b),g=0;g<d.length;g+=1){for(i=!1,h=0;h<f.length;h+=1){if(f[h]===d[g]){e[g]=h,i=!0;break}if("SI card"===d[g]&&"Chipno"===f[h]){e[g]=h,i=!0;break}if("Pl"===d[g]&&"Place"===f[h]){e[g]=h,i=!0;break}}if(!i)break}return i?(c.CHIP_IDX=e[0],c.DB_IDX=e[1],c.SURNAME_IDX=e[2],c.FIRST_NAME_IDX=e[3],c.NC_IDX=e[4],c.START_TIME_IDX=e[5],c.TOTAL_TIME_IDX=e[6],c.CLASSIFIER_IDX=e[7],c.CLUB_IDX=e[8],c.CLASS_IDX=e[9],c.COURSE_IDX=e[10],c.NUM_CONTROLS_IDX=e[11],c.POSITION_IDX=e[12],c.START_PUNCH_IDX=e[13],c.FIRST_CODE_IDX=e[14],c.FIRST_SPLIT_IDX=e[15],c.STEP=e[16]-e[14]):(c.CHIP_IDX=1,c.DB_IDX=2,c.SURNAME_IDX=3,c.FIRST_NAME_IDX=4,c.NC_IDX=8,c.START_TIME_IDX=9,c.TOTAL_TIME_IDX=11,c.CLASSIFIER_IDX=12,c.CLUB_IDX=15,c.CLASS_IDX=18,c.COURSE_IDX=39,c.NUM_CONTROLS_IDX=42,c.POSITION_IDX=43,c.START_PUNCH_IDX=44,c.FIRST_SPLIT_IDX=47,c.STEP=2,c.FIRST_CODE_IDX=46),c},getSICSVStatus:function(a,b){return"0"===a||""===a||"N"===a?""===b||"0"===b?"ok":"nok":"nc"
},readMapFile:function(a){var b,c,d;b=new FileReader,c=this,b.onload=function(a){c.processMap(a)},d=a.target.files[0].name.substr(-3,3),d=d.toUpperCase(),"JPG"===d||"GIF"===d?(this.mapFile=a.target.files[0],b.readAsDataURL(a.target.files[0])):rg2.utils.showWarningDialog("File type error",a.target.files[0].name+" is not recognised. Only .jpg and .gif files are supported at present.")},mapLoadCallback:function(){var a;this.mapLoaded=!0,this.mapIndex!==this.INVALID_MAP_ID&&(this.localworldfile=this.maps[this.mapIndex].localworldfile,this.worldfile=this.maps[this.mapIndex].worldfile),a=rg2.getMapSize(),this.mapWidth=a.width,this.mapHeight=a.height,this.fitControlsToMap(),rg2.redraw(!1)},processMap:function(a){var b;rg2.loadNewMap(a.target.result),$("#rg2-select-map-file").addClass("valid"),this.mapLoaded=!0,b=rg2.getMapSize(),this.mapWidth=b.width,this.mapHeight=b.height,this.fitControlsToMap(),rg2.redraw(!1),$("#btn-add-map").button("enable")},fitControlsToMap:function(){var a,b,c,d,e,f,g,h,i;if(b=!1,this.mapLoaded&&this.newcontrols.controls.length>0){for(c=this.newcontrols.controls[0].x,d=this.newcontrols.controls[0].x,e=this.newcontrols.controls[0].y,f=this.newcontrols.controls[0].y,a=1;a<this.newcontrols.controls.length;a+=1)d=Math.max(d,this.newcontrols.controls[a].x),f=Math.max(f,this.newcontrols.controls[a].y),c=Math.min(c,this.newcontrols.controls[a].x),e=Math.min(e,this.newcontrols.controls[a].y);if(this.coursesGeoreferenced&&(0>d||c>this.mapWidth||e>this.mapHeight||0>f?rg2.utils.showWarningDialog("Course file problem","Your course file does not match the map co-ordinates. Please check you have selected the correct file."):b=!0),b)this.backgroundLocked=!0,$("#btn-move-map-and-controls").prop("checked",!0);else for(g=.8,h=d-c,i=f-e,a=0;a<this.newcontrols.controls.length;a+=1)this.newcontrols.controls[a].x=(this.newcontrols.controls[a].x-c)*(this.mapWidth/h)*g+this.mapWidth*(1-g)*.5,this.newcontrols.controls[a].y=this.mapHeight-(this.newcontrols.controls[a].y-e)*(this.mapHeight/i)*g-this.mapHeight*(1-g)*.5;this.copyXYToOldXY(),this.newcontrols.displayAllControls()}},copyXYToOldXY:function(){var a;for(a=0;a<this.newcontrols.controls.length;a+=1)this.newcontrols.controls[a].oldX=this.newcontrols.controls[a].x,this.newcontrols.controls[a].oldY=this.newcontrols.controls[a].y},setClub:function(){this.club=$("#rg2-club-name").val(),this.club?$("#rg2-select-club-name").addClass("valid"):$("#rg2-select-club-name").removeClass("valid")},setEventName:function(){this.eventName=$("#rg2-event-name").val(),this.eventName?$("#rg2-select-event-name").addClass("valid"):$("#rg2-select-event-name").removeClass("valid")},setCourseName:function(){var a=$("#rg2-new-course-name").val();a&&(this.drawnCourse.name=a)},setMapName:function(){this.newMap.name=$("#rg2-map-name").val(),this.newMap.name?$("#rg2-select-map-name").addClass("valid"):$("#rg2-select-map-name").removeClass("valid")},setDate:function(a){this.eventDate=a,this.eventDate?$("#rg2-select-event-date").addClass("valid"):$("#rg2-select-event-date").removeClass("valid")},createEventLevelDropdown:function(a){var b,c,d,e,f;for($("#"+a).empty(),b=document.getElementById(a),c=["Select level","Training","Local","Regional","National","International"],d=["X","T","L","R","N","I"],f=0;f<c.length;f+=1)e=document.createElement("option"),e.value=d[f],e.text=c[f],b.options.add(e)},createCourseDropdown:function(a,b){var c,d,e;for(d=-1,c=0;c<this.resultCourses.length;c+=1)if(this.resultCourses[c].course===a){d=c;break}for(e="<select id='rg2-alloc-"+b+"'><option value="+this.DO_NOT_SAVE_COURSE,-1===d&&(e+=" selected"),e+=">Do not save</option>",c=0;c<this.resultCourses.length;c+=1)e+="<option value="+c,d===c&&(e+=" selected"),e+=">"+this.resultCourses[c].course+"</option>";return e+="</select>"},drawControls:function(){if(this.mapLoaded&&this.newcontrols.controls.length>0){this.newcontrols.drawControls(!0);var a=rg2.getOverprintDetails();null!==this.handleX&&(rg2.ctx.lineWidth=a.overprintWidth,rg2.ctx.strokeStyle=this.handleColor,rg2.ctx.fillStyle=this.handleColour,rg2.ctx.globalAlpha=1,rg2.ctx.beginPath(),rg2.ctx.arc(this.handleX,this.handleY,this.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),rg2.ctx.fill(),rg2.ctx.beginPath(),rg2.ctx.arc(this.handleX,this.handleY,2*this.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),rg2.ctx.stroke())}},adjustControls:function(a,b,c,d,e){var f,g,h,i,j,k,l;if(this.backgroundLocked||e===rg2.config.RIGHT_CLICK)rg2.ctx.translate(c-a,d-b);else if(null!==this.handleX)for(k=(c-this.handleX)/(a-this.handleX),l=(d-this.handleY)/(b-this.handleY),f=0;f<this.newcontrols.controls.length;f+=1)g=this.newcontrols.controls[f].oldX-this.handleX,h=this.newcontrols.controls[f].oldY-this.handleY,this.newcontrols.controls[f].x=g*k+this.handleX,this.newcontrols.controls[f].y=h*l+this.handleY;else for(i=c-a,j=d-b,f=0;f<this.newcontrols.controls.length;f+=1)this.newcontrols.controls[f].x=this.newcontrols.controls[f].oldX+i,this.newcontrols.controls[f].y=this.newcontrols.controls[f].oldY+j},dragEnded:function(){this.mapLoaded&&this.newcontrols.controls.length>0&&this.copyXYToOldXY()},mouseUp:function(a,b){return this.drawingCourses?void this.addNewControl(a,b):void(this.mapLoaded&&this.newcontrols.controls.length>0&&(null===this.handleX?(this.handleX=a,this.handleY=b):(this.handleX=null,this.handleY=null)))},addNewControl:function(a,b){var c;c=0===this.newcontrols.controls.length?"S"+(this.newcontrols.controls.length+1):"X"+(this.newcontrols.controls.length+1),this.newcontrols.addControl(c,a,b),this.newcontrols.displayAllControls(),this.drawnCourse.codes.push(c),this.drawnCourse.x.push(a),this.drawnCourse.y.push(b)},toggleMoveAll:function(a){this.backgroundLocked=a},toggleResultsRequired:function(a){this.format=a?this.FORMAT_NO_RESULTS:this.FORMAT_NORMAL},confirmAddMap:function(){var a,b;a="<div id='add-map-dialog'>Are you sure you want to add this map?</div>",b=this,$(a).dialog({title:"Confirm new map",modal:!0,dialogClass:"no-close rg2-confirm-add-map-dialog",closeOnEscape:!1,buttons:[{text:"Cancel",click:function(){b.doCancelAddMap()}},{text:"Add map",click:function(){b.doUploadMapFile()}}]})},doCancelAddMap:function(){$("#add-map-dialog").dialog("destroy")},doUploadMapFile:function(){var a,b,c,d;$("#add-map-dialog").dialog("destroy"),a=rg2Config.json_url+"?type=uploadmapfile",b=this.encodeUser(),c=this,d=new FormData,d.append(this.mapFile.name,this.mapFile),d.append("name",this.mapFile.name),d.append("x",b.x),d.append("y",b.y),$.ajax({url:a,data:d,type:"POST",mimeType:"multipart/form-data",processData:!1,contentType:!1,dataType:"json",success:function(a){c.user.y=a.keksi,a.ok?c.doAddMap():rg2.utils.showWarningDialog("Save failed",a.status_msg+". Failed to save map. Please try again.")},error:function(a,b){console.log(b)}})},doAddMap:function(){var a,b,c,d,e;a=rg2Config.json_url+"?type=addmap",b={},this.newMap.localworldfile=this.localworldfile,b=this.newMap,c=this.encodeUser(),b.x=c.x,b.y=c.y,d=JSON.stringify(b),e=this,$.ajax({data:d,type:"POST",url:a,dataType:"json",success:function(a){e.user.y=a.keksi,a.ok?(rg2.utils.showWarningDialog("Map added",e.newMap.name+" has been added with id "+a.newid+"."),e.getMaps()):rg2.utils.showWarningDialog("Save failed",a.status_msg+". Failed to save map. Please try again.")},error:function(a,b){console.log(b)}})},readGeorefFile:function(a){var b,c;b=new FileReader,c=this;try{b.readAsText(a.target.files[0])}catch(d){return void rg2.utils.showWarningDialog("File read error","Failed to open selected world file.")}b.onerror=function(){rg2.utils.showWarningDialog("World file error","The selected world file could not be read.")},b.onload=function(a){var b,d;b=a.target.result,d=b.split(/[\r\n]+/g),delete c.localworldfile,c.localworldfile=new rg2.Worldfile(d[0],d[2],d[4],d[1],d[3],d[5]),$("#rg2-georef-selected").val(c.defaultGeorefVal),c.convertWorldFile(c.defaultGeorefVal)}},convertWorldFile:function(a){try{var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;if(c=rg2.getMapSize(),this.mapWidth=c.width,this.mapHeight=c.height,!this.localworldfile.valid||0===this.mapWidth||a===this.DO_NOT_GEOREF)return void this.clearGeorefs();for(b=1;b<this.georefsystems.length;b+=1)Proj4js.defs[this.georefsystems[b].name]=this.georefsystems[b].params;for(d=new Proj4js.Proj(a),e=new Proj4js.Proj("EPSG:4326"),f=this.localworldfile.A,i=this.localworldfile.D,h=this.localworldfile.B,g=this.localworldfile.E,j=[],k=[],l=[],m=[],j[0]=this.localworldfile.C,k[0]=this.localworldfile.F,l[0]=0,m[0]=0,l[1]=this.mapWidth,m[1]=this.mapHeight,j[1]=f*l[1]+h*m[1]+j[0],k[1]=g*m[1]+i*l[1]+k[0],l[2]=this.mapWidth,m[2]=0,j[2]=f*l[2]+h*m[2]+j[0],k[2]=g*m[2]+i*l[2]+k[0],this.newMap.xpx.length=0,this.newMap.ypx.length=0,this.newMap.lat.length=0,this.newMap.lon.length=0,n=[],b=0;3>b;b+=1)o={},o.x=parseInt(j[b]+.5,10),o.y=parseInt(k[b]+.5,10),n.push(o),Proj4js.transform(d,e,n[b]),this.newMap.xpx.push(l[b]),this.newMap.ypx.push(m[b]),this.newMap.lat.push(n[b].y),this.newMap.lon.push(n[b].x);p=rg2.utils.getLatLonDistance(n[0].y,n[0].x,n[2].y,n[2].x),q=rg2.utils.getLatLonDistance(n[0].y,n[0].x,n[0].y,n[2].x),r=Math.acos(q/p),p=rg2.utils.getLatLonDistance(n[2].y,n[2].x,n[1].y,n[1].x),q=rg2.utils.getLatLonDistance(n[2].y,n[2].x,n[1].y,n[2].x),s=Math.acos(q/p),t=(r+s)/2,u=(n[2].x-n[0].x)/this.mapWidth,v=(n[2].y-n[1].y)/this.mapHeight,delete this.newMap.worldfile,this.newMap.worldfile=new rg2.Worldfile(u*Math.cos(t),u*Math.sin(t),n[0].x,v*Math.sin(t),-1*v*Math.cos(t),n[0].y),this.updateGeorefDisplay()}catch(w){return delete this.newMap.worldfile,this.newMap.worldfile=new rg2.Worldfile(0,0,0,0,0,0),void this.updateGeorefDisplay()}},updateGeorefDisplay:function(){$("#georef-A").empty().text("A: "+this.newMap.worldfile.A),$("#georef-B").empty().text("B: "+this.newMap.worldfile.B),$("#georef-C").empty().text("C: "+this.newMap.worldfile.C),$("#georef-D").empty().text("D: "+this.newMap.worldfile.D),$("#georef-E").empty().text("E: "+this.newMap.worldfile.E),$("#georef-F").empty().text("F: "+this.newMap.worldfile.F)}},rg2.User=a,rg2.Manager=b}();