// Version 0.9.7 2014-11-24T12:27:44;
function User(a){this.x="",this.y=a,this.name=null,this.pwd=null}function Worldfile(a,b,c,d,e,f){this.A=parseFloat(a),this.B=parseFloat(b),this.C=parseFloat(c),this.D=parseFloat(d),this.E=parseFloat(e),this.F=parseFloat(f),0!==a&&0!==b&&0!==c&&0!==d&&0!==e&&0!==f?(this.valid=!0,this.AEDB=a*e-d*b,this.xCorrection=b*f-e*c,this.yCorrection=d*c-a*f):(this.valid=!1,this.AEDB=0,this.xCorrection=0,this.yCorrection=0)}function Georef(a,b,c){this.description=a,this.name=b,this.params=c}function Map(a){void 0!==a?(this.mapid=a.mapid,this.name=a.name,this.worldfile=new Worldfile(a.A,a.B,a.C,a.D,a.E,a.F),this.localworldfile=new Worldfile(a.localA,a.localB,a.localC,a.localD,a.localE,a.localF),this.mapfilename=void 0===a.mapfilename?this.mapid+".jpg":a.mapfilename):(this.mapid=0,this.name="",this.worldfile=new Worldfile(0,0,0,0,0,0),this.localworldfile=new Worldfile(0,0,0,0,0,0)),this.xpx=[],this.ypx=[],this.lat=[],this.lon=[]}function Manager(a){this.DO_NOT_SAVE_COURSE=9999,this.INVALID_MAP_ID=9999,this.FORMAT_NORMAL=1,this.FORMAT_NO_RESULTS=2,this.FORMAT_SCORE_EVENT=3,this.loggedIn=!1,this.user=new User(a),this.newMap=new Map,this.eventName=null,this.eventDate=null,this.eventLevel=null,this.mapIndex=this.INVALID_MAP_ID,this.club=null,this.comments=null,this.format=this.FORMAT_NORMAL,this.newcontrols=new Controls,this.courses=[],this.mapLoaded=!1,this.coursesGeoreferenced=!1,this.drawingCourses=!1,this.drawnCourse={},this.results=[],this.variants=[],this.resultCourses=[],this.mapWidth=0,this.mapHeight=0,this.mapFile=void 0,this.resultsFileFormat="",this.backgroundLocked=!1,this.handleX=null,this.handleY=null,this.maps=[],this.localworldfile=new Worldfile(0,0,0,0,0,0),this.HANDLE_DOT_RADIUS=10,this.handleColor="#ff0000",$("#btn-login").button(),this.georefsystems=[],this.DO_NOT_GEOREF="none",this.georefsystems.push(new Georef("Not georeferenced",this.DO_NOT_GEOREF,"")),this.georefsystems.push(new Georef("GB National Grid","EPSG:27700","+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs")),this.georefsystems.push(new Georef("Google EPSG:900913","EPSG:900913","+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs")),"undefined"!=typeof rg2Config.epsg_code?(this.georefsystems.push(new Georef(rg2Config.epsg_code,rg2Config.epsg_code.replace(" ",""),rg2Config.epsg_params)),this.defaultGeorefVal=rg2Config.epsg_code.replace(" ","")):this.defaultGeorefVal="EPSG:27700";var b=this;$("#rg2-manager-login-form").submit(function(){if(b.user.name=$("#rg2-user-name").val(),b.user.pwd=$("#rg2-password").val(),b.user.name.length>4&&b.user.pwd.length>4)b.logIn();else{var a="<div>Please enter user name and password of at least five characters.</div>";$(a).dialog({title:"Login failed"})}return!1}),$("#rg2-new-event-details-form").submit(function(){console.log("Form submitted")})}Worldfile.prototype={Constructor:Worldfile,getX:function(a,b){return Math.round((this.E*a-this.B*b+this.xCorrection)/this.AEDB)},getY:function(a,b){return Math.round((-1*this.D*a+this.A*b+this.yCorrection)/this.AEDB)}},Manager.prototype={Constructor:Manager,encodeUser:function(){var a={};return a.x=this.alterString(this.user.name+this.user.pwd,this.user.y),a.y=this.user.y,a},alterString:function(a,b){var c,d="";for(c=0;c<a.length;c+=1)d+=a.charAt(c)+b.charAt(c);return d},logIn:function(){var a=rg2Config.json_url+"?type=login",b=this.encodeUser(),c=JSON.stringify(b),d=this;return $.ajax({type:"POST",dataType:"json",data:c,url:a,cache:!1,success:function(a){if(d.user.y=a.keksi,a.ok)d.enableEventEdit();else{var b="<div>"+a.status_msg+". Login failed. Please try again.</div>";$(b).dialog({title:"Login failed"})}},error:function(a,b,c){console.log(c);var d="<div>User name or password incorrect. Please try again.</div>";$(d).dialog({title:"Login failed"})}}),!1},enableEventEdit:function(){this.loggedIn=!0;var a=this;this.getMaps(),this.createEventLevelDropdown("rg2-event-level"),$("#rg2-event-level").change(function(){a.eventLevel=$("#rg2-event-level").val(),"X"!==a.eventLevel?$("#rg2-select-event-level").addClass("valid"):$("#rg2-select-event-level").removeClass("valid")}),$("#rg2-map-selected").change(function(){a.mapIndex=parseInt($("#rg2-map-selected").val(),10),a.mapIndex!==a.INVALID_MAP_ID?($("#rg2-manager-map-select").addClass("valid"),rg2.loadNewMap(rg2Config.maps_url+"/"+a.maps[a.mapIndex].mapfilename)):($("#rg2-manager-map-select").removeClass("valid"),a.mapLoaded=!1,a.mapWidth=0,a.mapHeight=0)}),rg2.createEventEditDropdown(),$("#rg2-event-comments").focus(function(){var a=$("#rg2-event-comments").val();a===rg2.config.DEFAULT_EVENT_COMMENT&&$("#rg2-event-comments").val("")}),$("#rg2-event-date").datepicker({dateFormat:"yy-mm-dd",onSelect:function(b){a.setDate(b)}}),this.createEventLevelDropdown("rg2-event-level-edit"),this.createGeorefDropdown(),$("#rg2-event-date-edit").datepicker({dateFormat:"yy-mm-dd"}),$("#rg2-event-name").on("change",function(b){a.setEventName(b)}),$("#rg2-map-name").on("change",function(b){a.setMapName(b)}),$("#rg2-club-name").on("change",function(b){a.setClub(b)}),$("#rg2-load-map-file").button().change(function(b){a.readMapFile(b)}),$("#rg2-load-georef-file").button().change(function(b){a.readGeorefFile(b)}),$("#rg2-load-results-file").button().change(function(b){a.readResults(b)}),$("#rg2-load-course-file").button().change(function(b){a.readCourses(b)}),$("#btn-move-map-and-controls").click(function(b){a.toggleMoveAll(b.target.checked)}),$("#btn-no-results").click(function(b){a.toggleResultsRequired(b.target.checked)}),$("#rg2-draw-courses").hide(),$("#btn-draw-courses").button().click(function(){a.mapLoaded?(a.drawingCourses=!0,a.courses.length=0,a.newcontrols.deleteAllControls(),a.drawnCourse.name="Course",a.drawnCourse.x=[],a.drawnCourse.y=[],a.drawnCourse.codes=[],$("#rg2-new-course-name").val("Course"),$("#rg2-draw-courses").show()):rg2.showWarningDialog("No map selected","Please load a map before drawing courses")}),$("#rg2-new-course-name").on("change",function(b){a.setCourseName(b)}),$("#rg2-manager-event-select").change(function(){a.setEvent(parseInt($("#rg2-event-selected").val(),10))}),$("#rg2-georef-type").change(function(){a.setGeoref($("#rg2-georef-selected").val())}),$("#btn-create-event").button().click(function(){a.confirmCreateEvent()}).button("enable"),$("#btn-update-event").button().click(function(){a.confirmUpdateEvent()}).button("disable"),$("#btn-delete-course").button().click(function(){a.confirmDeleteCourse()}).button("disable"),$("#btn-delete-route").button().click(function(){a.confirmDeleteRoute()}).button("disable"),$("#btn-delete-event").button().click(function(){a.confirmDeleteEvent()}).button("disable"),$("#btn-add-map").button().click(function(){a.confirmAddMap()}).button("disable"),$("#rg2-temp-hide-course-delete").hide(),$("#rg2-results-grouping").hide(),$("#rg2-manage-create").show(),$("#rg2-create-tab").show(),$("#rg2-edit-tab").show(),$("#rg2-map-tab").show(),$("#rg2-manage-login").hide(),$("#rg2-login-tab").hide(),$("#rg2-info-panel").tabs("option","active",rg2.config.TAB_CREATE)},getMaps:function(){var a,b=this;$.getJSON(rg2Config.json_url,{type:"maps",cache:!1}).done(function(c){for(b.maps.length=0,console.log("Maps: "+c.data.length),a=0;a<c.data.length;a+=1)b.maps.push(new Map(c.data[a]));b.createMapDropdown(),$("#btn-toggle-controls").show()}).fail(function(a,b,c){$("body").css("cursor","auto");var d=b+", "+c;console.log("Map request failed: "+d)})},setGeoref:function(a){null!==a&&this.convertWorldFile(a)},setEvent:function(a){if(a){var b=rg2.getEventInfo(a);rg2.loadEvent(b.id)}else $("#btn-delete-event").button("disable"),$("#btn-update-event").button("disable"),$("#btn-delete-route").button("disable"),$("#btn-delete-course").button("disable"),$("#rg2-event-name-edit").val(""),$("#rg2-club-name-edit").val(""),$("#rg2-event-date-edit").val(""),$("#rg2-event-level-edit").val(""),$("#rg2-edit-event-comments").val(""),$("#rg2-route-selected").empty()},eventListLoaded:function(){rg2.createEventEditDropdown()},eventFinishedLoading:function(){var a=parseInt($("#rg2-event-selected").val(),10),b=rg2.getEventInfo(a);$("#rg2-event-name-edit").empty().val(b.name),$("#rg2-club-name-edit").empty().val(b.club),$("#rg2-event-date-edit").empty().val(b.date),$("#rg2-event-level-edit").val(b.rawtype),$("#rg2-edit-event-comments").empty().val(b.comment),$("#btn-delete-event").button("enable"),$("#btn-update-event").button("enable"),$("#btn-delete-route").button("enable"),$("#btn-delete-course").button("enable"),this.createCourseDeleteDropdown(b.id),this.createRouteDeleteDropdown(b.id)},createMapDropdown:function(){$("#rg2-map-selected").empty();var a,b,c=document.getElementById("rg2-map-selected");b=document.createElement("option"),b.value=this.INVALID_MAP_ID,b.text="Select map",c.options.add(b);var d=this.maps.length-1;for(a=d;a>-1;a-=1)b=document.createElement("option"),b.value=a,b.text=this.maps[a].mapid+": "+this.maps[a].name,c.options.add(b)},createGeorefDropdown:function(){$("#rg2-georef-selected").empty();var a,b,c=document.getElementById("rg2-georef-selected");for(b=0;b<this.georefsystems.length;b+=1)a=document.createElement("option"),a.value=this.georefsystems[b].name,a.text=this.georefsystems[b].description,c.options.add(a)},createCourseDeleteDropdown:function(a){$("#rg2-course-selected").empty();var b,c,d=document.getElementById("rg2-course-selected"),e=rg2.getCoursesForEvent(a);for(b=0;b<e.length;b+=1)c=document.createElement("option"),c.value=e[b].id,c.text=e[b].name,d.options.add(c)},createRouteDeleteDropdown:function(a){$("#rg2-route-selected").empty();var b,c,d=document.getElementById("rg2-route-selected"),e=rg2.getRoutesForEvent(a);for(b=0;b<e.length;b+=1)c=document.createElement("option"),c.value=e[b].resultid,c.text=e[b].resultid+": "+e[b].name+" on "+e[b].coursename,d.options.add(c)},getCoursesFromResults:function(){var a,b,c,d;for(this.resultCourses=[],a=0;a<this.results.length;a+=1){for(d=-1,b=0;b<this.resultCourses.length;b+=1)if(this.resultCourses[b].course===this.results[a].course){d=b;break}-1===d&&(c={},c.course=this.results[a].course,c.courseid=this.DO_NOT_SAVE_COURSE,this.resultCourses.push(c))}},displayCourseAllocations:function(){if(this.courses.length&&this.resultCourses.length){var a,b="<div id='rg2-course-allocations'><table><thead><tr><th>Course file</th><th>Results</th></tr></thead><tbody>";for(a=0;a<this.courses.length;a+=1)b+="<tr><td>"+this.courses[a].name+"</td><td>"+this.createCourseDropdown(this.courses[a].name,a)+"</td></tr>";b+="</tbody></table></div>",$("#rg2-course-allocations").empty().append(b)}},validateData:function(){return this.eventName?this.mapIndex===this.INVALID_MAP_ID?"No map selected.":this.club?this.eventDate?this.eventLevel?this.format?0!==this.courses.length||this.drawingCourses?0===this.results.length&&this.format!==this.FORMAT_NO_RESULTS?"No results information. Check your results file.":"OK":"No course information. Check your course XML file.":"Event format is not valid.":"Event level is not valid.":"Event date is not valid.":"Club name is not valid.":"Event name is not valid."},confirmCreateEvent:function(){var a=this.validateData();if("OK"!==a)return void rg2.showWarningDialog("Data missing",a+" Please enter all necessary information before creating the event.");var b="<div id='event-create-dialog'>Are you sure you want to create this event?</div>",c=this;$(b).dialog({title:"Confirm event creation",modal:!0,dialogClass:"no-close",closeOnEscape:!1,buttons:[{text:"Cancel",click:function(){c.doCancelCreateEvent()}},{text:"Create event",click:function(){c.doCreateEvent()}}]})},doCancelCreateEvent:function(){$("#event-create-dialog").dialog("destroy")},doCreateEvent:function(){$("#event-create-dialog").dialog("destroy");var a=($("#rg2-event-selected").val(),rg2Config.json_url+"?type=createevent"),b={};b.name=this.eventName,b.mapid=this.maps[this.mapIndex].mapid,b.eventdate=this.eventDate,b.club=this.club,b.format=this.format,$("#btn-score-event").prop("checked")&&(b.format=this.FORMAT_SCORE_EVENT),b.level=this.eventLevel,this.drawingCourses&&this.courses.push(this.drawnCourse),this.setControlLocations(),this.mapResultsToCourses(),this.renumberResults(),b.format===this.FORMAT_SCORE_EVENT&&(this.extractVariants(),b.variants=this.variants.slice(0)),b.courses=this.courses.slice(0),b.results=this.results.slice(0);var c=this.encodeUser();b.x=c.x,b.y=c.y;var d=JSON.stringify(b),e=this;$.ajax({data:d,type:"POST",url:a,dataType:"json",success:function(a){e.user.y=a.keksi,a.ok?rg2.showWarningDialog("Event created",e.eventName+" has been added with id "+a.newid+"."):rg2.showWarningDialog("Save failed",a.status_msg+". Failed to create event. Please try again.")},error:function(a,b){console.log(b)}})},renumberResults:function(){var a,b,c=[];for(a=0;a<this.results.length;a+=1)b=this.getCourseIDForResult(this.results[a].course),b!==this.DO_NOT_SAVE_COURSE&&(this.results[a].courseid=b,this.results[a].variantid="",c.push(this.results[a]));this.results=c},mapResultsToCourses:function(){var a,b,c,d=[],e=1;for(a=0;a<this.courses.length;a+=1)b="#rg2-alloc-"+a,c=parseInt($(b).val(),10),c!==this.DO_NOT_SAVE_COURSE&&(this.courses[a].courseid=e,this.resultCourses.length>0&&(this.resultCourses[c].courseid=e),d.push(this.courses[a]),e+=1);this.courses=d},extractVariants:function(){var a,b,c,d;for(this.variants.length=0,a=0;a<this.results.length;a+=1){for(c=this.results[a].codes,b=0;b<this.courses.length;b+=1)if(this.courses[b].courseid===this.results[a].courseid){d=this.courses[b];break}c.unshift(d.codes[0]),c.push(d.codes[d.codes.length-1]),this.results[a].variantid=this.getVariantID(this.results[a].codes,this.results[a].courseid)}},getVariantID:function(a,b){var c,d,e,f,g=[],h=[],i={},j=0;for(c=0;c<this.variants.length;c+=1)if(this.variants[c].codes.length===a.length){for(f=!0,d=0;d<a.length;d+=1)if(this.variants[c].codes[d]!==a[d]){f=!1;break}if(f){j=c+1;break}}if(0===j){for(j=this.variants.length+1,i.codes=a,c=0;c<a.length;c+=1)e=this.getControlXY(a[c]),g.push(e.x),h.push(e.y);i.x=g,i.y=h,i.id=j,i.courseid=b,i.name="Variant "+j,this.variants.push(i)}return j},getCourseIDForResult:function(a){var b;for(b=0;b<this.resultCourses.length;b+=1)if(this.resultCourses[b].course===a)return this.resultCourses[b].courseid;return 0},setControlLocations:function(){var a,b,c;for(a=0;a<this.courses.length;a+=1)for(b=0;b<this.courses[a].codes.length;b+=1)c=this.getControlXY(this.courses[a].codes[b]),this.courses[a].x[b]=c.x,this.courses[a].y[b]=c.y},getControlXY:function(a){var b,c={};for(c.x=0,c.y=0,b=0;b<this.newcontrols.controls.length;b+=1)if(this.newcontrols.controls[b].code===a)return c.x=Math.round(this.newcontrols.controls[b].x),c.y=Math.round(this.newcontrols.controls[b].y),c;return c},confirmUpdateEvent:function(){var a="<div id='event-update-dialog'>Are you sure you want to update this event?</div>",b=this;$(a).dialog({title:"Confirm event update",modal:!0,dialogClass:"no-close",closeOnEscape:!1,buttons:[{text:"Cancel",click:function(){b.doCancelUpdateEvent()}},{text:"Update event",click:function(){b.doUpdateEvent()}}]})},doCancelUpdateEvent:function(){$("#event-update-dialog").dialog("destroy")},doUpdateEvent:function(){$("#event-update-dialog").dialog("destroy");var a=$("#rg2-event-selected").val(),b=rg2Config.json_url+"?type=editevent&id="+a,c={};c.comments=$("#rg2-edit-event-comments").val(),c.name=$("#rg2-event-name-edit").val(),c.type=$("#rg2-event-level-edit").val(),c.eventdate=$("#rg2-event-date-edit").val(),c.club=$("#rg2-club-name-edit").val();var d=this.encodeUser();c.x=d.x,c.y=d.y;var e=JSON.stringify(c),f=this;$.ajax({data:e,type:"POST",url:b,dataType:"json",success:function(b){f.user.y=b.keksi,b.ok?rg2.showWarningDialog("Event updated","Event "+a+" has been updated."):rg2.showWarningDialog("Update failed",b.status_msg+". Event update failed. Please try again.")},error:function(a,b){console.log(b)}})},confirmDeleteCourse:function(){var a="<div id='course-delete-dialog'>This course will be permanently deleted. Are you sure?</div>",b=this;$(a).dialog({title:"Confirm course delete",modal:!0,dialogClass:"no-close",closeOnEscape:!1,buttons:[{text:"Cancel",click:function(){b.doCancelDeleteCourse()}},{text:"Delete course",click:function(){b.doDeleteCourse()}}]})},doCancelDeleteCourse:function(){$("#course-delete-dialog").dialog("destroy")},doDeleteCourse:function(){$("#course-delete-dialog").dialog("destroy");{var a=$("#rg2-event-selected").val(),b=$("#rg2-route-selected").val();rg2Config.json_url+"?type=deletecourse&id="+a+"&routeid="+b}},confirmDeleteRoute:function(){var a="<div id='route-delete-dialog'>This route will be permanently deleted. Are you sure?</div>",b=this;$(a).dialog({title:"Confirm route delete",modal:!0,dialogClass:"no-close",closeOnEscape:!1,buttons:[{text:"Cancel",click:function(){b.doCancelDeleteRoute()}},{text:"Delete route",click:function(){b.doDeleteRoute()}}]})},doCancelDeleteRoute:function(){$("#route-delete-dialog").dialog("destroy")},doDeleteRoute:function(){$("#route-delete-dialog").dialog("destroy");var a=$("#rg2-event-selected").val(),b=$("#rg2-route-selected").val(),c=rg2Config.json_url+"?type=deleteroute&id="+a+"&routeid="+b,d=this.encodeUser(),e=JSON.stringify(d),f=this;$.ajax({data:e,type:"POST",url:c,dataType:"json",success:function(a){f.user.y=a.keksi,a.ok?rg2.showWarningDialog("Route deleted","Route "+b+" has been deleted."):rg2.showWarningDialog("Delete failed",a.status_msg+". Delete failed. Please try again.")},error:function(a,b){console.log(b)}})},confirmDeleteEvent:function(){var a="<div id='event-delete-dialog'>This event will be deleted. Are you sure?</div>",b=this;$(a).dialog({title:"Confirm event delete",modal:!0,dialogClass:"no-close",closeOnEscape:!1,buttons:[{text:"Cancel",click:function(){b.doCancelDeleteEvent()}},{text:"Delete event",click:function(){b.doDeleteEvent()}}]})},doCancelDeleteEvent:function(){$("#event-delete-dialog").dialog("destroy")},doDeleteEvent:function(){$("#event-delete-dialog").dialog("destroy");var a=$("#rg2-event-selected").val(),b=rg2Config.json_url+"?type=deleteevent&id="+a,c=this.encodeUser(),d=JSON.stringify(c),e=this;$.ajax({data:d,type:"POST",url:b,dataType:"json",success:function(b){e.user.y=b.keksi,b.ok?(rg2.showWarningDialog("Event deleted","Event "+a+" has been deleted."),rg2.loadEventList(),e.setEvent(),$("#rg2-event-selected").empty()):rg2.showWarningDialog("Delete failed",b.status_msg+". Event delete failed. Please try again.")},error:function(a,b){console.log(b)}})},readResults:function(a){var b=new FileReader,c=this;b.onerror=function(a){switch(a.target.error.code){case a.target.error.NOT_FOUND_ERR:alert("File not found");break;case a.target.error.NOT_READABLE_ERR:alert("File not readable");break;default:alert("An error occurred reading the file.")}},b.onload=function(a){switch(c.results.length=0,c.resultsFileFormat){case"CSV":c.processResultsCSV(a),$("#rg2-select-results-file").addClass("valid");break;case"XML":c.processResultsXML(a),$("#rg2-select-results-file").addClass("valid");break;default:return void rg2.showWarningDialog("File type error","Results file type is not recognised. Please select a valid file.")}c.getCoursesFromResults(),c.displayCourseAllocations()};var d=a.target.files[0].name.substr(-3,3);d=d.toUpperCase(),"XML"===d||"CSV"===d?(this.resultsFileFormat=d,b.readAsText(a.target.files[0])):rg2.showWarningDialog("File type error","Results file type is not recognised. Please select a valid file.")},processResultsCSV:function(a){var b,c=(a.target.result,a.target.result.split(/[\r\n|\n]+/)),d=c[0].split(",").length-1,e=c[0].split(";").length-1;b=d>e?",":";",2===c[0].split(b).length?this.processSpklasseCSVResults(c,b):this.processSICSVResults(c,b)},processResultsXML:function(a){var b,c,d;c="";try{b=$.parseXML(a.target.result),d=b.getElementsByTagName("IOFVersion"),d.length>0&&(c=d[0].getAttribute("version")),""===c&&(d=b.getElementsByTagName("ResultList"),d.length>0&&(c=d[0].getAttribute("iofVersion")))}catch(e){return void rg2.showWarningDialog("XML file error","File is not a valid XML results file.")}switch(c){case"2.0.3":this.processIOFV2XMLResults(b);break;case"3.0":this.processIOFV3XMLResults(b);break;default:rg2.showWarningDialog("XML file error","Invalid IOF file format. Version "+c+" not supported.")}},processIOFV2XMLResults:function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;try{for(b=a.getElementsByTagName("ClassResult"),f=0;f<b.length;f+=1)for(k=b[f].getElementsByTagName("ClassShortName")[0].textContent,c=b[f].getElementsByTagName("PersonResult"),g=0;g<c.length;g+=1){for(j={},j.course=k,j.name=c[g].getElementsByTagName("Given")[0].textContent+" "+c[g].getElementsByTagName("Family")[0].textContent,m=c[g].getElementsByTagName("PersonId")[0].textContent,m.replace(/[\n\r]/g,""),j.dbid=m.trim()+"__"+j.name,j.club=c[g].getElementsByTagName("ShortName")[0].textContent,d=c[g].getElementsByTagName("Result"),h=0;h<d.length;h+=1){for(m=d[h].getElementsByTagName("CompetitorStatus"),n=m.length>0?m[0].getAttribute("value"):"",m=d[h].getElementsByTagName("CCardId"),j.chipid=m.length>0?m[0].textContent:0,m=d[h].getElementsByTagName("Time")[0].textContent,j.time=m.replace(/[\n\r]/g,""),m=d[h].getElementsByTagName("StartTime"),m.length>0?(l=m[0].getElementsByTagName("Clock")[0].textContent,j.starttime=rg2.getSecsFromHHMMSS(l)):j.starttime=0,j.splits="",j.codes=[],e=d[h].getElementsByTagName("SplitTime"),j.controls=e.length,i=0;i<e.length;i+=1)i>0&&(j.splits+=";"),m=e[i].getElementsByTagName("Time"),m.length>0?(j.splits+=(m[0].textContent.match(/:/g)||[]).length>1?rg2.getSecsFromHHMMSS(m[0].textContent):rg2.getSecsFromMMSS(m[0].textContent),m=e[i].getElementsByTagName("ControlCode"),j.codes[i]=m.length>0?m[0].textContent:""):(j.splits+=0,j.codes[i]="");j.splits+=";",m=d[h].getElementsByTagName("FinishTime"),m.length>0?(l=m[0].getElementsByTagName("Clock")[0].textContent,j.splits+=rg2.getSecsFromHHMMSS(l)-j.starttime):j.splits+=0}if("DidNotStart"===n)break;this.results.push(j)}}catch(o){return void rg2.showWarningDialog("XML parse error","Error processing XML file. Error is : "+o.message)}},processIOFV3XMLResults:function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;try{for(b=a.getElementsByTagName("ClassResult"),f=0;f<b.length;f+=1)for(m=b[f].getElementsByTagName("Class"),k=m[0].getElementsByTagName("Name")[0].textContent,c=b[f].getElementsByTagName("PersonResult"),g=0;g<c.length;g+=1){for(j={},j.course=k,j.name=c[g].getElementsByTagName("Given")[0].textContent+" "+c[g].getElementsByTagName("Family")[0].textContent,m=c[g].getElementsByTagName("Id"),m.length>0?(n=m[0].textContent,n.replace(/[\n\r]/g,""),j.dbid=n.trim()+"__"+j.name):j.dbid=this.results.length+"__"+j.name,m=c[g].getElementsByTagName("Organisation"),j.club=m.length>0?m[0].getElementsByTagName("Name")[0].textContent:"",d=c[g].getElementsByTagName("Result"),h=0;h<d.length;h+=1){for(m=d[h].getElementsByTagName("CCardId"),j.chipid=m.length>0?m[0].textContent:0,m=d[h].getElementsByTagName("Time"),j.time=m.length>0?rg2.formatSecsAsMMSS(parseInt(m[0].textContent,10)):0,m=d[h].getElementsByTagName("StartTime"),m.length>0?(n=m[0].textContent,j.starttime=n.length>=19?rg2.getSecsFromHHMMSS(n.substr(11,8)):0):j.starttime=0,j.splits="",j.codes=[],e=d[h].getElementsByTagName("SplitTime"),j.controls=e.length,i=0;i<e.length;i+=1)i>0&&(j.splits+=";"),m=e[i].getElementsByTagName("Time"),j.splits+=m.length>0?m[0].textContent:0,m=e[i].getElementsByTagName("ControlCode"),m.length>0?j.codes[i]=m[0].textContent:j.codes[i]+="X"+i;j.splits+=";",m=d[h].getElementsByTagName("FinishTime"),m.length>0?(n=m[0].textContent,l=n.length>=19?rg2.getSecsFromHHMMSS(n.substr(11,8)):0):l=0,j.splits+=l-j.starttime}this.results.push(j)}}catch(o){return void rg2.showWarningDialog("XML parse error","Error processing XML file. Error is : "+o.message)}},readCourses:function(a){var b=new FileReader;b.onerror=function(a){switch(a.target.error.code){case a.target.error.NOT_FOUND_ERR:rg2.showWarningDialog("File not found","The selected file could not be found.");break;case a.target.error.NOT_READABLE_ERR:rg2.showWarningDialog("File not readable","The selected file could not be read.");break;default:rg2.showWarningDialog("File error.","The selected file could not be read.")}};var c=this;b.onload=function(a){c.courses.length=0,c.coursesGeoreferenced=!1,c.backgroundLocked=!1,$("#btn-move-map-and-controls").prop("checked",!1),c.handleX=null,c.handleY=null,c.newcontrols.deleteAllControls(),c.processCoursesXML(a),c.displayCourseAllocations(),c.fitControlsToMap(),rg2.redraw(!1)},b.readAsText(a.target.files[0])},processCoursesXML:function(a){var b,c,d;c="";try{b=$.parseXML(a.target.result),d=b.getElementsByTagName("IOFVersion"),d.length>0&&(c=d[0].getAttribute("version")),""===c&&(d=b.getElementsByTagName("CourseData"),d.length>0&&(c=d[0].getAttribute("iofVersion")))}catch(e){return void rg2.showWarningDialog("XML file error","File is not a valid XML event file.")}switch(c){case"2.0.3":this.processIOFV2XML(b);break;case"3.0":this.processIOFV3XML(b);break;default:rg2.showWarningDialog("XML file error","Invalid IOF file format. Version "+c+" not supported.")}},extractV2Courses:function(a){var b,c,d,e,f,g,h,i;for(b=0;b<a.length;b+=1){for(d={},e=[],f=[],g=[],d.name=a[b].getElementsByTagName("CourseName")[0].textContent,i=a[b].getElementsByTagName("StartPointCode")[0].textContent,e.push(i.trim()),h=a[b].getElementsByTagName("CourseControl"),c=0;c<h.length;c+=1)i=h[c].getElementsByTagName("ControlCode")[0].textContent,this.validControlCode(i)&&e.push(i.trim());i=a[b].getElementsByTagName("FinishPointCode")[0].textContent,e.push(i.trim()),d.codes=e,d.courseid=0,d.x=f,d.y=g,this.courses.push(d)}$("#rg2-select-course-file").addClass("valid")},validControlCode:function(a){var b,c=this.newcontrols.controls;for(b=0;b<c.length;b+=1)if(c[b].code===a)return!0;return!1},extractV3Courses:function(a){var b,c,d,e,f,g,h,i;for(b=0;b<a.length;b+=1){for(d={},e=[],f=[],g=[],d.name=a[b].getElementsByTagName("Name")[0].textContent,h=a[b].getElementsByTagName("CourseControl"),c=0;c<h.length;c+=1)i=h[c].getElementsByTagName("Control")[0].textContent,this.validControlCode(i)&&e.push(i.trim());d.codes=e,d.courseid=0,d.x=f,d.y=g,this.courses.push(d)}$("#rg2-select-course-file").addClass("valid")},processIOFV3XML:function(a){var b,c,d,e,f,g;b=a.getElementsByTagName("Control");var h,i,j;for(c=0;c<b.length;c+=1)"RaceCourseData"===b[c].parentNode.nodeName&&(d=b[c].getElementsByTagName("Id")[0].textContent,h=b[c].getElementsByTagName("Position"),this.localworldfile.valid&&h.length>0?(i=h[0].getAttribute("lat"),j=h[0].getAttribute("lng"),f=this.localworldfile.getX(j,i),g=this.localworldfile.getY(j,i),this.coursesGeoreferenced=!0):(e=b[c].getElementsByTagName("MapPosition"),f=e[0].getAttribute("x"),g=e[0].getAttribute("y")),"CrossingPoint"!==b[c].getAttribute("type")&&this.newcontrols.addControl(d.trim(),f,g));b=a.getElementsByTagName("Course"),this.extractV3Courses(b)},processIOFV2XML:function(a){var b,c,d,e,f;if(b=a.getElementsByTagName("StartPoint"),this.extractV2Controls(b,"StartPointCode"),b=a.getElementsByTagName("Control"),this.extractV2Controls(b,"ControlCode"),b=a.getElementsByTagName("FinishPoint"),c=this.extractV2Controls(b,"FinishPointCode"),c&&this.localworldfile.valid){for(d=0;d<this.newcontrols.controls.length;d+=1)e=this.newcontrols.controls[d].x,f=this.newcontrols.controls[d].y,this.newcontrols.controls[d].x=this.localworldfile.getX(e,f),this.newcontrols.controls[d].y=this.localworldfile.getY(e,f);this.coursesGeoreferenced=!0}b=a.getElementsByTagName("Course"),this.extractV2Courses(b)},extractV2Controls:function(a,b){var c,d,e,f,g,h,i=!1;for(c=0;c<a.length;c+=1)f=a[c].getElementsByTagName(b)[0].textContent,h=a[c].getElementsByTagName("ControlPosition"),h.length>0&&this.localworldfile.valid?(d=parseFloat(h[0].getAttribute("x")),e=parseFloat(h[0].getAttribute("y")),i=!0):(g=a[c].getElementsByTagName("MapPosition"),d=g[0].getAttribute("x"),e=g[0].getAttribute("y")),this.newcontrols.addControl(f.trim(),d,e);return i},processSpklasseCSVResults:function(a,b){var c,d,e,f,g,h,i,j=0,k=1,l=0,m=1,n=2,o=3,p=4,q=[];try{for(c="",d=0,e=0;e<a.length;e+=1)if(q=a[e].split(b),0!==q.length)if(2!==q.length){for(g={},g.chipid=0,g.name=(q[l]+" "+q[m]+" "+q[n]).trim(),g.dbid=g.chipid+"__"+g.name,g.starttime=rg2.getSecsFromHHMM(q[o]),g.club=q[n],g.course=c,g.controls=d,g.splits="",g.codes=[],h=q.length-p,i=0,f=0;h>f;f+=1)f>0&&(g.splits+=";"),g.codes[f]="X",i+=rg2.getSecsFromMMSS(q[f+p]),g.splits+=i;g.time=rg2.formatSecsAsMMSS(i),this.results.push(g)}else c=q[j],d=parseInt(q[k],10)}catch(r){rg2.showWarningDialog("Spklasse csv file contains invalid information")}},processSICSVResults:function(a,b){var c,d,e,f,g,h=1,i=2,j=3,k=4,l=9,m=11,n=15,o=15,p=39,q=42,r=47,s=2,t=46,u=2,v={};for(c=0;c<a.length;c+=1)v[c]=a[c].split(b);for(c=1;c<a.length;c+=1)if(v[c].length>=r){for(e={},e.chipid=v[c][h],e.name=(v[c][k]+" "+v[c][j]).trim().replace(/\"/g,""),e.dbid=(v[c][i]+"__"+e.name).replace(/\"/g,""),e.starttime=rg2.getSecsFromHHMMSS(v[c][l]),e.time=v[c][m],e.club=v[c][n],e.club||(e.club=v[c][o]),e.course=v[c][p],e.controls=parseInt(v[c][q],10),f=r,g=t,e.splits="",e.codes=[],d=0;d<e.controls;d+=1)d>0&&(e.splits+=";"),v[c][g]&&(e.codes[d]=v[c][g],e.splits+=rg2.getSecsFromMMSS(v[c][f])),f+=s,g+=u;e.splits+=";",e.splits+=rg2.getSecsFromMMSS(e.time),this.results.push(e)}},readMapFile:function(a){var b,c=new FileReader,d=this;c.onload=function(a){d.processMap(a)},b=a.target.files[0].name.substr(-3,3),b=b.toUpperCase(),"JPG"===b||"GIF"===b?(this.mapFile=a.target.files[0],c.readAsDataURL(a.target.files[0])):rg2.showWarningDialog("File type error",a.target.files[0].name+" is not recognised. Only .jpg and .gif files are supported at present.")},mapLoadCallback:function(){this.mapLoaded=!0,this.mapIndex!==this.INVALID_MAP_ID&&(this.localworldfile=this.maps[this.mapIndex].localworldfile);var a=rg2.getMapSize();this.mapWidth=a.width,this.mapHeight=a.height,this.fitControlsToMap(),rg2.redraw(!1)},processMap:function(a){rg2.loadNewMap(a.target.result),$("#rg2-select-map-file").addClass("valid"),this.mapLoaded=!0;var b=rg2.getMapSize();this.mapWidth=b.width,this.mapHeight=b.height,this.fitControlsToMap(),rg2.redraw(!1),$("#btn-add-map").button("enable")},fitControlsToMap:function(){var a,b=!1;if(this.mapLoaded&&this.newcontrols.controls.length>0){if(this.coursesGeoreferenced)if(0>e||d>this.mapWidth||f>this.mapHeight||0>g){var c="<div id='GPS-problem-dialog'>Your course file does not match the map co-ordinates. Please check you have selected the correct file.</div>";$(c).dialog({title:"Course file problem"})}else b=!0;if(b)this.backgroundLocked=!0,$("#btn-move-map-and-controls").prop("checked",!0);else{var d=this.newcontrols.controls[0].x,e=this.newcontrols.controls[0].x,f=this.newcontrols.controls[0].y,g=this.newcontrols.controls[0].y;for(a=1;a<this.newcontrols.controls.length;a+=1)e=Math.max(e,this.newcontrols.controls[a].x),g=Math.max(g,this.newcontrols.controls[a].y),d=Math.min(d,this.newcontrols.controls[a].x),f=Math.min(f,this.newcontrols.controls[a].y);var h=.8,i=e-d,j=g-f;for(a=0;a<this.newcontrols.controls.length;a+=1)this.newcontrols.controls[a].x=(this.newcontrols.controls[a].x-d)*(this.mapWidth/i)*h+this.mapWidth*(1-h)*.5,this.newcontrols.controls[a].y=this.mapHeight-(this.newcontrols.controls[a].y-f)*(this.mapHeight/j)*h-this.mapHeight*(1-h)*.5}for(a=0;a<this.newcontrols.controls.length;a+=1)this.newcontrols.controls[a].oldX=this.newcontrols.controls[a].x,this.newcontrols.controls[a].oldY=this.newcontrols.controls[a].y;this.newcontrols.displayAllControls()}},setClub:function(){this.club=$("#rg2-club-name").val(),this.club?$("#rg2-select-club-name").addClass("valid"):$("#rg2-select-club-name").removeClass("valid")},setEventName:function(){this.eventName=$("#rg2-event-name").val(),this.eventName?$("#rg2-select-event-name").addClass("valid"):$("#rg2-select-event-name").removeClass("valid")},setCourseName:function(){var a=$("#rg2-new-course-name").val();
a&&(this.drawnCourse.name=a)},setMapName:function(){this.newMap.name=$("#rg2-map-name").val(),this.newMap.name?$("#rg2-select-map-name").addClass("valid"):$("#rg2-select-map-name").removeClass("valid")},setDate:function(a){this.eventDate=a,this.eventDate?$("#rg2-select-event-date").addClass("valid"):$("#rg2-select-event-date").removeClass("valid")},createEventLevelDropdown:function(a){$("#"+a).empty();var b,c,d=document.getElementById(a),e=["Select level","Training","Local","Regional","National","International"],f=["X","T","L","R","N","I"];for(c=0;c<e.length;c+=1)b=document.createElement("option"),b.value=f[c],b.text=e[c],d.options.add(b)},createCourseDropdown:function(a,b){var c,d=-1;for(c=0;c<this.resultCourses.length;c+=1)if(this.resultCourses[c].course===a){d=c;break}var e="<select id='rg2-alloc-"+b+"'><option value="+this.DO_NOT_SAVE_COURSE;for(-1===d&&(e+=" selected"),e+=">Do not save</option>",c=0;c<this.resultCourses.length;c+=1)e+="<option value="+c,d===c&&(e+=" selected"),e+=">"+this.resultCourses[c].course+"</option>";return e+="</select>"},drawControls:function(){if(this.mapLoaded&&this.newcontrols.controls.length>0){this.newcontrols.drawControls(!0);var a=rg2.getOverprintDetails();null!==this.handleX&&(rg2.ctx.lineWidth=a.overprintWidth,rg2.ctx.strokeStyle=this.handleColor,rg2.ctx.fillStyle=this.handleColour,rg2.ctx.globalAlpha=1,rg2.ctx.beginPath(),rg2.ctx.arc(this.handleX,this.handleY,this.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),rg2.ctx.fill(),rg2.ctx.beginPath(),rg2.ctx.arc(this.handleX,this.handleY,2*this.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),rg2.ctx.stroke())}},adjustControls:function(a,b,c,d,e){var f,g,h,i,j;if(this.backgroundLocked||e===rg2.config.RIGHT_CLICK)rg2.ctx.translate(c-a,d-b);else if(null!==this.handleX){var k=(c-this.handleX)/(a-this.handleX),l=(d-this.handleY)/(b-this.handleY);for(f=0;f<this.newcontrols.controls.length;f+=1)g=this.newcontrols.controls[f].oldX-this.handleX,h=this.newcontrols.controls[f].oldY-this.handleY,this.newcontrols.controls[f].x=g*k+this.handleX,this.newcontrols.controls[f].y=h*l+this.handleY}else for(i=c-a,j=d-b,f=0;f<this.newcontrols.controls.length;f+=1)this.newcontrols.controls[f].x=this.newcontrols.controls[f].oldX+i,this.newcontrols.controls[f].y=this.newcontrols.controls[f].oldY+j},dragEnded:function(){var a;if(this.mapLoaded&&this.newcontrols.controls.length>0)for(a=0;a<this.newcontrols.controls.length;a+=1)this.newcontrols.controls[a].oldX=this.newcontrols.controls[a].x,this.newcontrols.controls[a].oldY=this.newcontrols.controls[a].y},mouseUp:function(a,b){return this.drawingCourses?void this.addNewControl(a,b):void(this.mapLoaded&&this.newcontrols.controls.length>0&&(null===this.handleX?(this.handleX=a,this.handleY=b):(this.handleX=null,this.handleY=null)))},addNewControl:function(a,b){var c;c=0===this.newcontrols.controls.length?"S"+(this.newcontrols.controls.length+1):"X"+(this.newcontrols.controls.length+1),this.newcontrols.addControl(c,a,b),this.newcontrols.displayAllControls(),this.drawnCourse.codes.push(c),this.drawnCourse.x.push(a),this.drawnCourse.y.push(b)},toggleMoveAll:function(a){this.backgroundLocked=a},toggleResultsRequired:function(a){this.format=a?this.FORMAT_NO_RESULTS:this.FORMAT_NORMAL},confirmAddMap:function(){var a="<div id='add-map-dialog'>Are you sure you want to add this map?</div>",b=this;$(a).dialog({title:"Confirm new map",modal:!0,dialogClass:"no-close",closeOnEscape:!1,buttons:[{text:"Cancel",click:function(){b.doCancelAddMap()}},{text:"Add map",click:function(){b.doUploadMapFile()}}]})},doCancelAddMap:function(){$("#add-map-dialog").dialog("destroy")},doUploadMapFile:function(){$("#add-map-dialog").dialog("destroy");var a=rg2Config.json_url+"?type=uploadmapfile",b=this.encodeUser(),c=this,d=new FormData;d.append(this.mapFile.name,this.mapFile),d.append("name",this.mapFile.name),d.append("x",b.x),d.append("y",b.y),$.ajax({url:a,data:d,type:"POST",mimeType:"multipart/form-data",processData:!1,contentType:!1,dataType:"json",success:function(a){c.user.y=a.keksi,a.ok?c.doAddMap():rg2.showWarningDialog("Save failed",a.status_msg+". Failed to save map. Please try again.")},error:function(a,b){console.log(b)}})},doAddMap:function(){var a=rg2Config.json_url+"?type=addmap",b={};this.newMap.localworldfile=this.localworldfile,b=this.newMap;var c=this.encodeUser();b.x=c.x,b.y=c.y;var d=JSON.stringify(b),e=this;$.ajax({data:d,type:"POST",url:a,dataType:"json",success:function(a){e.user.y=a.keksi,a.ok?(rg2.showWarningDialog("Map added",e.newMap.name+" has been added with id "+a.newid+"."),e.getMaps()):rg2.showWarningDialog("Save failed",a.status_msg+". Failed to save map. Please try again.")},error:function(a,b){console.log(b)}})},readGeorefFile:function(a){var b=new FileReader,c=this;try{b.readAsText(a.target.files[0])}catch(d){return void rg2.showWarningDialog("File read error","Failed to open selected world file.")}b.onerror=function(a){switch(a.target.error.code){case a.target.error.NOT_FOUND_ERR:console.log("File not found");break;case a.target.error.NOT_READABLE_ERR:console.log("File not readable");break;default:console.log("An error occurred reading the file.")}},b.onload=function(a){var b=a.target.result,d=b.split(/[\r\n]+/g);delete c.localworldfile,c.localworldfile=new Worldfile(d[0],d[2],d[4],d[1],d[3],d[5]),$("#rg2-georef-selected").val(c.defaultGeorefVal),c.convertWorldFile(c.defaultGeorefVal)}},convertWorldFile:function(a){try{var b=rg2.getMapSize();if(this.mapWidth=b.width,this.mapHeight=b.height,!this.localworldfile.valid||0===this.mapWidth||a===this.DO_NOT_GEOREF)return void this.clearGeorefs();for(m=1;m<this.georefsystems.length;m+=1)Proj4js.defs[this.georefsystems[m].name]=this.georefsystems[m].params;var c;c=new Proj4js.Proj(a);var d=new Proj4js.Proj("EPSG:4326"),e=this.localworldfile.A,f=this.localworldfile.D,g=this.localworldfile.B,h=this.localworldfile.E,i=[],j=[],k=[],l=[];i[0]=this.localworldfile.C,j[0]=this.localworldfile.F,k[0]=0,l[0]=0,k[1]=this.mapWidth,l[1]=this.mapHeight,i[1]=e*k[1]+g*l[1]+i[0],j[1]=h*l[1]+f*k[1]+j[0],k[2]=this.mapWidth,l[2]=0,i[2]=e*k[2]+g*l[2]+i[0],j[2]=h*l[2]+f*k[2]+j[0],this.newMap.xpx.length=0,this.newMap.ypx.length=0,this.newMap.lat.length=0,this.newMap.lon.length=0;var m,n,o=[];for(m=0;3>m;m+=1)n={},n.x=parseInt(i[m]+.5,10),n.y=parseInt(j[m]+.5,10),o.push(n),Proj4js.transform(c,d,o[m]),this.newMap.xpx.push(k[m]),this.newMap.ypx.push(l[m]),this.newMap.lat.push(o[m].y),this.newMap.lon.push(o[m].x);var p=rg2.getLatLonDistance(o[0].y,o[0].x,o[2].y,o[2].x),q=rg2.getLatLonDistance(o[0].y,o[0].x,o[0].y,o[2].x),r=Math.acos(q/p),s=rg2.getLatLonDistance(o[2].y,o[2].x,o[1].y,o[1].x),t=rg2.getLatLonDistance(o[2].y,o[2].x,o[1].y,o[2].x),u=Math.acos(t/s),v=(r+u)/2,w=(o[2].x-o[0].x)/this.mapWidth,x=(o[2].y-o[1].y)/this.mapHeight;delete this.newMap.worldfile,this.newMap.worldfile=new Worldfile(w*Math.cos(v),w*Math.sin(v),o[0].x,x*Math.sin(v),-1*x*Math.cos(v),o[0].y),this.updateGeorefDisplay()}catch(y){return delete this.newMap.worldfile,this.newMap.worldfile=new Worldfile(0,0,0,0,0,0),void this.updateGeorefDisplay()}},updateGeorefDisplay:function(){$("#georef-A").empty().text("A: "+this.newMap.worldfile.A),$("#georef-B").empty().text("B: "+this.newMap.worldfile.B),$("#georef-C").empty().text("C: "+this.newMap.worldfile.C),$("#georef-D").empty().text("D: "+this.newMap.worldfile.D),$("#georef-E").empty().text("E: "+this.newMap.worldfile.E),$("#georef-F").empty().text("F: "+this.newMap.worldfile.F)}};