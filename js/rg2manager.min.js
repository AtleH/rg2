// Version 0.5.12 2014-03-06T13:58:59;
function User(a){this.x="",this.y=a,this.name=null,this.pwd=null}function Map(a){void 0!==a?(this.mapid=a.mapid,this.name=a.name,this.georeferenced=a.georeferenced,this.A=a.A,this.B=a.B,this.C=a.C,this.D=a.D,this.E=a.E,this.F=a.F):(this.mapid=0,this.name="",this.georeferenced=!1,this.A=0,this.B=0,this.C=0,this.D=0,this.E=0,this.F=0)}function Manager(a){this.DO_NOT_GEOREF=0,this.UK_NATIONAL_GRID=1,this.FORMAT_NORMAL=1,this.FORMAT_NO_RESULTS=2,this.FORMAT_SCORE=3,this.loggedIn=!1,this.user=new User(a),this.newMap=new Map,this.eventName=null,this.eventDate=null,this.eventLevel=null,this.mapID=0,this.club=null,this.comments=null,this.format=this.FORMAT_NORMAL,this.newcontrols=new Controls,this.xmlcourses=[],this.mapLoaded=!1,this.results=[],this.resultCourses=[],this.allocationsDisplayed=!1,this.mapWidth=0,this.mapHeight=0,this.mapFile=void 0,this.backgroundLocked=!1,this.handleX=null,this.handleY=null,this.maps=[],this.worldfileArgs=[],this.HANDLE_DOT_RADIUS=10,this.handleColor="#ff0000",$("#btn-login").button();var b=this;$("#rg2-manager-login-form").submit(function(){if(b.user.name=$("#rg2-user-name").val(),b.user.pwd=$("#rg2-password").val(),b.user.name.length>4&&b.user.pwd.length>4)b.logIn();else{var a="<div>Please enter user name and password of at least five characters.</div>";$(a).dialog({title:"Login failed"})}return!1}),$("#rg2-new-event-details-form").submit(function(){console.log("Form submitted")})}Manager.prototype={Constructor:Manager,encodeUser:function(){var a={};return a.x=this.alterString(this.user.name+this.user.pwd,this.user.y),a.y=this.user.y,a},alterString:function(a,b){var c,d="";for(c=0;c<a.length;c+=1)d+=a.charAt(c)+b.charAt(c);return d},logIn:function(){var a=json_url+"?type=login",b=this.encodeUser(),c=JSON.stringify(b),d=this;return $.ajax({type:"POST",dataType:"json",data:c,url:a,cache:!1,success:function(a){if(d.user.y=a.keksi,a.ok)d.enableEventEdit();else{var b="<div>"+a.status_msg+". Login failed. Please try again.</div>";$(b).dialog({title:"Login failed"})}},error:function(a,b,c){console.log(c);var d="<div>User name or password incorrect. Please try again.</div>";$(d).dialog({title:"Login failed"})}}),!1},enableEventEdit:function(){this.loggedIn=!0;var a=this;this.getMaps(),this.createEventLevelDropdown("rg2-event-level"),$("#rg2-event-level").click(function(){a.eventLevel=$("#rg2-event-level").val(),"X"!==a.eventLevel?$("#rg2-select-event-level").addClass("valid"):$("#rg2-select-event-level").removeClass("valid")}),$("#rg2-map-selected").click(function(){a.mapID=parseInt($("#rg2-map-selected").val(),10),a.mapID?($("#rg2-manager-map-select").addClass("valid"),rg2.loadNewMap(maps_url+"/"+a.mapID+".jpg")):($("#rg2-manager-map-select").removeClass("valid"),a.mapLoaded=!1,a.mapWidth=0,a.mapHeight=0)}),rg2.createEventEditDropdown(),$("#rg2-event-comments").focus(function(){var a=$("#rg2-event-comments").val();a===rg2.config.DEFAULT_EVENT_COMMENT&&$("#rg2-event-comments").val("")}),$("#rg2-event-date").datepicker({dateFormat:"yy-mm-dd",onSelect:function(b){a.setDate(b)}}),this.createEventLevelDropdown("rg2-event-level-edit"),this.createGeorefDropdown(),$("#rg2-event-date-edit").datepicker({dateFormat:"yy-mm-dd"}),$("#rg2-event-name").on("change",function(b){a.setEventName(b)}),$("#rg2-map-name").on("change",function(b){a.setMapName(b)}),$("#rg2-club-name").on("change",function(b){a.setClub(b)}),$("#rg2-load-map-file").button().change(function(b){a.readMapFile(b)}),$("#rg2-load-georef-file").button().change(function(b){a.readGeorefFile(b)}),$("#rg2-load-results-file").button().change(function(b){a.readResults(b)}),$("#rg2-load-course-file").button().change(function(b){a.readCourses(b)}),$("#btn-move-map-and-controls").click(function(b){a.toggleMoveAll(b.target.checked)}),$("#rg2-manager-event-select").click(function(){a.setEvent(parseInt($("#rg2-event-selected").val(),10))}),$("#rg2-georef-type").click(function(){a.setGeoref($("#rg2-georef-selected").val())}),$("#btn-create-event").button().click(function(){a.confirmCreateEvent()}).button("enable"),$("#btn-update-event").button().click(function(){a.confirmUpdateEvent()}).button("disable"),$("#btn-delete-course").button().click(function(){a.confirmDeleteCourse()}).button("disable"),$("#btn-delete-route").button().click(function(){a.confirmDeleteRoute()}).button("disable"),$("#btn-delete-event").button().click(function(){a.confirmDeleteEvent()}).button("disable"),$("#btn-add-map").button().click(function(){a.confirmAddMap()}).button("disable"),$("#rg2-temp-hide-course-delete").hide(),$("#rg2-results-grouping").hide(),$("#rg2-manage-create").show(),$("#rg2-create-tab").show(),$("#rg2-edit-tab").show(),$("#rg2-map-tab").show(),$("#rg2-manage-login").hide(),$("#rg2-login-tab").hide(),$("#rg2-info-panel").tabs("option","active",rg2.config.TAB_CREATE)},getMaps:function(){var a,b=this;$.getJSON(json_url,{type:"maps",cache:!1}).done(function(c){for(b.maps.length=0,console.log("Maps: "+c.data.length),a=0;a<c.data.length;a+=1)b.maps.push(new Map(c.data[a]));b.createMapDropdown(),$("#btn-toggle-controls").show()}).fail(function(a,b,c){$("body").css("cursor","auto");var d=b+", "+c;console.log("Map request failed: "+d)})},setGeoref:function(){this.convertWorldFile(parseInt($("#rg2-georef-selected").val(),10))},setEvent:function(a){if(a){var b=rg2.getEventInfo(a);rg2.loadEvent(b.id)}else $("#btn-delete-event").button("disable"),$("#btn-update-event").button("disable"),$("#btn-delete-route").button("disable"),$("#btn-delete-course").button("disable"),$("#rg2-event-name-edit").val(""),$("#rg2-club-name-edit").val(""),$("#rg2-event-date-edit").val(""),$("#rg2-event-level-edit").val(""),$("#rg2-edit-event-comments").val(""),$("#rg2-route-selected").empty()},eventListLoaded:function(){rg2.createEventEditDropdown()},eventFinishedLoading:function(){var a=parseInt($("#rg2-event-selected").val(),10),b=rg2.getEventInfo(a);$("#rg2-event-name-edit").empty().val(b.name),$("#rg2-club-name-edit").empty().val(b.club),$("#rg2-event-date-edit").empty().val(b.date),$("#rg2-event-level-edit").val(b.rawtype),$("#rg2-edit-event-comments").empty().val(b.comment),$("#btn-delete-event").button("enable"),$("#btn-update-event").button("enable"),$("#btn-delete-route").button("enable"),$("#btn-delete-course").button("enable"),this.createCourseDeleteDropdown(b.id),this.createRouteDeleteDropdown(b.id)},createMapDropdown:function(){$("#rg2-map-selected").empty();var a,b,c=document.getElementById("rg2-map-selected");b=document.createElement("option"),b.value=0,b.text="Select map",c.options.add(b);var d=this.maps.length-1;for(a=d;a>-1;a-=1)b=document.createElement("option"),b.value=this.maps[a].mapid,b.text=this.maps[a].mapid+": "+this.maps[a].name,c.options.add(b)},createGeorefDropdown:function(){$("#rg2-georef-selected").empty();var a,b,c=document.getElementById("rg2-georef-selected"),d=["Not georeferenced","GB National Grid"];for(b=0;b<d.length;b+=1)a=document.createElement("option"),a.value=b,a.text=d[b],c.options.add(a)},createCourseDeleteDropdown:function(a){$("#rg2-course-selected").empty();var b,c,d=document.getElementById("rg2-course-selected"),e=rg2.getCoursesForEvent(a);for(b=0;b<e.length;b+=1)c=document.createElement("option"),c.value=e[b].id,c.text=e[b].name,d.options.add(c)},createRouteDeleteDropdown:function(a){$("#rg2-route-selected").empty();var b,c,d=document.getElementById("rg2-route-selected"),e=rg2.getRoutesForEvent(a);for(b=0;b<e.length;b+=1)c=document.createElement("option"),c.value=e[b].resultid,c.text=e[b].resultid+": "+e[b].name+" on "+e[b].coursename,d.options.add(c)},getCoursesFromResults:function(){var a;for(this.resultCourses=[],a=0;a<this.results.length;a+=1)-1===this.resultCourses.indexOf(this.results[a].course)&&this.resultCourses.push(this.results[a].course)},displayCourseAllocations:function(){if(this.xmlcourses.length&&this.resultCourses&&!this.allocationsDisplayed){var a,b="<table><thead><tr><th>Results file</th><th>Course name</th></tr></thead><tbody>";for(a=0;a<this.xmlcourses.length;a+=1)b+="<tr><td>"+this.xmlcourses[a].name+"</td><td>"+this.createCourseDropdown(this.xmlcourses[a].name)+"</td></tr>";b+="</tbody></table>",$("#rg2-course-allocations").empty().append(b),this.allocationsDisplayed=!0}},validData:function(){return this.eventName&&this.mapID&&this.eventDate&&this.club&&this.eventLevel&&this.format&&this.xmlcourses?!0:!1},confirmCreateEvent:function(){if(!this.validData())return rg2WarningDialog("Data missing","Please enter all necessary information before creating the event."),void 0;var a="<div id='event-create-dialog'>Are you sure you want to create this event?</div>",b=this;$(a).dialog({title:"Confirm event creation",modal:!0,dialogClass:"no-close",closeOnEscape:!1,buttons:[{text:"Cancel",click:function(){b.doCancelCreateEvent()}},{text:"Create event",click:function(){b.doCreateEvent()}}]})},doCancelCreateEvent:function(){$("#event-create-dialog").dialog("destroy")},doCreateEvent:function(){$("#event-create-dialog").dialog("destroy");var a=($("#rg2-event-selected").val(),json_url+"?type=createevent"),b={};b.name=this.eventName,b.mapid=this.mapID,b.eventdate=this.eventDate,b.club=this.club,b.format=this.format,b.level=this.eventLevel,this.setControlLocations(),this.mapResultsToCourses(),b.courses=this.xmlcourses.slice(0),b.results=this.results.slice(0);var c=this.encodeUser();b.x=c.x,b.y=c.y;var d=JSON.stringify(b),e=this;$.ajax({data:d,type:"POST",url:a,dataType:"json",success:function(a){e.user.y=a.keksi,a.ok?rg2WarningDialog("Event created",e.eventName+" has been added with id "+a.newid+"."):rg2WarningDialog("Save failed",a.status_msg+". Failed to create event. Please try again.")},error:function(a,b){console.log(b)}})},mapResultsToCourses:function(){var a;for(a=0;a<this.results.length;a+=1)this.results[a].courseid=this.getCourseIDForCourseName(this.results[a].course)},getCourseIDForCourseName:function(a){var b;for(b=0;b<this.xmlcourses.length;b+=1)if(this.xmlcourses[b].name===a)return this.xmlcourses[b].courseid;return 0},setControlLocations:function(){var a,b,c;for(a=0;a<this.xmlcourses.length;a+=1)for(b=0;b<this.xmlcourses[a].codes.length;b+=1)c=this.getControlXY(this.xmlcourses[a].codes[b]),this.xmlcourses[a].x[b]=c.x,this.xmlcourses[a].y[b]=c.y},getControlXY:function(a){var b,c={};for(c.x=0,c.y=0,b=0;b<this.newcontrols.controls.length;b+=1)if(this.newcontrols.controls[b].code===a)return c.x=Math.round(this.newcontrols.controls[b].x),c.y=Math.round(this.newcontrols.controls[b].y),c;return c},confirmUpdateEvent:function(){var a="<div id='event-update-dialog'>Are you sure you want to update this event?</div>",b=this;$(a).dialog({title:"Confirm event update",modal:!0,dialogClass:"no-close",closeOnEscape:!1,buttons:[{text:"Cancel",click:function(){b.doCancelUpdateEvent()}},{text:"Update event",click:function(){b.doUpdateEvent()}}]})},doCancelUpdateEvent:function(){$("#event-update-dialog").dialog("destroy")},doUpdateEvent:function(){$("#event-update-dialog").dialog("destroy");var a=$("#rg2-event-selected").val(),b=json_url+"?type=editevent&id="+a,c={};c.comments=$("#rg2-edit-event-comments").val(),c.name=$("#rg2-event-name-edit").val(),c.type=$("#rg2-event-level-edit").val(),c.eventdate=$("#rg2-event-date-edit").val(),c.club=$("#rg2-club-name-edit").val();var d=this.encodeUser();c.x=d.x,c.y=d.y;var e=JSON.stringify(c),f=this;$.ajax({data:e,type:"POST",url:b,dataType:"json",success:function(b){f.user.y=b.keksi,b.ok?rg2WarningDialog("Event updated","Event "+a+" has been updated."):rg2WarningDialog("Update failed",b.status_msg+". Event update failed. Please try again.")},error:function(a,b){console.log(b)}})},confirmDeleteCourse:function(){var a="<div id='course-delete-dialog'>This course will be permanently deleted. Are you sure?</div>",b=this;$(a).dialog({title:"Confirm course delete",modal:!0,dialogClass:"no-close",closeOnEscape:!1,buttons:[{text:"Cancel",click:function(){b.doCancelDeleteCourse()}},{text:"Delete course",click:function(){b.doDeleteCourse()}}]})},doCancelDeleteCourse:function(){$("#course-delete-dialog").dialog("destroy")},doDeleteCourse:function(){$("#course-delete-dialog").dialog("destroy");$("#rg2-event-selected").val(),$("#rg2-route-selected").val()},confirmDeleteRoute:function(){var a="<div id='route-delete-dialog'>This route will be permanently deleted. Are you sure?</div>",b=this;$(a).dialog({title:"Confirm route delete",modal:!0,dialogClass:"no-close",closeOnEscape:!1,buttons:[{text:"Cancel",click:function(){b.doCancelDeleteRoute()}},{text:"Delete route",click:function(){b.doDeleteRoute()}}]})},doCancelDeleteRoute:function(){$("#route-delete-dialog").dialog("destroy")},doDeleteRoute:function(){$("#route-delete-dialog").dialog("destroy");var a=$("#rg2-event-selected").val(),b=$("#rg2-route-selected").val(),c=json_url+"?type=deleteroute&id="+a+"&routeid="+b,d=this.encodeUser(),e=JSON.stringify(d),f=this;$.ajax({data:e,type:"POST",url:c,dataType:"json",success:function(a){f.user.y=a.keksi,a.ok?rg2WarningDialog("Route deleted","Route "+b+" has been deleted."):rg2WarningDialog("Delete failed",a.status_msg+". Delete failed. Please try again.")},error:function(a,b){console.log(b)}})},confirmDeleteEvent:function(){var a="<div id='event-delete-dialog'>This event will be deleted. Are you sure?</div>",b=this;$(a).dialog({title:"Confirm event delete",modal:!0,dialogClass:"no-close",closeOnEscape:!1,buttons:[{text:"Cancel",click:function(){b.doCancelDeleteEvent()}},{text:"Delete event",click:function(){b.doDeleteEvent()}}]})},doCancelDeleteEvent:function(){$("#event-delete-dialog").dialog("destroy")},doDeleteEvent:function(){$("#event-delete-dialog").dialog("destroy");var a=$("#rg2-event-selected").val(),b=json_url+"?type=deleteevent&id="+a,c=this.encodeUser(),d=JSON.stringify(c),e=this;$.ajax({data:d,type:"POST",url:b,dataType:"json",success:function(b){e.user.y=b.keksi,b.ok?(rg2WarningDialog("Event deleted","Event "+a+" has been deleted."),rg2.loadEventList(),e.setEvent(),$("#rg2-event-selected").empty()):rg2WarningDialog("Delete failed",b.status_msg+". Event delete failed. Please try again.")},error:function(a,b){console.log(b)}})},readResults:function(a){var b=new FileReader,c=this;b.onerror=function(a){switch(a.target.error.code){case a.target.error.NOT_FOUND_ERR:alert("File not found");break;case a.target.error.NOT_READABLE_ERR:alert("File not readable");break;default:alert("An error occurred reading the file.")}},b.onload=function(a){var b=(a.target.result,a.target.result.split(/[\r\n|\n]+/));c.processSICSVResults(b),$("#rg2-select-results-file").addClass("valid")},b.readAsText(a.target.files[0])},readCourses:function(a){var b=new FileReader;b.onerror=function(a){switch(a.target.error.code){case a.target.error.NOT_FOUND_ERR:alert("File not found");break;case a.target.error.NOT_READABLE_ERR:alert("File not readable");break;default:alert("An error occurred reading the file.")}};var c=this;b.onload=function(a){c.processIOFXML(a),c.displayCourseAllocations(),c.fitControlsToMap(),rg2.redraw(!1)},b.readAsText(a.target.files[0])},processIOFXML:function(a){var b,c,d;return b=$.parseXML(a.target.result),c=b.getElementsByTagName("IOFVersion")[0].getAttribute("version"),"2.0.3"!==c?(alert("Invalid IOF file format. Version "+c+" not supported."),void 0):(d=b.getElementsByTagName("StartPoint"),this.extractControls(d),d=b.getElementsByTagName("Control"),this.extractControls(d),d=b.getElementsByTagName("FinishPoint"),this.extractControls(d),d=b.getElementsByTagName("Course"),this.extractCourses(d),void 0)},processSICSVResults:function(a){var b,c,d,e,f=1,g=2,h=3,i=9,j=11,k=15,l=15,m=39,n=42,o=47,p=4,q=2,r={};for(b=0;b<a.length;b+=1)r[b]=a[b].split(";");for(b=1;b<a.length;b+=1)if(r[b].length>=o){for(d={},d.chipid=r[b][f],d.name=(r[b][p]+" "+r[b][h]).trim(),d.dbid=r[b][g]+"__"+d.name,d.starttime=this.convertHHMMSSToSecs(r[b][i]),d.time=r[b][j],d.club=r[b][k],d.club||(d.club=r[b][l]),d.course=r[b][m],d.controls=parseInt(r[b][n],10),e=o,d.splits="",c=0;c<d.controls;c+=1)c>0&&(d.splits+=";"),d.splits+=this.convertMMSSToSecs(r[b][e]),e+=q;d.splits+=";",d.splits+=this.convertMMSSToSecs(d.time),this.results.push(d)}this.getCoursesFromResults(),this.displayCourseAllocations()},convertMMSSToSecs:function(a){if(a){var b=a.split(":"),c=60*parseInt(b[0],0),d=parseInt(b[1],0);return c+d}return 0},convertHHMMSSToSecs:function(a){if(a){var b=3600*parseInt(a.substr(0,2),0),c=60*parseInt(a.substr(3,2),0),d=parseInt(a.substr(6,2),0);return b+c+d}return 0},extractControls:function(a){var b,c,d,e;for(b=0;b<a.length;b+=1)e=a[b].children[0].textContent,c=a[b].children[1].getAttribute("x"),d=a[b].children[1].getAttribute("y"),this.newcontrols.addControl(e.trim(),c,d)},extractCourses:function(a){var b,c,d,e,f,g,h,i;for(b=0;b<a.length;b+=1){for(d={},e=[],f=[],g=[],d.name=a[b].getElementsByTagName("CourseName")[0].textContent,i=a[b].getElementsByTagName("StartPointCode")[0].textContent,e.push(i.trim()),h=a[b].getElementsByTagName("CourseControl"),c=0;c<h.length;c+=1)i=h[c].children[1].textContent,e.push(i.trim());i=a[b].getElementsByTagName("FinishPointCode")[0].textContent,e.push(i.trim()),d.codes=e,d.courseid=b+1,d.x=f,d.y=g,this.xmlcourses.push(d)}$("#rg2-select-course-file").addClass("valid")},readMapFile:function(a){var b=new FileReader,c=this;b.onload=function(a){c.processMap(a)},this.mapFile=a.target.files[0],b.readAsDataURL(a.target.files[0])},mapLoadCallback:function(){this.mapLoaded=!0,this.fitControlsToMap(),rg2.redraw(!1)},processMap:function(a){rg2.loadNewMap(a.target.result),$("#rg2-select-map-file").addClass("valid"),this.mapLoaded=!0,this.fitControlsToMap(),rg2.redraw(!1),$("#btn-add-map").button("enable")},fitControlsToMap:function(){var a;if(this.mapLoaded&&this.newcontrols.controls.length>0){var b=rg2.getMapSize();this.mapWidth=b.width,this.mapHeight=b.height;var c=this.newcontrols.controls[0].x,d=this.newcontrols.controls[0].x,e=this.newcontrols.controls[0].y,f=this.newcontrols.controls[0].y;for(a=1;a<this.newcontrols.controls.length;a+=1)d=Math.max(d,this.newcontrols.controls[a].x),f=Math.max(f,this.newcontrols.controls[a].y),c=Math.min(c,this.newcontrols.controls[a].x),e=Math.min(e,this.newcontrols.controls[a].y);var g=1.25,h=g*(d-c),i=g*(f-e);for(c*=g,e*=g,a=0;a<this.newcontrols.controls.length;a+=1)this.newcontrols.controls[a].x=(this.newcontrols.controls[a].x-c)*(this.mapWidth/h),this.newcontrols.controls[a].y=this.mapHeight-(this.newcontrols.controls[a].y-e)*(this.mapHeight/i),this.newcontrols.controls[a].oldX=this.newcontrols.controls[a].x,this.newcontrols.controls[a].oldY=this.newcontrols.controls[a].y;this.newcontrols.displayAllControls()}},setClub:function(){this.club=$("#rg2-club-name").val(),this.club?$("#rg2-select-club-name").addClass("valid"):$("#rg2-select-club-name").removeClass("valid")},setEventName:function(){this.eventName=$("#rg2-event-name").val(),this.eventName?$("#rg2-select-event-name").addClass("valid"):$("#rg2-select-event-name").removeClass("valid")},setMapName:function(){this.newMap.name=$("#rg2-map-name").val(),this.newMap.name?$("#rg2-select-map-name").addClass("valid"):$("#rg2-select-map-name").removeClass("valid")},setDate:function(a){this.eventDate=a,this.eventDate?$("#rg2-select-event-date").addClass("valid"):$("#rg2-select-event-date").removeClass("valid")},createEventLevelDropdown:function(a){$("#"+a).empty();var b,c,d=document.getElementById(a),e=["Select level","Training","Local","Regional","National","International"],f=["X","T","L","R","N","I"];for(c=0;c<e.length;c+=1)b=document.createElement("option"),b.value=f[c],b.text=e[c],d.options.add(b)},createCourseDropdown:function(a){var b,c=this.resultCourses.indexOf(a),d="<select name='a'><option value=999";for(-1===c&&(d+=" selected"),d+=">Skip this class</option>",b=0;b<this.resultCourses.length;b+=1)d+="<option value="+b,c===b&&(d+=" selected"),d+=">"+this.resultCourses[b]+"</option>";return d+="</select>"},drawControls:function(){this.mapLoaded&&this.newcontrols.controls.length>0&&(this.newcontrols.drawControls(),null!==this.handleX&&(rg2.ctx.lineWidth=rg2.getOverprintWidth(),rg2.ctx.strokeStyle=this.handleColor,rg2.ctx.fillStyle=this.handleColour,rg2.ctx.globalAlpha=1,rg2.ctx.beginPath(),rg2.ctx.arc(this.handleX,this.handleY,this.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),rg2.ctx.fill(),rg2.ctx.beginPath(),rg2.ctx.arc(this.handleX,this.handleY,2*this.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),rg2.ctx.stroke()))},adjustControls:function(a,b,c,d,e){var f,g,h,i,j;if(this.backgroundLocked||e===rg2.config.RIGHT_CLICK)rg2.ctx.translate(c-a,d-b);else if(null!==this.handleX){var k=(c-this.handleX)/(a-this.handleX),l=(d-this.handleY)/(b-this.handleY);for(f=0;f<this.newcontrols.controls.length;f+=1)g=this.newcontrols.controls[f].oldX-this.handleX,h=this.newcontrols.controls[f].oldY-this.handleY,this.newcontrols.controls[f].x=g*k+this.handleX,this.newcontrols.controls[f].y=h*l+this.handleY}else for(i=c-a,j=d-b,f=0;f<this.newcontrols.controls.length;f+=1)this.newcontrols.controls[f].x=this.newcontrols.controls[f].oldX+i,this.newcontrols.controls[f].y=this.newcontrols.controls[f].oldY+j},dragEnded:function(){var a;if(this.mapLoaded&&this.newcontrols.controls.length>0)for(a=0;a<this.newcontrols.controls.length;a+=1)this.newcontrols.controls[a].oldX=this.newcontrols.controls[a].x,this.newcontrols.controls[a].oldY=this.newcontrols.controls[a].y},mouseUp:function(a,b){this.mapLoaded&&this.newcontrols.controls.length>0&&(null===this.handleX?(this.handleX=a,this.handleY=b):(this.handleX=null,this.handleY=null))},toggleMoveAll:function(a){this.backgroundLocked=a},confirmAddMap:function(){var a="<div id='add-map-dialog'>Are you sure you want to add this map?</div>",b=this;$(a).dialog({title:"Confirm new map",modal:!0,dialogClass:"no-close",closeOnEscape:!1,buttons:[{text:"Cancel",click:function(){b.doCancelAddMap()}},{text:"Add map",click:function(){b.doUploadMapFile()}}]})},doCancelAddMap:function(){$("#add-map-dialog").dialog("destroy")},doUploadMapFile:function(){$("#add-map-dialog").dialog("destroy");var a=json_url+"?type=uploadmapfile",b=this.encodeUser(),c=this,d=new FormData;d.append(this.mapFile.name,this.mapFile),d.append("name",this.mapFile.name),d.append("x",b.x),d.append("y",b.y),$.ajax({url:a,data:d,type:"POST",mimeType:"multipart/form-data",processData:!1,contentType:!1,dataType:"json",success:function(a){c.user.y=a.keksi,a.ok?c.doAddMap():rg2WarningDialog("Save failed",a.status_msg+". Failed to save map. Please try again.")},error:function(a,b){console.log(b)}})},doAddMap:function(){var a=json_url+"?type=addmap",b={};b=this.newMap;var c=this.encodeUser();b.x=c.x,b.y=c.y;var d=JSON.stringify(b),e=this;$.ajax({data:d,type:"POST",url:a,dataType:"json",success:function(a){e.user.y=a.keksi,a.ok?(rg2WarningDialog("Map added",e.newMap.name+" has been added with id "+a.newid+"."),e.getMaps()):rg2WarningDialog("Save failed",a.status_msg+". Failed to save map. Please try again.")},error:function(a,b){console.log(b)}})},readGeorefFile:function(a){var b=new FileReader,c=this;try{b.readAsText(a.target.files[0])}catch(d){return rg2WarningDialog("File read error","Failed to open selected file."),void 0}b.onerror=function(a){switch(a.target.error.code){case a.target.error.NOT_FOUND_ERR:console.log("File not found");break;case a.target.error.NOT_READABLE_ERR:console.log("File not readable");break;default:console.log("An error occurred reading the file.")}},b.onload=function(a){var b,d=a.target.result,e=d.split(/[\r\n]+/g);for(b=0;6>b;b+=1)c.worldfileArgs[b]=parseFloat(e[b]);c.convertWorldFile(c.UK_NATIONAL_GRID)}},convertWorldFile:function(a){var b=rg2.getMapSize();if(this.mapWidth=b.width,this.mapHeight=b.height,0!==this.worldfileArgs.length&&0!==this.mapWidth){Proj4js.defs["EPSG:27700"]="+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs ";var c;switch(a){case this.UK_NATIONAL_GRID:c=new Proj4js.Proj("EPSG:27700");break;case this.DO_NOT_GEOREF:return this.clearGeorefs(),void 0;default:return}var d=new Proj4js.Proj("EPSG:4326"),e=this.worldfileArgs[0],f=this.worldfileArgs[1],g=this.worldfileArgs[2],h=this.worldfileArgs[3],i=[],j=[],k=[],l=[];i[0]=this.worldfileArgs[4],j[0]=this.worldfileArgs[5],k[0]=0,l[0]=0,k[1]=this.mapWidth,l[1]=this.mapHeight,i[1]=e*k[1]+g*l[1]+i[0],j[1]=h*l[1]+f*k[1]+j[0],k[2]=this.mapWidth,l[2]=0,i[2]=e*k[2]+g*l[2]+i[0],j[2]=h*l[2]+f*k[2]+j[0],k[3]=0,l[3]=this.mapHeight,i[3]=e*k[3]+g*l[3]+i[0],j[3]=h*l[3]+f*k[3]+j[0];var m,n,o=[];for(m=0;4>m;m+=1)n={},n.x=parseInt(i[m]+.5,10),n.y=parseInt(j[m]+.5,10),o.push(n),Proj4js.transform(c,d,o[m]);var p=getLatLonDistance(o[0].y,o[0].x,o[2].y,o[2].x),q=getLatLonDistance(o[0].y,o[0].x,o[0].y,o[2].x),r=Math.acos(q/p),s=getLatLonDistance(o[2].y,o[2].x,o[1].y,o[1].x),t=getLatLonDistance(o[2].y,o[2].x,o[1].y,o[2].x),u=Math.acos(t/s),v=(r+u)/2,w=(o[2].x-o[0].x)/this.mapWidth,x=(o[2].y-o[1].y)/this.mapHeight;this.newMap.A=w*Math.cos(v),this.newMap.D=x*Math.sin(v),this.newMap.B=w*Math.sin(v),this.newMap.E=-1*x*Math.cos(v),this.newMap.C=o[0].x,this.newMap.F=o[0].y,$("#georef-A").empty().text("A: "+this.newMap.A),$("#georef-B").empty().text("B: "+this.newMap.B),$("#georef-C").empty().text("C: "+this.newMap.C),$("#georef-D").empty().text("D: "+this.newMap.D),$("#georef-E").empty().text("E: "+this.newMap.E),$("#georef-F").empty().text("F: "+this.newMap.F),$("#rg2-georef-selected").val(a),this.newMap.georeferenced=!0}},clearGeorefs:function(){this.newMap.A=0,this.newMap.D=0,this.newMap.B=0,this.newMap.E=0,this.newMap.C=0,this.newMap.F=0,$("#georef-A").empty().text("A: 0"),$("#georef-B").empty().text("B: 0"),$("#georef-C").empty().text("C: 0"),$("#georef-D").empty().text("D: 0"),$("#georef-E").empty().text("E: 0"),$("#georef-F").empty().text("F: 0"),this.newMap.georeferenced=!1}};